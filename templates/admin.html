<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Concierge Lifestyle</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.socket.io/4.5.1/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
</head>
<body data-user-id="admin">
    <!-- Hamburger Menu for Mobile -->
    <div class="hamburger" onclick="toggleSidebar()">‚ò∞</div>
    
    <div class="dashboard-container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <h2 class="logo">Admin Panel</h2>
            <ul>
                <li><a href="javascript:void(0)" onclick="showSection('users-section'); setActive(this)" class="active">üë• Users</a></li>
                <li><a href="javascript:void(0)" onclick="showSection('requests-section'); setActive(this)">üìã Requests</a></li>
                <li><a href="javascript:void(0)" onclick="showSection('tickets-section'); setActive(this)">üé´ Ticket Generator</a></li>
                <li><a href="javascript:void(0)" onclick="showSection('reports-section'); setActive(this)">üìÑ Report Generator</a></li>
                <li><a href="javascript:void(0)" onclick="showSection('analytics-section'); setActive(this)">üìä Analytics</a></li>
                <li><a href="javascript:void(0)" onclick="showSection('broadcast-section'); setActive(this)">
                    <i class="material-icons">campaign</i> Broadcast Alert
                </a></li>
                <li><a href="javascript:void(0)" onclick="showSection('chat-section'); setActive(this)">
                    <i class="material-icons">chat</i> Support Chat
                </a></li>
                <li><a href="javascript:void(0)" onclick="confirmLogout()">üîì Logout</a></li>
            </ul>
        </div>

        <!-- Main Content -->
        <div class="main">
            <!-- Chat Section -->
            <div id="chat-section" class="main-content-section">
                <div class="section-header">
                    <h2><i class="material-icons">chat</i> Support Chat</h2>
                    <p>Chat with users in real-time</p>
                </div>

                <div class="chat-container-wrapper">
                    <div class="chat-layout">
                        <!-- Left Sidebar - Users List -->
                        <div class="chat-sidebar">
                            <div class="sidebar-header">
                                <h3><i class="material-icons">group</i> Support Users</h3>
                                <div class="online-status">
                                    <span class="status-dot"></span>
                                    <span class="online-count" id="online-count">0 online</span>
                                </div>
                                <div class="search-chat">
                                    <i class="material-icons">search</i>
                                    <input type="text" id="chat-search" placeholder="Search users..." oninput="searchSupportUsers()">
                                </div>
                            </div>

                            <div class="chat-users-list" id="support-users-list">
                                <div class="empty-state">
                                    <i class="material-icons">group</i>
                                    <p>Loading users...</p>
                                </div>
                            </div>
                        </div>

                        <!-- Right Side - Chat Window -->
                        <div class="chat-main">
                            <!-- Default empty state -->
                            <div class="empty-chat" id="no-user-selected">
                                <i class="material-icons">chat_bubble_outline</i>
                                <h3>Welcome to Support Chat</h3>
                                <p>Select a user from the list to start chatting</p>
                            </div>

                            <!-- Active Chat Container -->
                            <div class="chat-container" id="chat-container" style="display: none;">
                                <!-- Chat Header -->
                                <div class="chat-header">
                                    <div class="chat-user-info">
                                        <div class="user-avatar">
                                            <div class="avatar-img">
                                                <img id="current-user-img" src="" alt="User" onerror="this.src='https://ui-avatars.com/api/?name=User&size=50&background=d4af37&color=fff'">
                                            </div>
                                        </div>
                                        <div>
                                            <h4 id="current-user-name">User Name</h4>
                                            <div class="user-status-text">
                                                <span id="user-status">Online</span>
                                                <span class="typing-indicator" id="typing-indicator" style="display: none;">typing...</span>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="chat-actions">
                                        <button class="action-btn" title="Clear Chat" onclick="clearChatWithUser()">
                                            <i class="material-icons">delete_sweep</i>
                                        </button>
                                        <button class="action-btn" title="Send Report" onclick="sendQuickReport()">
                                            <i class="material-icons">description</i>
                                        </button>
                                        <button class="action-btn" title="Call User" onclick="callUser()">
                                            <i class="material-icons">phone</i>
                                        </button>
                                    </div>
                                </div>

                                <!-- Chat Messages -->
                                <div class="chat-messages" id="chat-messages">
                                    <div class="empty-state">
                                        <p>No messages yet. Start the conversation!</p>
                                    </div>
                                </div>

                                <!-- Chat Input -->
                                <div class="chat-input-container">
                                    <div class="input-wrapper">
                                        <div class="attachment-options">
                                            <button class="attachment-btn" title="Upload Image" onclick="openAdminFileInput('image')">
                                                <i class="material-icons">image</i>
                                            </button>
                                            <button class="attachment-btn" title="Upload File" onclick="openAdminFileInput('file')">
                                                <i class="material-icons">attach_file</i>
                                            </button>
                                        </div>

                                        <div class="message-input">
                                            <textarea id="admin-chat-input" placeholder="Type a message..." rows="1"
                                                oninput="autoResizeTextarea(this)" onkeydown="handleAdminChatKeydown(event)"></textarea>

                                            <div class="input-actions">
                                                <button class="emoji-btn" title="Emoji" onclick="toggleEmojiPicker()">
                                                    <i class="material-icons">mood</i>
                                                </button>
                                                <button class="send-btn" onclick="sendAdminSupportMessage()" title="Send">
                                                    <i class="material-icons">send</i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Users Section -->
            <div id="users-section" class="main-content-section active">
                <div class="section-header">
                    <h2>User Management</h2>
                    <p>Manage all registered users in real-time</p>
                </div>
                
                <div class="card-container">
                    <div class="stats-card">
                        <div class="stat-icon">üë•</div>
                        <div class="stat-info">
                            <h3 id="total-users">{{ users|length }}</h3>
                            <p>Total Users</p>
                        </div>
                    </div>
                    <div class="stats-card">
                        <div class="stat-icon">üìã</div>
                        <div class="stat-info">
                            <h3 id="total-user-requests">{{ requests|length }}</h3>
                            <p>Total Requests</p>
                        </div>
                    </div>
                    <div class="stats-card">
                        <div class="stat-icon">üÜï</div>
                        <div class="stat-info">
                            <h3 id="new-users-today">{{ analytics.new_users_today if analytics else 0 }}</h3>
                            <p>New Today</p>
                        </div>
                    </div>
                    <div class="stats-card">
                        <div class="stat-icon">üü¢</div>
                        <div class="stat-info">
                            <h3 id="active-users-today">{{ active_users_count if active_users_count else 0 }}</h3>
                            <p>Active Today</p>
                        </div>
                    </div>
                </div>

                <!-- Search and Filter -->
                <div class="admin-toolbar">
                    <div class="search-box">
                        <input type="text" id="user-search" placeholder="Search users...">
                        <span class="material-icons">search</span>
                    </div>
                    <div class="filter-dropdown">
                        <select id="user-filter">
                            <option value="all">All Users</option>
                            <option value="with-requests">With Requests</option>
                            <option value="no-requests">No Requests</option>
                            <option value="active-today">Active Today</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="refreshUsers()">
                        <i class="material-icons">refresh</i> Refresh
                    </button>
                </div>

                <!-- User Cards Container -->
                <div class="user-cards-container" id="user-cards-container">
                    {% for user in users %}
                    <div class="user-card" data-user-id="{{ user[0] }}" onclick="showUserDetails({{ user[0] }})">
                        <div class="user-card-header">
                            <div class="user-card-id">#{{ user[0] }}</div>
                            <div class="user-card-avatar">{{ user[1][0] if user[1] else 'U' }}</div>
                            <div class="user-status-indicator" id="status-{{ user[0] }}"></div>
                        </div>
                        <div class="user-card-info">
                            <div class="user-card-field">
                                <span class="user-card-label">Name:</span>
                                <span class="user-card-value">{{ user[1] }}</span>
                            </div>
                            <div class="user-card-field">
                                <span class="user-card-label">Email:</span>
                                <span class="user-card-value">{{ user[2] }}</span>
                            </div>
                            <div class="user-card-field">
                                <span class="user-card-label">Username:</span>
                                <span class="user-card-value">{{ user[3] }}</span>
                            </div>
                            <div class="user-card-field">
                                <span class="user-card-label">Requests:</span>
                                <span class="user-card-value" id="user-{{ user[0] }}-request-count">Loading...</span>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Requests Section -->
            <div id="requests-section" class="main-content-section">
                <div class="section-header">
                    <h2>Service Requests</h2>
                    <p>Manage and monitor all service requests in real-time</p>
                </div>
                
                <div class="card-container">
                    <div class="stats-card">
                        <div class="stat-icon">üìã</div>
                        <div class="stat-info">
                            <h3 id="total-requests">{{ requests|length }}</h3>
                            <p>Total Requests</p>
                        </div>
                    </div>
                    <div class="stats-card">
                        <div class="stat-icon">‚è≥</div>
                        <div class="stat-info">
                            <h3 id="pending-requests">{{ requests|selectattr('5', 'equalto', 'Pending')|list|length }}</h3>
                            <p>Pending Payment</p>
                        </div>
                    </div>
                    <div class="stats-card">
                        <div class="stat-icon">‚úÖ</div>
                        <div class="stat-info">
                            <h3 id="confirmed-requests">{{ requests|selectattr('6', 'equalto', 'Confirmed')|list|length }}</h3>
                            <p>Confirmed</p>
                        </div>
                    </div>
                    <div class="stats-card">
                        <div class="stat-icon">üîÑ</div>
                        <div class="stat-info">
                            <h3 id="active-requests">{{ analytics.active_requests_today if analytics else 0 }}</h3>
                            <p>Active Today</p>
                        </div>
                    </div>
                </div>

                <!-- Request Filters -->
                <div class="admin-toolbar">
                    <div class="filter-group">
                        <select id="status-filter">
                            <option value="all">All Statuses</option>
                            <option value="pending">Pending Payment</option>
                            <option value="confirmed">Confirmed Payment</option>
                        </select>
                        <select id="admin-status-filter">
                            <option value="all">All Admin Status</option>
                            <option value="pending">Pending</option>
                            <option value="confirmed">Confirmed</option>
                        </select>
                        <select id="service-filter">
                            <option value="all">All Services</option>
                            <option value="hotel">Hotel Booking</option>
                            <option value="flight">Flight Booking</option>
                            <option value="car">Car Booking</option>
                            <option value="technician">Technician</option>
                            <option value="courier">Courier</option>
                        </select>
                        <select id="date-filter">
                            <option value="all">All Time</option>
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                        </select>
                    </div>
                    <div class="search-box">
                        <input type="text" id="request-search" placeholder="Search requests...">
                        <span class="material-icons">search</span>
                    </div>
                    <button class="btn btn-primary" onclick="refreshRequests()">
                        <i class="material-icons">refresh</i> Refresh
                    </button>
                </div>

                <div class="table-container">
                    <table class="table table-dark table-striped" id="requests-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>User</th>
                                <th>Booking ID</th>
                                <th>Service Type</th>
                                <th>Details</th>
                                <th>Payment Status</th>
                                <th>Admin Confirmation</th>
                                <th>Created At</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="requests-body">
                            {% for req in requests %}
                            <tr data-request-id="{{ req[0] }}" data-service-type="{{ req[3]|lower }}"
                                data-payment-status="{{ req[5]|lower }}" data-admin-status="{{ req[6]|lower }}">
                                <td>{{ req[0] }}</td>
                                <td>{{ req[1] }}</td>
                                <td>{{ req[2] }}</td>
                                <td>
                                    <span class="service-badge service-{{ req[3]|lower|replace(' ', '-') }}">
                                        {{ req[3] }}
                                    </span>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-info view-details"
                                        data-details='{{ req[4] if req[4] is string else req[4]|tojson }}' data-service-type="{{ req[3] }}"
                                        onclick="showRequestDetails(this)">
                                        View Details
                                    </button>
                                </td>
                                <td>
                                    <span class="status-badge status-{{ req[5]|lower }}">
                                        {{ req[5] }}
                                    </span>
                                </td>
                                <td>
                                    <span class="status-badge status-{{ req[6]|lower }}">
                                        {{ req[6] }}
                                    </span>
                                </td>
                                <td>{{ req[7].strftime('%Y-%m-%d %H:%M') if req[7] else 'N/A' }}</td>
                                <td>
                                    <div class="action-buttons">
                                        {% if req[5] == 'Pending' %}
                                        <button class="btn btn-success btn-sm confirm-payment" data-id="{{ req[0] }}"
                                            data-booking-id="{{ req[2] }}" title="Confirm Payment">
                                            <i class="material-icons">payment</i>
                                        </button>
                                        {% endif %}
                                        {% if req[6] == 'Pending' %}
                                        <button class="btn btn-primary btn-sm approve-request" data-id="{{ req[0] }}"
                                            data-booking-id="{{ req[2] }}" title="Approve Request">
                                            <i class="material-icons">check_circle</i>
                                        </button>
                                        {% endif %}
                                        <button class="btn btn-info btn-sm view-full-details" data-id="{{ req[0] }}"
                                            title="View Full Details">
                                            <i class="material-icons">visibility</i>
                                        </button>
                                        <button class="btn btn-danger btn-sm delete-request" data-id="{{ req[0] }}" title="Delete Request">
                                            <i class="material-icons">delete</i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Ticket Generator Section -->
            <div id="tickets-section" class="main-content-section">
                <div class="section-header">
                    <h2>PDF Ticket Generator</h2>
                    <p>Generate and manage PDF tickets for all services</p>
                </div>
                
                <div class="card-container">
                    <div class="stats-card">
                        <div class="stat-icon">üé´</div>
                        <div class="stat-info">
                            <h3 id="total-tickets">0</h3>
                            <p>Total Tickets</p>
                        </div>
                    </div>
                    <div class="stats-card">
                        <div class="stat-icon">üìã</div>
                        <div class="stat-info">
                            <h3 id="pending-approval">0</h3>
                            <p>Pending Approval</p>
                        </div>
                    </div>
                    <div class="stats-card">
                        <div class="stat-icon">‚úÖ</div>
                        <div class="stat-info">
                            <h3 id="ready-tickets">0</h3>
                            <p>Ready for Ticket</p>
                        </div>
                    </div>
                    <div class="stats-card">
                        <div class="stat-icon">üì§</div>
                        <div class="stat-info">
                            <h3 id="sent-today">0</h3>
                            <p>Sent Today</p>
                        </div>
                    </div>
                </div>

                <div class="ticket-generator-container">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card ticket-search-card">
                                <div class="card-header">
                                    <h5>Filter Requests</h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label">Service Type</label>
                                        <select id="ticket-service-filter" class="form-select">
                                            <option value="all">All Services</option>
                                            <option value="Hotel Booking">Hotel Booking</option>
                                            <option value="Flight Booking">Flight Booking</option>
                                            <option value="Car Booking">Car Booking</option>
                                            <option value="Technician Booking">Technician Booking</option>
                                            <option value="Courier Booking">Courier Booking</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Payment Status</label>
                                        <select id="ticket-payment-filter" class="form-select">
                                            <option value="all">All</option>
                                            <option value="confirmed">Confirmed</option>
                                            <option value="pending">Pending</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Admin Status</label>
                                        <select id="ticket-admin-filter" class="form-select">
                                            <option value="all">All</option>
                                            <option value="confirmed">Confirmed</option>
                                            <option value="pending">Pending</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Date Range</label>
                                        <select id="ticket-date-filter" class="form-select">
                                            <option value="all">All Time</option>
                                            <option value="today">Today</option>
                                            <option value="week">This Week</option>
                                            <option value="month">This Month</option>
                                        </select>
                                    </div>
                                    <button class="btn btn-primary w-100" onclick="searchTickets()">
                                        <i class="material-icons">search</i> Filter Requests
                                    </button>
                                    <button class="btn btn-outline-secondary w-100 mt-2" onclick="resetTicketFilters()">
                                        <i class="material-icons">refresh</i> Reset Filters
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="card ticket-preview-card">
                                <div class="card-header">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0">Selected Request</h5>
                                        <div class="ticket-actions">
                                            <button class="btn btn-sm btn-success me-2" onclick="generateTicket()" id="generate-ticket-btn"
                                                disabled>
                                                <i class="material-icons">picture_as_pdf</i> Generate PDF
                                            </button>
                                            <button class="btn btn-sm btn-primary" onclick="sendTicketToUser()" id="send-ticket-btn" disabled>
                                                <i class="material-icons">send</i> Send to User
                                            </button>
                                            <button class="btn btn-sm btn-outline-info" onclick="downloadSelectedTicket()"
                                                id="download-ticket-btn" disabled>
                                                <i class="material-icons">download</i> Download
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div id="ticket-info" class="ticket-info">
                                        <div class="text-center text-muted py-5">
                                            <i class="material-icons display-4 mb-3">confirmation_number</i>
                                            <p>Select a request to generate PDF ticket</p>
                                        </div>
                                    </div>
                                    <div id="ticket-details" class="ticket-details" style="display: none;">
                                        <!-- Ticket details will be populated here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="ticket-requests-table mt-4">
                        <h5>Available Requests</h5>
                        <div class="table-container">
                            <table class="table table-dark table-striped" id="ticket-requests-table">
                                <thead>
                                    <tr>
                                        <th>Select</th>
                                        <th>Booking ID</th>
                                        <th>Service Type</th>
                                        <th>User</th>
                                        <th>Payment</th>
                                        <th>Admin</th>
                                        <th>Created At</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="ticket-requests-body">
                                    <!-- Will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Report Generator Section -->
            <div id="reports-section" class="main-content-section">
                <div class="section-header">
                    <h2>Report Generator</h2>
                    <p>Generate and send comprehensive user reports</p>
                </div>
                
                <div class="ticket-generator-container">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card ticket-search-card">
                                <div class="card-header">
                                    <h5>Select User</h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label text-light">User</label>
                                        <select id="report-user-select" class="form-select">
                                            <option value="">Loading users...</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label text-light">Send Options</label>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="send-report-dashboard" checked>
                                            <label class="form-check-label text-light" for="send-report-dashboard">
                                                Send to Dashboard
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="send-report-email">
                                            <label class="form-check-label text-light" for="send-report-email">
                                                Send to Email
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="card ticket-preview-card">
                                <div class="card-header">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0">Action</h5>
                                    </div>
                                </div>
                                <div class="card-body d-flex flex-column justify-content-center align-items-center" style="min-height: 200px;">
                                    <i class="material-icons display-4 mb-3 text-muted">assessment</i>
                                    <p class="text-muted mb-4">Select a user and sending method to generate report</p>
                                    
                                    <button class="btn btn-primary btn-lg" onclick="generateAndSendUserReport()">
                                        <i class="material-icons">send</i> Generate & Send Report
                                    </button>
                                    
                                    <div id="report-status" class="mt-4 w-100"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analytics Section -->
            <div id="analytics-section" class="main-content-section">
                <div class="section-header">
                    <h2>Analytics Dashboard</h2>
                    <p>Real-time insights and statistics</p>
                </div>
                
                <div class="card-container">
                    <div class="stats-card">
                        <div class="stat-icon">üè®</div>
                        <div class="stat-info">
                            <h3 id="hotel-bookings">{{ requests|selectattr('3', 'equalto', 'Hotel Booking')|list|length }}</h3>
                            <p>Hotel Bookings</p>
                        </div>
                    </div>
                    <div class="stats-card">
                        <div class="stat-icon">‚úàÔ∏è</div>
                        <div class="stat-info">
                            <h3 id="flight-bookings">{{ requests|selectattr('3', 'equalto', 'Flight Booking')|list|length }}</h3>
                            <p>Flight Bookings</p>
                        </div>
                    </div>
                    <div class="stats-card">
                        <div class="stat-icon">üöó</div>
                        <div class="stat-info">
                            <h3 id="car-bookings">{{ requests|selectattr('3', 'equalto', 'Car Booking')|list|length }}</h3>
                            <p>Car Bookings</p>
                        </div>
                    </div>
                    <div class="stats-card">
                        <div class="stat-icon">üõ†Ô∏è</div>
                        <div class="stat-info">
                            <h3 id="technician-requests">{{ requests|selectattr('3', 'equalto', 'Technician Booking')|list|length }}</h3>
                            <p>Technician Requests</p>
                        </div>
                    </div>
                </div>

                <div class="analytics-controls mb-4">
                    <div class="row">
                        <div class="col-md-4">
                            <label class="form-label">Date Range</label>
                            <select id="analytics-date-range" class="form-select" onchange="updateAnalytics()">
                                <option value="7">Last 7 Days</option>
                                <option value="30">Last 30 Days</option>
                                <option value="90">Last 90 Days</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Refresh Interval</label>
                            <select id="analytics-refresh-interval" class="form-select" onchange="setAnalyticsRefresh()">
                                <option value="10000">10 Seconds</option>
                                <option value="30000">30 Seconds</option>
                                <option value="60000">1 Minute</option>
                                <option value="0">Manual</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">&nbsp;</label>
                            <button class="btn btn-primary w-100" onclick="updateAnalytics()">
                                <i class="material-icons">refresh</i> Refresh Analytics
                            </button>
                        </div>
                    </div>
                </div>

                <div class="analytics-charts">
                    <div class="chart-card">
                        <h4>Requests Timeline</h4>
                        <div class="chart-container">
                            <canvas id="requests-timeline"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <h4>Service Distribution</h4>
                        <div class="chart-container">
                            <canvas id="service-distribution"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Broadcast Notifications Section -->
            <div id="broadcast-section" class="main-content-section">
                <div class="section-header">
                    <h2>Broadcast Notifications</h2>
                    <p>Send real-time alerts to all users or a specific user</p>
                </div>
                
                <div class="row">
                    <div class="col-lg-8 mx-auto">
                        <div class="card" style="background: var(--dark-card); border: 1px solid var(--border);">
                            <div class="card-body p-4">
                                <h5 class="text-primary mb-4">
                                    <i class="material-icons align-middle">campaign</i> Send Announcement
                                </h5>
                                <div class="mb-3">
                                    <label class="form-label text-light">Target Audience</label>
                                    <select id="broadcast-target" class="form-select">
                                        <option value="all">All Users</option>
                                        <option value="specific">Specific User (by ID)</option>
                                    </select>
                                </div>
                                <div class="mb-3" id="specific-user-input" style="display: none;">
                                    <label class="form-label text-light">User ID</label>
                                    <input type="number" id="target-user-id" class="form-control" placeholder="Enter User ID (e.g., 5)"
                                        min="1">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label text-light">Message Title</label>
                                    <input type="text" id="broadcast-title" class="form-control"
                                        placeholder="e.g., Profile Update Required" maxlength="100">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label text-light">Message Body</label>
                                    <textarea id="broadcast-message" class="form-control" rows="4"
                                        placeholder="e.g., Please update your full name and email in profile settings within 24 hours."></textarea>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label text-light">Icon (Material Icons)</label>
                                    <input type="text" id="broadcast-icon" class="form-control" value="notifications_active"
                                        placeholder="e.g., info, warning, check_circle, email">
                                </div>
                                <div class="mb-4">
                                    <label class="form-label text-light">Type</label>
                                    <select id="broadcast-type" class="form-select">
                                        <option value="info">Info (Blue)</option>
                                        <option value="warning">Warning (Yellow)</option>
                                        <option value="success">Success (Green)</option>
                                        <option value="error">Error (Red)</option>
                                    </select>
                                </div>
                                <div class="d-flex gap-3">
                                    <button class="btn btn-primary flex-fill" onclick="sendBroadcast()">
                                        <i class="material-icons">send</i> Send Notification
                                    </button>
                                    <button class="btn btn-outline-secondary" onclick="quickMessage('update_profile')">
                                        Update Profile
                                    </button>
                                    <button class="btn btn-outline-info" onclick="quickMessage('check_email')">
                                        Check Email
                                    </button>
                                </div>
                            </div>
                        </div>
                        <!-- Quick Templates -->
                        <div class="mt-4">
                            <h6 class="text-primary">Quick Messages</h6>
                            <div class="row g-2">
                                <div class="col-md-4">
                                    <button class="btn btn-sm btn-outline-warning w-100" onclick="quickMessage('name_change')">
                                        Ask to Change Name
                                    </button>
                                </div>
                                <div class="col-md-4">
                                    <button class="btn btn-sm btn-outline-warning w-100" onclick="quickMessage('email_change')">
                                        Ask to Update Email
                                    </button>
                                </div>
                                <div class="col-md-4">
                                    <button class="btn btn-sm btn-outline-success w-100" onclick="quickMessage('ticket_sent')">
                                        Ticket Sent to Email
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal fade" id="userDetailsModal" tabindex="-1" aria-labelledby="userDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="userDetailsModalLabel">User Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="userDetailsModalBody">
                    <!-- User details will be populated by JavaScript -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="generateUserReport()">
                        <i class="material-icons">picture_as_pdf</i> Generate Report
                    </button>
                    <button type="button" class="btn btn-success" onclick="sendReportToUser()">
                        <i class="material-icons">send</i> Send to User
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="requestDetailsModal" tabindex="-1" aria-labelledby="requestDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="requestDetailsModalLabel">Request Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="requestDetailsModalBody">
                    <!-- Request details will be populated by JavaScript -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="generateTicketFromModal()">
                        <i class="material-icons">picture_as_pdf</i> Generate PDF Ticket
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="fullRequestDetailsModal" tabindex="-1" aria-labelledby="fullRequestDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="fullRequestDetailsModalLabel">Full Request Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="fullRequestDetailsModalBody">
                    <!-- Full request details will be populated by JavaScript -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="printFullDetails()">Print</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="sendTicketModal" tabindex="-1" aria-labelledby="sendTicketModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="sendTicketModalLabel">Send Ticket</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>How would you like to send this ticket?</p>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="send-ticket-dashboard" checked>
                        <label class="form-check-label" for="send-ticket-dashboard">
                            Send to User Dashboard
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="send-ticket-email">
                        <label class="form-check-label" for="send-ticket-email">
                            Send to User Email
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="confirmSendTicket()">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- Hidden file input for admin -->
    <input type="file" id="admin-file-input" style="display: none;" onchange="handleAdminFileUpload(this)">

    <script>
      // ========================
        // GLOBAL VARIABLES
        // ========================
        let socket;
        let requestsTimelineChart, serviceDistributionChart;
        let analyticsRefreshInterval;
        let currentSelectedRequest = null;
        let currentSelectedUser = null;
        let currentChatUserId = null;
        let currentSupportUser = null;
        let adminTypingTimeout = null;
        let supportUsersInterval = null;

        // ========================
        // INITIALIZATION
        // ========================
        $(document).ready(function () {
            initializeSocket();
            initializeCharts();
            initializeEventHandlers();
            initializeFilters();
            updateAllStats();
            updateUserRequestCounts();
            
            refreshUsers();
            refreshRequests();
            updateAnalytics();
            
            if ($('#tickets-section').hasClass('active')) {
                searchTickets();
            }
            
            // Auto-refresh every 30 seconds
            setInterval(() => {
                if ($('#users-section').hasClass('active')) {
                    refreshUsers();
                } else if ($('#requests-section').hasClass('active')) {
                    refreshRequests();
                } else if ($('#tickets-section').hasClass('active')) {
                    searchTickets();
                } else if ($('#analytics-section').hasClass('active')) {
                    updateAnalytics();
                }
            }, 30000);
        });

        // ========================
        // SOCKET.IO FUNCTIONS
        // ========================
        function initializeSocket() {
            socket = io();
            
            socket.on('connect', () => {
                console.log('Connected to WebSocket');
                showToast('Connected to real-time updates', 'success');
                socket.emit('get_live_data');
            });
            
            socket.on('disconnect', () => {
                console.log('Disconnected from WebSocket');
                showToast('Disconnected from real-time updates', 'error');
            });
            
            // Live data updates
            socket.on('live_data_update', (data) => {
                updateAllStats(data);
                updateCharts(data);
            });
            
            socket.on('analytics_update', (data) => {
                if (data && data.analytics) {
                    updateStats(data.analytics);
                    updateCharts(data.analytics);
                }
            });
            
            socket.on('user_activity', (data) => {
                if (data && data.active_users) {
                    updateUserStatuses(data.active_users);
                }
                if (data && data.active_count !== undefined) {
                    $('#active-users-today').text(data.active_count);
                }
            });
            
            socket.on('new_request', (data) => {
                if (data.request) {
                    addRequestToTable(data.request);
                    updateAllStats();
                    showToast(`New ${data.request[3]} request received!`, 'info');
                }
            });
            
            socket.on('update_requests', (data) => {
                if (data.requests) {
                    refreshRequestsTable(data.requests);
                    updateAllStats();
                }
            });
            
            socket.on('payment_confirmed', (data) => {
                if (data.request_id) {
                    updateRequestStatus(data.request_id, 'payment', 'Confirmed');
                    updateAllStats();
                    showToast(`Payment confirmed for request #${data.request_id}`, 'success');
                }
            });
            
            socket.on('request_approved', (data) => {
                if (data.request_id) {
                    updateRequestStatus(data.request_id, 'admin', 'Confirmed');
                    updateAllStats();
                    showToast(`Request #${data.request_id} approved successfully!`, 'success');
                }
            });
            
            socket.on('booking_confirmed', (data) => {
                if (data.booking_id) {
                    showToast(`Booking ${data.booking_id} confirmed!`, 'success');
                    refreshRequests();
                }
            });
            
            socket.on('request_deleted', (data) => {
                const row = $(`tr[data-request-id="${data.request_id}"]`);
                if (row.length) {
                    row.fadeOut(300, function () {
                        $(this).remove();
                        updateAllStats();
                    });
                    showToast(`Request #${data.request_id} deleted successfully`, 'success');
                }
            });
            
            socket.on('ticket_ready', (data) => {
                showToast(`PDF ticket generated for ${data.booking_id}`, 'success');
                refreshRequests();
            });
            
            socket.on('ticket_received', (data) => {
                showToast(`PDF ticket sent to user`, 'success');
            });
            
            socket.on('delete_error', (data) => {
                showToast(data.message, 'error');
            });
            
            socket.on('error', (data) => {
                showToast(data.message, 'error');
            });
            
            socket.on('approve_success', (data) => {
                showToast(data.message, 'success');
            });
            
            // Support chat listeners
            socket.on('support_message_sent', (data) => {
                console.log('üì© New user message:', data);
                if ($('#support-users-list').length) {
                    loadSupportUsers();
                }
                if (currentSupportUser && currentSupportUser.id === data.user_id) {
                    appendAdminSupportMessage(data);
                } else {
                    updateUserUnreadCount(data.user_id, true);
                }
            });
            
            socket.on('support_user_typing', (data) => {
                if (currentSupportUser && currentSupportUser.id === data.user_id) {
                    showAdminTypingIndicator();
                }
            });
        }

        // ========================
        // INITIALIZATION FUNCTIONS
        // ========================
        function initializeEventHandlers() {
            // Request action handlers
            $(document).on('click', '.approve-request', function () {
                const id = $(this).data('id');
                const bookingId = $(this).data('booking-id');
                if (confirm(`Are you sure you want to approve request #${id}?`)) {
                    socket.emit('approve_request', { request_id: id, booking_id: bookingId });
                }
            });
            
            $(document).on('click', '.confirm-payment', function () {
                const id = $(this).data('id');
                const bookingId = $(this).data('booking-id');
                if (confirm(`Are you sure you want to confirm payment for request #${id}?`)) {
                    socket.emit('confirm_payment', { request_id: id, booking_id: bookingId });
                }
            });
            
            $(document).on('click', '.delete-request', function () {
                const id = $(this).data('id');
                if (confirm(`Are you sure you want to delete request #${id}? This action cannot be undone.`)) {
                    socket.emit('delete_request', { request_id: id });
                }
            });
            
            $(document).on('click', '.view-full-details', function () {
                const id = $(this).data('id');
                showFullRequestDetails(id);
            });
            
            $(document).on('click', '.view-ticket-details', function () {
                const requestId = $(this).data('request-id');
                viewTicketDetails(requestId);
            });
            
            $(document).on('click', '.generate-ticket-btn', function () {
                const requestId = $(this).data('request-id');
                selectTicketForGeneration(requestId);
            });
            
            $(document).on('change', '.ticket-select', function () {
                handleTicketSelection(this);
            });
        }

        function initializeFilters() {
            $('#user-search').on('input', function () {
                filterUsers();
            });
            
            $('#user-filter').on('change', function () {
                filterUsers();
            });
            
            $('#request-search').on('input', function () {
                filterRequestsTable();
            });
            
            $('#status-filter, #admin-status-filter, #service-filter, #date-filter').on('change', function () {
                filterRequestsTable();
            });
            
            $('#broadcast-target').on('change', function () {
                if ($(this).val() === 'specific') {
                    $('#specific-user-input').show();
                } else {
                    $('#specific-user-input').hide();
                }
            });
        }

        function initializeCharts() {
            const timelineCtx = document.getElementById('requests-timeline').getContext('2d');
            requestsTimelineChart = new Chart(timelineCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Requests',
                        data: [],
                        borderColor: '#d4af37',
                        backgroundColor: 'rgba(212, 175, 55, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: '#ffffff' } }
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: '#cccccc' }
                        },
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: '#cccccc' }
                        }
                    }
                }
            });
            
            const serviceCtx = document.getElementById('service-distribution').getContext('2d');
            serviceDistributionChart = new Chart(serviceCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Hotel', 'Flight', 'Car', 'Technician', 'Courier'],
                    datasets: [{
                        data: [0, 0, 0, 0, 0],
                        backgroundColor: ['#d4af37', '#8b7355', '#a0522d', '#cd853f', '#d2691e'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: '#ffffff' } }
                    }
                }
            });
        }

        // ========================
        // USER MANAGEMENT FUNCTIONS
        // ========================
        function filterUsers() {
            const searchTerm = $('#user-search').val().toLowerCase();
            const filterValue = $('#user-filter').val();
            
            $('.user-card').each(function () {
                const userName = $(this).find('.user-card-value').first().text().toLowerCase();
                const userEmail = $(this).find('.user-card-value').eq(1).text().toLowerCase();
                const userId = $(this).data('user-id');
                const requestCount = parseInt($(`#user-${userId}-request-count`).text()) || 0;
                let showRow = true;
                
                if (searchTerm && !userName.includes(searchTerm) && !userEmail.includes(searchTerm)) {
                    showRow = false;
                }
                
                if (filterValue === 'with-requests' && requestCount === 0) {
                    showRow = false;
                } else if (filterValue === 'no-requests' && requestCount > 0) {
                    showRow = false;
                } else if (filterValue === 'active-today') {
                    const statusIndicator = $(`#status-${userId}`);
                    if (!statusIndicator.hasClass('active')) {
                        showRow = false;
                    }
                }
                
                $(this).toggle(showRow);
            });
        }

        function showUserDetails(userId) {
            currentSelectedUser = userId;
            $.get(`/admin/user/${userId}`, function (data) {
                if (data.error) {
                    showToast('Error loading user details: ' + data.error, 'error');
                    return;
                }
                
                $('#userDetailsModalBody').html(`
                    <div class="row">
                        <div class="col-md-6">
                            <div class="user-detail-section">
                                <h6>Basic Information</h6>
                                <div class="detail-item">
                                    <label>User ID:</label>
                                    <span>${data.id}</span>
                                </div>
                                <div class="detail-item">
                                    <label>Full Name:</label>
                                    <span>${data.full_name}</span>
                                </div>
                                <div class="detail-item">
                                    <label>Email:</label>
                                    <span>${data.email}</span>
                                </div>
                                <div class="detail-item">
                                    <label>Username:</label>
                                    <span>${data.username}</span>
                                </div>
                                <div class="detail-item">
                                    <label>Registration Date:</label>
                                    <span>${data.registration_date}</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="user-detail-section">
                                <h6>Contact Information</h6>
                                <div class="detail-item">
                                    <label>Phone:</label>
                                    <span>${data.phone || 'Not provided'}</span>
                                </div>
                                <div class="detail-item">
                                    <label>Address:</label>
                                    <span>${data.address || 'Not provided'}</span>
                                </div>
                                <div class="detail-item">
                                    <label>WhatsApp:</label>
                                    <span>${data.whatsapp || 'Not provided'}</span>
                                </div>
                            </div>
                            <div class="user-detail-section">
                                <h6>Social Media</h6>
                                <div class="detail-item">
                                    <label>Instagram:</label>
                                    <span>${data.instagram || 'Not provided'}</span>
                                </div>
                                <div class="detail-item">
                                    <label>Facebook:</label>
                                    <span>${data.facebook || 'Not provided'}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="user-detail-section mt-3">
                        <h6>Activity Summary</h6>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="activity-stat">
                                    <label>Total Requests:</label>
                                    <span class="stat-value">${data.total_requests || 0}</span>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="activity-stat">
                                    <label>Confirmed:</label>
                                    <span class="stat-value">${data.confirmed_requests || 0}</span>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="activity-stat">
                                    <label>Pending:</label>
                                    <span class="stat-value">${data.pending_requests || 0}</span>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="activity-stat">
                                    <label>Last Active:</label>
                                    <span class="stat-value">${data.last_active || 'Never'}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `);
                
                $('#userDetailsModal').modal('show');
            }).fail(function () {
                showToast('Error loading user details', 'error');
            });
        }

        function updateUserStatuses(activeUsersList) {
            $('.user-status-indicator').removeClass('active');
            if (activeUsersList && activeUsersList.length > 0) {
                activeUsersList.forEach(userId => {
                    $(`#status-${userId}`).addClass('active');
                });
            }
        }

        function updateUserRequestCounts() {
            $('.user-card').each(function () {
                const userId = $(this).data('user-id');
                $.get(`/admin/user/${userId}/request-count`, function (data) {
                    if (data.count !== undefined) {
                        $(`#user-${userId}-request-count`).text(data.count);
                    }
                });
            });
        }

        function refreshUsers() {
            $.get('/admin/users', function (data) {
                if (data.users) {
                    updateUserCards(data.users);
                    updateStats(data.stats);
                    updateUserRequestCounts();
                }
            }).fail(function () {
                showToast('Error refreshing users', 'error');
            });
        }

        function updateUserCards(users) {
            const container = $('#user-cards-container');
            container.empty();
            
            users.forEach(user => {
                container.append(`
                    <div class="user-card" data-user-id="${user.id}" onclick="showUserDetails(${user.id})">
                        <div class="user-card-header">
                            <div class="user-card-id">#${user.id}</div>
                            <div class="user-card-avatar">${user.full_name[0] || 'U'}</div>
                            <div class="user-status-indicator" id="status-${user.id}"></div>
                        </div>
                        <div class="user-card-info">
                            <div class="user-card-field">
                                <span class="user-card-label">Name:</span>
                                <span class="user-card-value">${user.full_name}</span>
                            </div>
                            <div class="user-card-field">
                                <span class="user-card-label">Email:</span>
                                <span class="user-card-value">${user.email}</span>
                            </div>
                            <div class="user-card-field">
                                <span class="user-card-label">Username:</span>
                                <span class="user-card-value">${user.username}</span>
                            </div>
                            <div class="user-card-field">
                                <span class="user-card-label">Requests:</span>
                                <span class="user-card-value" id="user-${user.id}-request-count">0</span>
                            </div>
                        </div>
                    </div>
                `);
            });
        }

        // ========================
        // REQUEST MANAGEMENT FUNCTIONS
        // ========================
        function filterRequestsTable() {
            const statusFilter = $('#status-filter').val();
            const adminStatusFilter = $('#admin-status-filter').val();
            const serviceFilter = $('#service-filter').val();
            const dateFilter = $('#date-filter').val();
            const searchTerm = $('#request-search').val().toLowerCase();
            
            $('#requests-body tr').each(function () {
                const paymentStatus = $(this).data('payment-status') || '';
                const adminStatus = $(this).data('admin-status') || '';
                const serviceType = $(this).data('service-type') || '';
                const createdAt = $(this).find('td').eq(7).text();
                const rowText = $(this).text().toLowerCase();
                let showRow = true;
                
                if (searchTerm && !rowText.includes(searchTerm)) {
                    showRow = false;
                }
                
                if (statusFilter !== 'all') {
                    if (statusFilter === 'pending' && paymentStatus !== 'pending') showRow = false;
                    if (statusFilter === 'confirmed' && paymentStatus !== 'confirmed') showRow = false;
                }
                
                if (adminStatusFilter !== 'all') {
                    if (adminStatusFilter === 'pending' && adminStatus !== 'pending') showRow = false;
                    if (adminStatusFilter === 'confirmed' && adminStatus !== 'confirmed') showRow = false;
                }
                
                if (serviceFilter !== 'all' && !serviceType.includes(serviceFilter)) {
                    showRow = false;
                }
                
                if (dateFilter !== 'all' && createdAt && createdAt !== 'N/A') {
                    const rowDate = new Date(createdAt);
                    const today = new Date();
                    
                    if (dateFilter === 'today') {
                        if (rowDate.toDateString() !== today.toDateString()) {
                            showRow = false;
                        }
                    } else if (dateFilter === 'week') {
                        const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                        if (rowDate < weekAgo) {
                            showRow = false;
                        }
                    } else if (dateFilter === 'month') {
                        const monthAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
                        if (rowDate < monthAgo) {
                            showRow = false;
                        }
                    }
                }
                
                $(this).toggle(showRow);
            });
        }

        function showRequestDetails(button) {
            const details = $(button).data('details');
            const serviceType = $(button).data('service-type');
            const requestId = $(button).closest('tr').data('request-id');
            const bookingId = $(button).closest('tr').find('td').eq(2).text();
            
            try {
                const parsedDetails = typeof details === 'string' ? JSON.parse(details) : details;
                let detailsHtml = '<div class="request-details-content">';
                detailsHtml += `<h6>Service: ${serviceType}</h6>`;
                detailsHtml += `<div class="mb-3"><strong>Booking ID:</strong> ${bookingId}</div>`;
                detailsHtml += '<div class="details-table"><table class="table table-sm">';
                
                for (const [key, value] of Object.entries(parsedDetails)) {
                    detailsHtml += `<tr><td><strong>${key}:</strong></td><td>${typeof value === 'object' ? JSON.stringify(value) : value}</td></tr>`;
                }
                
                detailsHtml += '</table></div></div>';
                $('#requestDetailsModalBody').html(detailsHtml);
                $('#requestDetailsModal').modal('show');
                
                currentSelectedRequest = { id: requestId, bookingId, serviceType };
            } catch (e) {
                $('#requestDetailsModalBody').html(`<div class="request-details-content"><pre>${details}</pre></div>`);
                $('#requestDetailsModal').modal('show');
            }
        }

        function showFullRequestDetails(requestId) {
            $.get(`/admin/request/${requestId}`, function (data) {
                if (data.error) {
                    showToast('Error loading request details: ' + data.error, 'error');
                    return;
                }
                
                $('#fullRequestDetailsModalBody').html(`
                    <div class="full-request-details">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="detail-section">
                                    <h6>Basic Information</h6>
                                    <div class="detail-item">
                                        <label>Request ID:</label>
                                        <span>${data.id}</span>
                                    </div>
                                    <div class="detail-item">
                                        <label>Booking ID:</label>
                                        <span>${data.booking_id}</span>
                                    </div>
                                    <div class="detail-item">
                                        <label>Service Type:</label>
                                        <span>${data.service_type}</span>
                                    </div>
                                    <div class="detail-item">
                                        <label>User ID:</label>
                                        <span>${data.user_id}</span>
                                    </div>
                                    <div class="detail-item">
                                        <label>Created At:</label>
                                        <span>${data.created_at}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="detail-section">
                                    <h6>Status Information</h6>
                                    <div class="detail-item">
                                        <label>Payment Status:</label>
                                        <span class="status-badge status-${data.payment_status.toLowerCase()}">${data.payment_status}</span>
                                    </div>
                                    <div class="detail-item">
                                        <label>Admin Confirmation:</label>
                                        <span class="status-badge status-${data.admin_confirmation.toLowerCase()}">${data.admin_confirmation}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="detail-section mt-3">
                            <h6>Service Details</h6>
                            <pre class="details-json">${JSON.stringify(data.details, null, 2)}</pre>
                        </div>
                    </div>
                `);
                
                $('#fullRequestDetailsModal').modal('show');
            }).fail(function () {
                showToast('Error loading full request details', 'error');
            });
        }

        function refreshRequests() {
            $.get('/admin/requests', function (data) {
                if (data.requests) {
                    refreshRequestsTable(data.requests);
                    updateStats(data.stats);
                }
            }).fail(function () {
                showToast('Error refreshing requests', 'error');
            });
        }

        function refreshRequestsTable(requests) {
            const tbody = $('#requests-body');
            tbody.empty();
            
            requests.forEach(req => {
                tbody.append(`
                    <tr data-request-id="${req.id}" data-service-type="${req.service_type.toLowerCase()}" data-payment-status="${req.payment_status.toLowerCase()}" data-admin-status="${req.admin_confirmation.toLowerCase()}">
                        <td>${req.id}</td>
                        <td>${req.user_id}</td>
                        <td>${req.booking_id}</td>
                        <td>
                            <span class="service-badge service-${req.service_type.toLowerCase().replace(' ', '-')}">
                                ${req.service_type}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-info view-details"
                                data-details='${JSON.stringify(req.details)}'
                                data-service-type="${req.service_type}"
                                onclick="showRequestDetails(this)">
                                View Details
                            </button>
                        </td>
                        <td>
                            <span class="status-badge status-${req.payment_status.toLowerCase()}">
                                ${req.payment_status}
                            </span>
                        </td>
                        <td>
                            <span class="status-badge status-${req.admin_confirmation.toLowerCase()}">
                                ${req.admin_confirmation}
                            </span>
                        </td>
                        <td>${req.created_at}</td>
                        <td>
                            <div class="action-buttons">
                                ${req.payment_status === 'Pending' ? `
                                <button class="btn btn-success btn-sm confirm-payment" data-id="${req.id}" data-booking-id="${req.booking_id}"
                                    title="Confirm Payment">
                                    <i class="material-icons">payment</i>
                                </button>
                                ` : ''}
                                ${req.admin_confirmation === 'Pending' ? `
                                <button class="btn btn-primary btn-sm approve-request" data-id="${req.id}" data-booking-id="${req.booking_id}"
                                    title="Approve Request">
                                    <i class="material-icons">check_circle</i>
                                </button>
                                ` : ''}
                                <button class="btn btn-info btn-sm view-full-details" data-id="${req.id}"
                                    title="View Full Details">
                                    <i class="material-icons">visibility</i>
                                </button>
                                <button class="btn btn-danger btn-sm delete-request" data-id="${req.id}" title="Delete Request">
                                    <i class="material-icons">delete</i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `);
            });
        }

        function addRequestToTable(request) {
            const tbody = $('#requests-body');
            tbody.prepend(`
                <tr data-request-id="${request[0]}" data-service-type="${request[3].toLowerCase()}" data-payment-status="${request[5].toLowerCase()}" data-admin-status="${request[6].toLowerCase()}">
                    <td>${request[0]}</td>
                    <td>${request[1]}</td>
                    <td>${request[2]}</td>
                    <td>
                        <span class="service-badge service-${request[3].toLowerCase().replace(' ', '-')}">
                            ${request[3]}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-info view-details"
                            data-details='${JSON.stringify(request[4])}'
                            data-service-type="${request[3]}"
                            onclick="showRequestDetails(this)">
                            View Details
                        </button>
                    </td>
                    <td>
                        <span class="status-badge status-${request[5].toLowerCase()}">
                            ${request[5]}
                        </span>
                    </td>
                    <td>
                        <span class="status-badge status-${request[6].toLowerCase()}">
                            ${request[6]}
                        </span>
                    </td>
                    <td>${request[7] || 'N/A'}</td>
                    <td>
                        <div class="action-buttons">
                            ${request[5] === 'Pending' ? `
                            <button class="btn btn-success btn-sm confirm-payment" data-id="${request[0]}" data-booking-id="${request[2]}"
                                title="Confirm Payment">
                                <i class="material-icons">payment</i>
                            </button>
                            ` : ''}
                            ${request[6] === 'Pending' ? `
                            <button class="btn btn-primary btn-sm approve-request" data-id="${request[0]}" data-booking-id="${request[2]}"
                                title="Approve Request">
                                <i class="material-icons">check_circle</i>
                            </button>
                            ` : ''}
                            <button class="btn btn-info btn-sm view-full-details" data-id="${request[0]}"
                                title="View Full Details">
                                <i class="material-icons">visibility</i>
                            </button>
                            <button class="btn btn-danger btn-sm delete-request" data-id="${request[0]}" title="Delete Request">
                                <i class="material-icons">delete</i>
                            </button>
                        </div>
                    </td>
                </tr>
            `);
        }

        function updateRequestStatus(requestId, type, status) {
            const row = $(`tr[data-request-id="${requestId}"]`);
            if (row.length) {
                if (type === 'payment') {
                    row.find('.status-badge.status-pending').removeClass('status-pending').addClass('status-confirmed').text('Confirmed');
                    row.find('.confirm-payment').remove();
                } else if (type === 'admin') {
                    row.find('td:nth-child(7) .status-badge').removeClass('status-pending').addClass('status-confirmed').text('Confirmed');
                    row.find('.approve-request').remove();
                }
                
                if ($('#tickets-section').hasClass('active')) {
                    searchTickets();
                }
            }
        }

        // ========================
        // TICKET GENERATOR FUNCTIONS
        // ========================
        function resetTicketFilters() {
            $('#ticket-service-filter').val('all');
            $('#ticket-payment-filter').val('all');
            $('#ticket-admin-filter').val('all');
            $('#ticket-date-filter').val('all');
            searchTickets();
        }

        function searchTickets() {
            const serviceFilter = $('#ticket-service-filter').val();
            const paymentFilter = $('#ticket-payment-filter').val();
            const adminFilter = $('#ticket-admin-filter').val();
            const dateFilter = $('#ticket-date-filter').val();
            
            const params = {};
            if (serviceFilter !== 'all') params.service_type = serviceFilter;
            if (paymentFilter !== 'all') params.payment_status = paymentFilter;
            if (adminFilter !== 'all') params.admin_status = adminFilter;
            if (dateFilter !== 'all') params.date_range = dateFilter;
            
            $.get('/admin/ticket-requests', params, function (data) {
                if (data.error) {
                    showToast('Error loading requests: ' + data.error, 'error');
                    return;
                }
                
                const tbody = $('#ticket-requests-body');
                tbody.empty();
                let pendingCount = 0;
                let readyCount = 0;
                let totalCount = data.requests.length;
                
                data.requests.forEach(req => {
                    const isReadyForTicket = req.payment_status === 'Confirmed' && req.admin_confirmation === 'Confirmed';
                    const isPendingApproval = req.admin_confirmation === 'Pending';
                    
                    if (isReadyForTicket) readyCount++;
                    if (isPendingApproval) pendingCount++;
                    
                    const row = `
                        <tr data-request-id="${req.id}"
                            data-ready="${isReadyForTicket}"
                            data-pending="${isPendingApproval}">
                            <td>
                                <input type="checkbox" class="ticket-select"
                                       data-request-id="${req.id}"
                                       ${isReadyForTicket ? '' : 'disabled'}
                                       onchange="handleTicketSelection(this)">
                            </td>
                            <td>${req.booking_id}</td>
                            <td>
                                <span class="service-badge service-${req.service_type.toLowerCase().replace(' ', '-')}">
                                    ${req.service_type}
                                </span>
                            </td>
                            <td>${req.user_id}</td>
                            <td>
                                <span class="status-badge status-${req.payment_status.toLowerCase()}">
                                    ${req.payment_status}
                                </span>
                            </td>
                            <td>
                                <span class="status-badge status-${req.admin_confirmation.toLowerCase()}">
                                    ${req.admin_confirmation}
                                </span>
                            </td>
                            <td>${req.created_at}</td>
                            <td>
                                <button class="btn btn-sm btn-info view-ticket-details"
                                        data-request-id="${req.id}"
                                        onclick="viewTicketDetails(${req.id})">
                                    <i class="material-icons">visibility</i> View
                                </button>
                                ${isReadyForTicket ? `
                                <button class="btn btn-sm btn-primary generate-ticket-btn"
                                        data-request-id="${req.id}"
                                        onclick="selectTicketForGeneration(${req.id})">
                                    <i class="material-icons">picture_as_pdf</i> Select
                                </button>
                                ` : ''}
                            </td>
                        </tr>
                    `;
                    tbody.append(row);
                });
                
                updateTicketStats(totalCount, pendingCount, readyCount);
            }).fail(function () {
                showToast('Error loading ticket requests', 'error');
            });
        }

        function updateTicketStats(total, pending, ready) {
            $('#total-tickets').text(total);
            $('#pending-approval').text(pending);
            $('#ready-tickets').text(ready);
            $('#sent-today').text('0');
        }

        function handleTicketSelection(checkbox) {
            const requestId = $(checkbox).data('request-id');
            const isChecked = $(checkbox).is(':checked');
            
            if (isChecked) {
                selectTicketForGeneration(requestId);
            } else {
                resetTicketSelection();
            }
        }

        function viewTicketDetails(requestId) {
            $.get(`/admin/request/${requestId}`, function (data) {
                if (data.error) {
                    showToast('Error loading request: ' + data.error, 'error');
                    return;
                }
                
                const details = data.details || {};
                let detailsHtml = `
                    <div class="ticket-details-modal">
                        <h6>Request Details</h6>
                        <div class="info-grid">
                            <div class="info-item">
                                <span class="info-label">Booking ID:</span>
                                <span class="info-value">${data.booking_id}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Service Type:</span>
                                <span class="info-value">${data.service_type}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">User ID:</span>
                                <span class="info-value">${data.user_id}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Payment Status:</span>
                                <span class="info-value status-badge status-${data.payment_status.toLowerCase()}">${data.payment_status}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Admin Status:</span>
                                <span class="info-value status-badge status-${data.admin_confirmation.toLowerCase()}">${data.admin_confirmation}</span>
                            </div>
                        </div>
                        <div class="mt-3">
                            <h6>Service Details</h6>
                            <pre class="details-json">${JSON.stringify(details, null, 2)}</pre>
                        </div>
                    </div>
                `;
                
                $('#requestDetailsModalBody').html(detailsHtml);
                $('#requestDetailsModal').modal('show');
            }).fail(function () {
                showToast('Error loading request details', 'error');
            });
        }

        function selectTicketForGeneration(requestId) {
            $.get(`/admin/request/${requestId}`, function (data) {
                if (data.error) {
                    showToast('Error loading request: ' + data.error, 'error');
                    return;
                }
                
                currentSelectedRequest = {
                    id: data.id,
                    bookingId: data.booking_id,
                    serviceType: data.service_type,
                    userId: data.user_id,
                    details: data.details
                };
                
                displayTicketDetails(data);
                $('#generate-ticket-btn').prop('disabled', false).html('<i class="material-icons">picture_as_pdf</i> Generate PDF');
                $('#send-ticket-btn').prop('disabled', true);
                $('#download-ticket-btn').prop('disabled', true);
            }).fail(function () {
                showToast('Error loading request details', 'error');
            });
        }

        function displayTicketDetails(requestData) {
            let details = requestData.details || {};
            let detailsHtml = '<h6>Request Details</h6>';
            
            if (typeof details === 'string') {
                try {
                    details = JSON.parse(details);
                } catch (e) {
                    details = { raw: details };
                }
            }
            
            switch (requestData.service_type) {
                case 'Hotel Booking':
                    detailsHtml += `
                        <div class="info-grid">
                            <div class="info-item">
                                <span class="info-label">Hotel:</span>
                                <span class="info-value">${details.hotel_name || 'N/A'}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Check-in:</span>
                                <span class="info-value">${details.checkin || 'N/A'}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Check-out:</span>
                                <span class="info-value">${details.checkout || 'N/A'}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Rooms:</span>
                                <span class="info-value">${details.rooms || 1}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Amount:</span>
                                <span class="info-value">‚Çπ${details.total_amount || 0}</span>
                            </div>
                        </div>
                    `;
                    break;
                case 'Flight Booking':
                    detailsHtml += `
                        <div class="info-grid">
                            <div class="info-item">
                                <span class="info-label">Flight:</span>
                                <span class="info-value">${details.flight_no || 'N/A'}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Airline:</span>
                                <span class="info-value">${details.airline || 'N/A'}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Route:</span>
                                <span class="info-value">${details.origin || 'N/A'} ‚Üí ${details.destination || 'N/A'}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Departure:</span>
                                <span class="info-value">${details.departure_time || 'N/A'}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Amount:</span>
                                <span class="info-value">‚Çπ${details.price || 0}</span>
                            </div>
                        </div>
                    `;
                    break;
                case 'Car Booking':
                    detailsHtml += `
                        <div class="info-grid">
                            <div class="info-item">
                                <span class="info-label">Car Model:</span>
                                <span class="info-value">${details.car_model || 'N/A'}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Pickup:</span>
                                <span class="info-value">${details.pickup || 'N/A'}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Drop-off:</span>
                                <span class="info-value">${details.dropoff || 'N/A'}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Pickup Date:</span>
                                <span class="info-value">${details.pickup_date || 'N/A'}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Amount:</span>
                                <span class="info-value">‚Çπ${details.total_price || 0}</span>
                            </div>
                        </div>
                    `;
                    break;
                default:
                    detailsHtml += `<div class="mt-3"><pre class="details-json">${JSON.stringify(details, null, 2)}</pre></div>`;
            }
            
            $('#ticket-info').hide();
            $('#ticket-details').html(detailsHtml).show();
        }

        function resetTicketSelection() {
            currentSelectedRequest = null;
            $('#ticket-info').show();
            $('#ticket-details').hide().empty();
            $('#generate-ticket-btn').prop('disabled', true);
            $('#send-ticket-btn').prop('disabled', true);
            $('#download-ticket-btn').prop('disabled', true);
            $('.ticket-select').prop('checked', false);
        }

        function generateTicket() {
            if (!currentSelectedRequest) {
                showToast('No request selected', 'error');
                return;
            }
            
            $('#generate-ticket-btn').prop('disabled', true).html('<i class="material-icons spinner">autorenew</i> Generating...');
            
            $.ajax({
                url: '/admin/generate-ticket',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    request_id: currentSelectedRequest.id,
                    booking_id: currentSelectedRequest.bookingId,
                    service_type: currentSelectedRequest.serviceType,
                    user_id: currentSelectedRequest.userId
                }),
                success: function (data) {
                    if (data.success) {
                        showToast('PDF ticket generated successfully!', 'success');
                        $('#send-ticket-btn').prop('disabled', false);
                        $('#download-ticket-btn').prop('disabled', false);
                        $('#generate-ticket-btn').html('<i class="material-icons">picture_as_pdf</i> Regenerate PDF')
                            .prop('disabled', false)
                            .attr('onclick', 'generateTicket()');
                        currentSelectedRequest.ticket_url = data.ticket_url;
                        $(`tr[data-request-id="${currentSelectedRequest.id}"]`).addClass('ticket-generated');
                    } else {
                        showToast('Error: ' + (data.error || 'Failed to generate ticket'), 'error');
                        $('#generate-ticket-btn').html('<i class="material-icons">picture_as_pdf</i> Generate PDF')
                            .prop('disabled', false);
                    }
                },
                error: function (xhr, status, error) {
                    showToast('Error generating PDF ticket: ' + error, 'error');
                    $('#generate-ticket-btn').html('<i class="material-icons">picture_as_pdf</i> Generate PDF')
                        .prop('disabled', false);
                }
            });
        }

        function downloadSelectedTicket() {
            if (!currentSelectedRequest || !currentSelectedRequest.bookingId) {
                showToast('No ticket to download', 'error');
                return;
            }
            window.open(`/download-ticket/${currentSelectedRequest.bookingId}`, '_blank');
        }

        function sendTicketToUser() {
            if (!currentSelectedRequest) {
                showToast('No request selected', 'error');
                return;
            }
            
            if (!currentSelectedRequest.ticket_url) {
                showToast('Please generate PDF first', 'error');
                return;
            }
            
            $('#sendTicketModal').modal('show');
        }

        async function confirmSendTicket() {
            const sendDashboard = $('#send-ticket-dashboard').is(':checked');
            const sendEmail = $('#send-ticket-email').is(':checked');

            if (!sendDashboard && !sendEmail) {
                showToast('Please select at least one delivery method', 'error');
                return;
            }

            const confirmBtn = $('#sendTicketModal .btn-primary');
            const originalText = confirmBtn.text();
            confirmBtn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Sending...');

            try {
                const payload = {
                    request_id: currentSelectedRequest.id,
                    user_id: currentSelectedRequest.userId,
                    booking_id: currentSelectedRequest.bookingId
                };

                const promises = [];

                if (sendDashboard) {
                    promises.push(
                        $.ajax({
                            url: '/admin/send-ticket-dashboard',
                            method: 'POST',
                            contentType: 'application/json',
                            data: JSON.stringify(payload)
                        })
                    );
                }

                if (sendEmail) {
                    promises.push(
                        $.ajax({
                            url: '/admin/send-ticket-email',
                            method: 'POST',
                            contentType: 'application/json',
                            data: JSON.stringify(payload)
                        })
                    );
                }

                await Promise.all(promises);

                showToast('Ticket sent successfully!', 'success');
                $('#sendTicketModal').modal('hide');
                
                const sentToday = parseInt($('#sent-today').text()) || 0;
                $('#sent-today').text(sentToday + 1);

            } catch (error) {
                console.error("Send ticket error:", error);
                let errorMsg = 'Failed to send ticket';
                if (error.responseJSON && error.responseJSON.error) {
                    errorMsg = error.responseJSON.error;
                }
                showToast(errorMsg, 'error');
            } finally {
                confirmBtn.prop('disabled', false).text(originalText);
            }
        }

        function generateTicketFromModal() {
            if (!currentSelectedRequest) {
                showToast('No request selected', 'error');
                return;
            }
            
            $('#requestDetailsModal').modal('hide');
            setTimeout(() => {
                selectTicketForGeneration(currentSelectedRequest.id);
                generateTicket();
            }, 500);
        }

        // ========================
        // ANALYTICS FUNCTIONS
        // ========================
        function updateAnalytics() {
            const days = $('#analytics-date-range').val();
            $.get('/admin/analytics', { days: days }, function (data) {
                if (data && data.timeline) {
                    if (requestsTimelineChart) {
                        requestsTimelineChart.data.labels = data.timeline.labels;
                        requestsTimelineChart.data.datasets[0].data = data.timeline.data;
                        requestsTimelineChart.update();
                    }
                    
                    if (serviceDistributionChart && data.service_distribution) {
                        serviceDistributionChart.data.labels = data.service_distribution.labels;
                        serviceDistributionChart.data.datasets[0].data = data.service_distribution.data;
                        serviceDistributionChart.update();
                    }
                }
            }).fail(function () {
                console.log('Failed to load analytics');
            });
        }

        function updateCharts(data = null) {
            if (!data) {
                updateAnalytics();
                return;
            }
            
            if (requestsTimelineChart && data.timeline) {
                requestsTimelineChart.data.labels = data.timeline.labels;
                requestsTimelineChart.data.datasets[0].data = data.timeline.data;
                requestsTimelineChart.update();
            }
            
            if (serviceDistributionChart && data.service_distribution) {
                serviceDistributionChart.data.labels = data.service_distribution.labels;
                serviceDistributionChart.data.datasets[0].data = data.service_distribution.data;
                serviceDistributionChart.update();
            }
        }

        function setAnalyticsRefresh() {
            clearInterval(analyticsRefreshInterval);
            const interval = $('#analytics-refresh-interval').val();
            if (interval > 0) {
                analyticsRefreshInterval = setInterval(updateAnalytics, parseInt(interval));
            }
        }

        // ========================
        // UTILITY FUNCTIONS
        // ========================
        function updateAllStats(data = null) {
            if (!data) {
                $.get('/admin/stats', function (stats) {
                    updateStats(stats);
                });
                return;
            }
            updateStats(data);
        }

        function updateStats(data) {
            if (!data) return;
            if (data.total_users !== undefined) $('#total-users').text(data.total_users);
            if (data.total_requests !== undefined) $('#total-user-requests').text(data.total_requests);
            if (data.new_users_today !== undefined) $('#new-users-today').text(data.new_users_today);
            if (data.active_users_today !== undefined) $('#active-users-today').text(data.active_users_today);
            if (data.pending_requests !== undefined) $('#pending-requests').text(data.pending_requests);
            if (data.confirmed_requests !== undefined) $('#confirmed-requests').text(data.confirmed_requests);
            if (data.active_requests_today !== undefined) $('#active-requests').text(data.active_requests_today);
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <div class="toast-content">
                    <span class="toast-message">${message}</span>
                    <button class="toast-close" onclick="this.parentElement.parentElement.remove()">&times;</button>
                </div>
            `;
            document.getElementById('toast-container').appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.remove();
                }
            }, 5000);
        }

        // ========================
        // DASHBOARD NAVIGATION
        // ========================
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.style.display = sidebar.style.display === 'none' ? 'block' : 'none';
        }

        function showSection(sectionId) {
            document.querySelectorAll('.main-content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');
            
            if (sectionId === 'users-section') {
                refreshUsers();
            } else if (sectionId === 'requests-section') {
                refreshRequests();
            } else if (sectionId === 'tickets-section') {
                resetTicketSelection();
                searchTickets();
            } else if (sectionId === 'analytics-section') {
                updateAnalytics();
            } else if (sectionId === 'chat-section') {
                initAdminSupportChat();
            } else if (sectionId === 'reports-section') {
                loadReportUsers();
            }
        }

        function setActive(el) {
            document.querySelectorAll('.sidebar a').forEach(a => a.classList.remove('active'));
            el.classList.add('active');
        }

        function printFullDetails() {
            window.print();
        }

        // ========================
        // REPORT GENERATOR FUNCTIONS
        // ========================
        function loadReportUsers() {
            $.get('/admin/users', function(data) {
                if (data.users) {
                    const select = $('#report-user-select');
                    select.empty();
                    select.append('<option value="">Select a user...</option>');
                    data.users.forEach(user => {
                        select.append(`<option value="${user.id}">${user.full_name || user.username} (#${user.id})</option>`);
                    });
                }
            });
        }

        function generateAndSendUserReport() {
            const userId = $('#report-user-select').val();
            const sendDashboard = $('#send-report-dashboard').is(':checked');
            const sendEmail = $('#send-report-email').is(':checked');

            if (!userId) {
                showToast('Please select a user', 'error');
                return;
            }

            if (!sendDashboard && !sendEmail) {
                showToast('Please select at least one sending method', 'error');
                return;
            }

            const btn = $('button[onclick="generateAndSendUserReport()"]');
            const originalHtml = btn.html();
            btn.html('<i class="material-icons spinner">autorenew</i> Generating...').prop('disabled', true);

            const sendVia = [];
            if (sendDashboard) sendVia.push('dashboard');
            if (sendEmail) sendVia.push('email');

            $.ajax({
                url: '/api/admin/generate-user-report',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    user_id: userId,
                    send_via: sendVia
                }),
                success: function(response) {
                    if (response.success) {
                        showToast('Report generated and sent successfully!', 'success');
                        $('#report-status').html(`<div class="alert alert-success">Report sent! <a href="${response.report_url}" target="_blank">View Report</a></div>`);
                    } else {
                        showToast('Error: ' + response.error, 'error');
                        $('#report-status').html(`<div class="alert alert-danger">Error: ${response.error}</div>`);
                    }
                },
                error: function() {
                    showToast('Server error generating report', 'error');
                },
                complete: function() {
                    btn.html(originalHtml).prop('disabled', false);
                }
            });
        }

        function generateUserReport() {
            if (!currentSelectedUser) {
                showToast('No user selected', 'error');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            $.get(`/admin/user/${currentSelectedUser}`, function (userData) {
                doc.setFontSize(20);
                doc.setFont("helvetica", "bold");
                doc.text("CONCIERGE LIFESTYLE - USER REPORT", 105, 20, null, null, "center");
                doc.setFontSize(12);
                doc.setFont("helvetica", "normal");
                doc.text(`Generated: ${new Date().toLocaleDateString()}`, 105, 30, null, null, "center");
                
                doc.setFontSize(14);
                doc.setFont("helvetica", "bold");
                doc.text("User Information", 20, 45);
                doc.setFontSize(11);
                doc.setFont("helvetica", "normal");
                doc.text(`User ID: ${userData.id}`, 20, 55);
                doc.text(`Full Name: ${userData.full_name}`, 20, 62);
                doc.text(`Email: ${userData.email}`, 20, 69);
                doc.text(`Username: ${userData.username}`, 20, 76);
                doc.text(`Registration Date: ${userData.registration_date}`, 20, 83);
                doc.text(`Phone: ${userData.phone || 'Not provided'}`, 20, 90);
                doc.text(`Last Active: ${userData.last_active || 'Never'}`, 20, 97);
                
                doc.setFontSize(14);
                doc.setFont("helvetica", "bold");
                doc.text("Activity Summary", 20, 110);
                doc.setFontSize(11);
                doc.setFont("helvetica", "normal");
                doc.text(`Total Requests: ${userData.total_requests || 0}`, 20, 120);
                doc.text(`Confirmed Requests: ${userData.confirmed_requests || 0}`, 20, 127);
                doc.text(`Pending Requests: ${userData.pending_requests || 0}`, 20, 134);
                
                doc.setFontSize(10);
                doc.setFont("helvetica", "italic");
                doc.text("This is an official report from Concierge Lifestyle", 105, 150, null, null, "center");
                doc.save(`user_report_${userData.id}.pdf`);
                showToast('User report generated successfully!', 'success');
            }).fail(function () {
                showToast('Error generating user report', 'error');
            });
        }

        function sendReportToUser() {
            if (!currentSelectedUser) {
                showToast('No user selected', 'error');
                return;
            }
            
            if (confirm('Send this report to the user?')) {
                socket.emit('send_report_to_user', {
                    user_id: currentSelectedUser
                });
                showToast('Report sent to user successfully!', 'success');
            }
        }

        // ========================
        // BROADCAST FUNCTIONS
        // ========================
        function sendBroadcast() {
            const target = $('#broadcast-target').val();
            const userId = target === 'specific' ? $('#target-user-id').val() : null;
            const title = $('#broadcast-title').val();
            const message = $('#broadcast-message').val();
            const icon = $('#broadcast-icon').val() || 'notifications_active';
            const type = $('#broadcast-type').val();
            
            if (!title || !message) {
                showToast('Please enter title and message', 'error');
                return;
            }
            
            if (target === 'specific' && !userId) {
                showToast('Please enter User ID for specific user', 'error');
                return;
            }
            
            const broadcastData = {
                target: target,
                user_id: userId,
                title: title,
                message: message,
                icon: icon,
                type: type
            };
            
            socket.emit('send_broadcast', broadcastData);
            showToast('Notification sent successfully!', 'success');
            
            $('#broadcast-title').val('');
            $('#broadcast-message').val('');
            $('#target-user-id').val('');
        }

        function quickMessage(type) {
            let title = '';
            let message = '';
            let icon = 'notifications_active';
            let msgType = 'info';
            
            switch (type) {
                case 'update_profile':
                    title = 'Update Your Profile';
                    message = 'Please update your profile information including phone number and address.';
                    icon = 'person';
                    msgType = 'info';
                    break;
                case 'check_email':
                    title = 'Check Your Email';
                    message = 'Please check your registered email for important updates.';
                    icon = 'email';
                    msgType = 'info';
                    break;
                case 'name_change':
                    title = 'Name Change Required';
                    message = 'Please update your full name in the profile settings section.';
                    icon = 'edit';
                    msgType = 'warning';
                    break;
                case 'email_change':
                    title = 'Email Update Required';
                    message = 'Please update your email address in the profile settings.';
                    icon = 'mail';
                    msgType = 'warning';
                    break;
                case 'ticket_sent':
                    title = 'Ticket Sent';
                    message = 'Your PDF ticket has been sent to your email. Please check your inbox.';
                    icon = 'confirmation_number';
                    msgType = 'success';
                    break;
            }
            
            $('#broadcast-title').val(title);
            $('#broadcast-message').val(message);
            $('#broadcast-icon').val(icon);
            $('#broadcast-type').val(msgType);
        }

        function confirmLogout() {
            if (confirm('Are you sure you want to logout?')) {
                window.location.href = '/logout';
            }
        }

        // ========================
        // ADMIN SUPPORT CHAT FUNCTIONS
        // ========================
        function initAdminSupportChat() {
            console.log('üîß Initializing admin support chat...');

            if (supportUsersInterval) clearInterval(supportUsersInterval);

            loadSupportUsers();
            supportUsersInterval = setInterval(loadSupportUsers, 30000);
        }

        function loadSupportUsers() {
            $.get('/api/admin/support/users')
                .then(function (response) {
                    if (response.success) {
                        renderSupportUsers(response.users);
                    }
                })
                .catch(function (err) {
                    console.error('Error loading support users:', err);
                });
        }

        function renderSupportUsers(users) {
            const container = $('#support-users-list');

            if (!users || users.length === 0) {
                container.html(`
                    <div class="empty-state">
                        <i class="material-icons">group</i>
                        <p>No users have contacted support yet</p>
                    </div>
                `);
                return;
            }

            const onlineUsers = users.filter(u => u.status === 'online').length;
            $('#online-count').text(`${onlineUsers} online`);

            let html = '';
            users.forEach(function (user) {
                const isActive = currentSupportUser && currentSupportUser.id === user.id;
                const timeAgo = formatTimeAgo(user.last_message_at);
                const avatarUrl = user.profile_picture
                    ? `/static/uploads/profile_pictures/${user.profile_picture}`
                    : `https://ui-avatars.com/api/?name=${encodeURIComponent(user.name)}&size=50&background=d4af37&color=fff`;

                html += `
                    <div class="user-chat-item ${isActive ? 'active' : ''}" 
                         onclick="selectSupportUser(${user.id})"
                         data-user-id="${user.id}">
                        <div class="user-avatar">
                            <div class="avatar-img">
                                <img src="${avatarUrl}" 
                                     alt="${user.name}"
                                     onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(user.name)}&size=50&background=d4af37&color=fff'">
                            </div>
                            <div class="user-status ${user.status || 'offline'}"></div>
                        </div>
                        
                        <div class="user-info">
                            <div class="user-name-time">
                                <span class="user-name">${user.name}</span>
                                <span class="message-time">${timeAgo}</span>
                            </div>
                            <div class="user-message">
                                <span class="message-preview">${user.last_message || 'No messages yet'}</span>
                                ${user.unread_count > 0 ?
                                `<span class="unread-badge">${user.unread_count > 99 ? '99+' : user.unread_count}</span>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });

            container.html(html);
        }

        function selectSupportUser(userId) {
            $('.user-chat-item').removeClass('active');
            $(`.user-chat-item[data-user-id="${userId}"]`).addClass('active');

            const userItem = $(`.user-chat-item[data-user-id="${userId}"]`);
            if (userItem.length) {
                userItem.find('.unread-badge').remove();
            }

            $.get(`/api/admin/support/messages/${userId}`)
                .then(function (response) {
                    if (response.success) {
                        currentSupportUser = response.user;
                        renderChatHistory(response.user, response.messages);
                    }
                })
                .catch(function (err) {
                    console.error('Error loading chat:', err);
                    showToast('Error loading chat history', 'error');
                });
        }

        function renderChatHistory(user, messages) {
            $('#no-user-selected').hide();
            $('#chat-container').show();

            $('#current-user-name').text(user.name);

            const avatarUrl = user.profile_picture
                ? `/static/uploads/profile_pictures/${user.profile_picture}`
                : `https://ui-avatars.com/api/?name=${encodeURIComponent(user.name)}&size=50&background=d4af37&color=fff`;

            $('#current-user-img').attr('src', avatarUrl)
                .on('error', function () {
                    $(this).attr('src', `https://ui-avatars.com/api/?name=${encodeURIComponent(user.name)}&size=50&background=d4af37&color=fff`);
                });

            const input = $('#admin-chat-input');
            input.prop('disabled', false);
            input.focus();

            const container = $('#chat-messages');
            container.empty();

            if (!messages || messages.length === 0) {
                container.html(`
                    <div class="empty-state">
                        <p>No messages yet. Start the conversation!</p>
                    </div>
                `);
                return;
            }

            const groupedMessages = groupMessagesByDate(messages);

            Object.keys(groupedMessages).forEach(function (date) {
                if (date !== 'today') {
                    container.append(`
                        <div class="message-date-divider">
                            <span class="date-label">${date}</span>
                        </div>
                    `);
                }

                groupedMessages[date].forEach(function (msg) {
                    appendSupportMessage(msg, false);
                });
            });

            scrollToBottom();
        }

        function appendSupportMessage(msg, animate = true) {
            const container = $('#chat-messages');
            container.find('.empty-state').remove();

            const isAdmin = msg.sender_type === 'admin';
            const time = new Date(msg.timestamp).toLocaleTimeString([], {
                hour: '2-digit',
                minute: '2-digit'
            });

            let messageHtml = '';

            if (isAdmin) {
                messageHtml = `
                    <div class="message-bubble admin" ${animate ? 'style="animation: messageSlideIn 0.3s ease;"' : ''}>
                        <div class="bubble-content">
                            <div class="message-text">${escapeHtml(msg.message)}</div>
                            ${msg.file_path ? renderFileAttachment(msg.file_path) : ''}
                        </div>
                        <div class="message-time">
                            ${time}
                            <span class="message-status status-read">
                                <i class="material-icons">done_all</i>
                            </span>
                        </div>
                    </div>
                `;
            } else {
                messageHtml = `
                    <div class="message-bubble user" ${animate ? 'style="animation: messageSlideIn 0.3s ease;"' : ''}>
                        <div class="bubble-content">
                            <div class="message-text">${escapeHtml(msg.message)}</div>
                            ${msg.file_path ? renderFileAttachment(msg.file_path) : ''}
                        </div>
                        <div class="message-time">${time}</div>
                    </div>
                `;
            }

            container.append(messageHtml);
            scrollToBottom();
        }

        function renderFileAttachment(filePath) {
            const fileName = (filePath || '').split('/').pop();
            const fileExt = (fileName.split('.').pop() || '').toLowerCase();

            let safeUrl = filePath;
            if (!filePath.startsWith('/static') && !filePath.startsWith('http')) {
                safeUrl = `/static/uploads/support_files/${encodeURIComponent(fileName)}`;
            }
            
            const downloadUrl = safeUrl;

            if (['png', 'jpg', 'jpeg', 'gif'].includes(fileExt)) {
                return `
                    <div class="message-attachment attachment-image">
                        <a href="${safeUrl}" target="_blank" rel="noopener">
                            <img src="${safeUrl}" alt="${fileName}">
                        </a>
                        <div class="attachment-file">
                            <div class="file-icon"><i class="material-icons">image</i></div>
                            <div class="file-info">
                                <div class="file-name">${fileName}</div>
                                <div class="file-size">Click image to preview</div>
                            </div>
                            <a href="${downloadUrl}" download="${fileName}" class="file-download" title="Download">
                                <i class="material-icons">download</i>
                            </a>
                        </div>
                    </div>
                `;
            }

            let icon = 'description';
            if (fileExt === 'pdf') {
                icon = 'picture_as_pdf';
            } else if (['doc', 'docx'].includes(fileExt)) {
                icon = 'description';
            } else if (['mp3', 'wav'].includes(fileExt)) {
                icon = 'audiotrack';
            }

            return `
                <div class="message-attachment">
                    <a class="attachment-file" href="${downloadUrl}" download="${fileName}">
                        <div class="file-icon">
                            <i class="material-icons">${icon}</i>
                        </div>
                        <div class="file-info">
                            <div class="file-name">${fileName}</div>
                            <div class="file-size">Click to download</div>
                        </div>
                        <span class="file-download" aria-hidden="true">
                            <i class="material-icons">download</i>
                        </span>
                    </a>
                </div>
            `;
        }

        function sendAdminSupportMessage() {
            if (!currentSupportUser) {
                showToast('Please select a user to chat with', 'error');
                return;
            }

            const input = $('#admin-chat-input');
            const message = input.val().trim();

            if (!message) {
                showToast('Please enter a message', 'error');
                return;
            }

            const originalBtn = input.next('.input-actions').find('.send-btn').html();
            input.next('.input-actions').find('.send-btn').html('<i class="material-icons spinner">autorenew</i>');

            $.ajax({
                url: '/api/admin/support/send',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    user_id: currentSupportUser.id,
                    message: message,
                    message_type: 'text'
                }),
                success: function (response) {
                    if (response.success) {
                        appendSupportMessage(response.data);
                        input.val('');
                        autoResizeTextarea(input[0]);

                        socket.emit('admin_support_message', {
                            user_id: currentSupportUser.id,
                            message: message
                        });

                        loadSupportUsers();
                    } else {
                        showToast('Failed to send message: ' + response.error, 'error');
                    }
                },
                error: function (xhr) {
                    showToast('Connection error. Please try again.', 'error');
                },
                complete: function () {
                    input.next('.input-actions').find('.send-btn').html(originalBtn);
                }
            });
        }

        function openAdminFileInput(type = 'file') {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = type === 'image' ? 'image/*' : '*/*';

            input.onchange = function (e) {
                const file = e.target.files[0];
                if (file) {
                    uploadFileToUser(file);
                }
            };

            input.click();
        }

        function uploadFileToUser(file) {
            if (!currentSupportUser) {
                showToast('Please select a user first', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);
            formData.append('user_id', currentSupportUser.id);

            const sendBtn = $('.send-btn');
            const originalHtml = sendBtn.html();
            sendBtn.html('<i class="material-icons spinner">autorenew</i>');
            sendBtn.prop('disabled', true);

            $.ajax({
                url: '/api/admin/support/upload',
                method: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function (response) {
                    if (response.success) {
                        appendSupportMessage(response.data);

                        socket.emit('admin_support_file', {
                            user_id: currentSupportUser.id,
                            file_url: response.data.file_path,
                            file_name: file.name
                        });

                        showToast('File sent successfully', 'success');
                    } else {
                        showToast('Failed to upload file: ' + response.error, 'error');
                    }
                },
                error: function () {
                    showToast('Error uploading file', 'error');
                },
                complete: function () {
                    sendBtn.html(originalHtml);
                    sendBtn.prop('disabled', false);
                }
            });
        }

        function sendQuickReport() {
            if (!currentSupportUser) {
                showToast('Please select a user first', 'error');
                return;
            }

            const reportType = prompt('Enter report type (booking_history, invoice, summary):', 'booking_history');

            if (reportType) {
                $.ajax({
                    url: '/api/admin/support/send-report',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        user_id: currentSupportUser.id,
                        report_type: reportType
                    }),
                    success: function (response) {
                        if (response.success) {
                            showToast('Report sent successfully', 'success');
                        } else {
                            showToast('Failed to send report', 'error');
                        }
                    },
                    error: function () {
                        showToast('Error sending report', 'error');
                    }
                });
            }
        }

        function clearChatWithUser() {
            if (!currentSupportUser) {
                return;
            }

            if (confirm('Are you sure you want to clear chat with this user? This action cannot be undone.')) {
                $.ajax({
                    url: `/api/admin/support/clear-chat/${currentSupportUser.id}`,
                    method: 'DELETE',
                    success: function (response) {
                        if (response.success) {
                            $('#chat-messages').empty();
                            showToast('Chat cleared successfully', 'success');
                        }
                    },
                    error: function () {
                        showToast('Error clearing chat', 'error');
                    }
                });
            }
        }

        function callUser() {
            if (!currentSupportUser) {
                showToast('Please select a user first', 'error');
                return;
            }
            showToast('Call feature would be implemented here', 'info');
        }

        // ========================
        // UTILITY FUNCTIONS FOR CHAT
        // ========================
        function autoResizeTextarea(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = (textarea.scrollHeight) + 'px';
        }

        function handleAdminChatKeydown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendAdminSupportMessage();
            }
        }

        function scrollToBottom() {
            const container = document.getElementById('chat-messages');
            if (container) {
                container.scrollTop = container.scrollHeight;
            }
        }

        function formatTimeAgo(timestamp) {
            if (!timestamp) return 'Never';

            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / (1000 * 60));

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffMins < 1440) return `${Math.floor(diffMins / 60)}h ago`;
            return `${Math.floor(diffMins / 1440)}d ago`;
        }

        function groupMessagesByDate(messages) {
            const groups = {};

            messages.forEach(function (msg) {
                const date = new Date(msg.timestamp);
                const today = new Date();

                let dateKey;
                if (date.toDateString() === today.toDateString()) {
                    dateKey = 'today';
                } else if (date.getFullYear() === today.getFullYear() &&
                    date.getMonth() === today.getMonth() &&
                    date.getDate() === today.getDate() - 1) {
                    dateKey = 'Yesterday';
                } else {
                    dateKey = date.toLocaleDateString('en-US', {
                        weekday: 'long',
                        month: 'short',
                        day: 'numeric'
                    });
                }

                if (!groups[dateKey]) {
                    groups[dateKey] = [];
                }
                groups[dateKey].push(msg);
            });

            return groups;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function searchSupportUsers() {
            const searchTerm = $('#chat-search').val().toLowerCase();

            $('.user-chat-item').each(function () {
                const userName = $(this).find('.user-name').text().toLowerCase();
                const userMessage = $(this).find('.message-preview').text().toLowerCase();
                const userId = $(this).data('user-id').toString();

                if (userName.includes(searchTerm) ||
                    userMessage.includes(searchTerm) ||
                    userId.includes(searchTerm)) {
                    $(this).show();
                } else {
                    $(this).hide();
                }
            });
        }

        function updateUserUnreadCount(userId, increment) {
            const userItem = $(`.user-chat-item[data-user-id="${userId}"]`);
            if (userItem.length) {
                let badge = userItem.find('.unread-badge');
                if (badge.length) {
                    let count = parseInt(badge.text());
                    badge.text(increment ? (count + 1) : 0);
                } else if (increment) {
                    userItem.find('.user-message').append('<span class="unread-badge">1</span>');
                }
            }
        }

        function showAdminTypingIndicator() {
            const indicator = $('#typing-indicator');
            indicator.show();
            
            clearTimeout(adminTypingTimeout);
            adminTypingTimeout = setTimeout(() => {
                indicator.hide();
            }, 2000);
        }

        function toggleEmojiPicker() {
            showToast('Emoji picker would be implemented here', 'info');
        }

        function handleAdminFileUpload(input) {
            const file = input.files[0];
            if (file) {
                uploadFileToUser(file);
            }
        }
    </script>
</body>
</html>