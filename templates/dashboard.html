<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard - Concierge Lifestyle</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Cormorant+Garamond:wght@300;400;500;600;700&family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <!-- Date Picker -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css" rel="stylesheet">

  <!-- Map Library (Leaflet.js) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- WebSocket -->
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

  <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
</head>

<body>
  <!-- Hamburger Menu for Mobile -->
  <div class="hamburger" onclick="toggleSidebar()">
    <span></span>
    <span></span>
    <span></span>
  </div>

  <!-- Notification Bell Icon -->
  <div class="notification-bell" onclick="toggleNotifications()">
    <i class="material-icons">notifications</i>
    <span id="notification-count" class="notification-count" style="display: {{ 'block' if unread_count > 0 else 'none' }};">
      {{ unread_count if unread_count <= 99 else '99+' }} 
    </span>
  </div>

  <!-- Notification Dropdown -->
  <div id="notification-dropdown" class="notification-dropdown">
    <div class="notification-header">
      <h3>Notifications</h3>
      <div class="notification-actions">
        <button onclick="markAllAsRead()" title="Mark all as read">Mark all read</button>
        <button onclick="clearAllNotifications()" title="Clear all" class="clear-all-btn">Clear All</button>
      </div>
    </div>
    <div id="notification-list" class="notification-list">
      {% if notifications %}
        {% for notif in notifications %}
          <div class="notification-item {{ 'unread' if not notif.is_read else '' }} {{ notif.type or '' }}" data-id="{{ notif.id }}">
            <i class="material-icons">{{ notif.icon }}</i>
            <div class="notification-content">
              <p><strong>{{ notif.title }}</strong></p>
              <p>{{ notif.message }}</p>
              <span class="notification-time">{{ notif.time_ago }}</span>
            </div>
            <button class="delete-notification-btn" onclick="deleteNotification({{ notif.id }})" title="Delete">
              <i class="material-icons">close</i>
            </button>
          </div>
        {% endfor %}
      {% else %}
        <div class="notification-item empty">
          <div class="notification-content">
            <p>No notifications yet.</p>
          </div>
        </div>
      {% endif %}
    </div>
  </div>

  <div class="dashboard-container">
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
      <h2 class="logo">Concierge</h2>
      <ul class="sidebar-menu">
        <li><a href="javascript:void(0)" onclick="navigateToSection('welcome-section')" class="active">
          <i class="material-icons">home</i>
          <span>Home</span>
        </a></li>
        <li><a href="javascript:void(0)" onclick="navigateToSection('recommendations-section')">
          <i class="material-icons">star</i>
          <span>AI Suggestions</span>
        </a></li>
        <li><a href="javascript:void(0)" onclick="navigateToSection('requests-section')">
          <i class="material-icons">calendar_today</i>
          <span>My Requests</span>
        </a></li>
        <li><a href="javascript:void(0)" onclick="navigateToSection('services-section')">
          <i class="material-icons">business_center</i>
          <span>Services</span>
        </a></li>
         <li><a href="javascript:void(0)" onclick="navigateToSection('nearby-section')">
          <i class="material-icons">near_me</i>
          <span>Nearby</span>
        </a></li>
        <li><a href="javascript:void(0)" onclick="navigateToSection('contact-section')">
          <i class="material-icons">person</i>
          <span>My Profile</span>
        </a></li>
      </ul>

      <!-- Sidebar Footer with Logout -->
      <div class="sidebar-footer">
        <div class="user-location" id="sidebar-location">
          <i class="material-icons">location_on</i>
          <span id="location-text">Detecting location...</span>
        </div>
        <a href="/logout" class="logout-btn">
          <i class="material-icons">logout</i>
          <span>Logout</span>
        </a>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main">
      <!-- Welcome Section -->
      <div id="welcome-section" class="main-content-section active">
        <div class="welcome-wrapper">
          <div class="welcome-section">
            <h1 class="fade-in">Welcome back, {{ user }} üëã</h1>
            <p class="fade-in welcome-subtitle">Your personalized concierge experience awaits</p>

            <div class="quick-stats fade-in">
              <div class="stat-card">
                <i class="material-icons">event_available</i>
                <div class="stat-content">
                  <h3>{{ request_count or 0 }}</h3>
                  <p>Active Bookings</p>
                </div>
              </div>
              <div class="stat-card">
                <i class="material-icons">recommend</i>
                <div class="stat-content">
                  <h3 id="recommendation-count">0</h3>
                  <p>AI Suggestions</p>
                </div>
              </div>
              <div class="stat-card">
                <i class="material-icons">location_city</i>
                <div class="stat-content">
                  <h3 id="nearby-count">0</h3>
                  <p>Nearby Services</p>
                </div>
              </div>
            </div>

            <div class="quick-actions fade-in">
              <button class="quick-action-btn" onclick="navigateToSection('services-section')">
                <i class="material-icons">add_circle</i>
                Book a Service
              </button>
              <button class="quick-action-btn" onclick="navigateToSection('recommendations-section')">
                <i class="material-icons">lightbulb</i>
                View Suggestions
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- AI Recommendations Section -->
      <div id="recommendations-section" class="main-content-section">
        <div class="recommendations-container">
          <div class="section-header">
            <div>
              <h2>AI-Powered Recommendations</h2>
              <p class="section-subtitle">Personalized suggestions based on your lifestyle</p>
            </div>
            <button class="btn refresh-btn" onclick="refreshRecommendations()">
              <i class="material-icons">refresh</i> Refresh
            </button>
          </div>

          <!-- Lifestyle Profile Status -->
          <div class="lifestyle-status-card">
            <div class="status-icon">
              {% if has_lifestyle_profile %}
                <i class="material-icons">check_circle</i>
              {% else %}
                <i class="material-icons">error_outline</i>
              {% endif %}
            </div>
            <div class="status-content">
              {% if has_lifestyle_profile %}
                <h3>Lifestyle Profile Complete</h3>
                <p>Your AI recommendations are optimized based on your preferences</p>
                <button class="btn-secondary" onclick="window.location.href='/lifestyle_form'">
                  <i class="material-icons">edit</i> Update Profile
                </button>
              {% else %}
                <h3>Complete Your Lifestyle Profile</h3>
                <p>Help us personalize your experience with AI-powered recommendations</p>
                <a href="/lifestyle_form" class="btn-primary">
                  <i class="material-icons">psychology</i> Complete Profile
                </a>
              {% endif %}
            </div>
          </div>

          <!-- Recommendations Grid -->
          <div id="recommendations-grid" class="recommendations-grid">
            <div class="loading-state">
              <div class="spinner-large"></div>
              <p>Generating personalized recommendations...</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Nearby Services Section -->
      <div id="nearby-section" class="main-content-section">
        <div class="nearby-container">
          <div class="section-header">
            <div>
              <h2>Services Near You</h2>
              <p class="section-subtitle">Discover local options based on your location</p>
            </div>
            <div class="radius-control-wrapper">
              <div class="radius-control">
                <span>Radius:</span>
                <input type="range" id="radiusSlider" min="1" max="50" value="10" oninput="updateRadius(this.value)">
                <span id="radiusValue">10km</span>
              </div>
              <button class="btn refresh-btn" onclick="findNearbyServices()">
                <i class="material-icons">my_location</i> Update Location
              </button>
            </div>
          </div>

          <!-- Location Status -->
          <div class="location-card">
            <div class="location-icon">
              <i class="material-icons">location_on</i>
            </div>
            <div class="location-content">
              <h3 id="current-location-name">Detecting your location...</h3>
              <p id="current-location-coords"></p>
            </div>
            <button class="btn-icon" onclick="getUserLocation()" title="Refresh location">
              <i class="material-icons">refresh</i>
            </button>
          </div>

          <!-- Map Container -->
          <div id="map-container" class="map-container">
            <div id="map"></div>
          </div>

          <!-- Nearby Services List -->
          <div id="nearby-services-list" class="nearby-services-list">
            <div class="loading-state">
              <div class="spinner-large"></div>
              <p>Searching for nearby services...</p>
            </div>
          </div>
        </div>
      </div>

      <!-- My Requests Section -->
      <div id="requests-section" class="main-content-section">
        <div class="requests-container">
          <div class="section-header">
            <div>
              <h2>My Requests</h2>
              <p class="section-subtitle">Track all your bookings in one place</p>
            </div>
            <button class="btn refresh-btn" onclick="refreshRequests()">
              <i class="material-icons">refresh</i> Refresh
            </button>
          </div>

          <!-- Filters -->
          <div class="requests-filters">
            <div class="search-box">
              <i class="material-icons">search</i>
              <input type="text" id="requestSearch" placeholder="Search bookings..." onkeyup="filterRequests()">
            </div>
            <select id="serviceFilter" onchange="filterRequests()">
              <option value="all">All Services</option>
              <option value="Hotel Booking">Hotel</option>
              <option value="Flight Booking">Flight</option>
              <option value="Car Booking">Car</option>
              <option value="Technician Booking">Technician</option>
              <option value="Courier Booking">Courier</option>
            </select>
            <select id="statusFilter" onchange="filterRequests()">
              <option value="all">All Status</option>
              <option value="Confirmed">Confirmed</option>
              <option value="Pending">Pending</option>
            </select>
          </div>

          <div id="requests-table-container">
            {% if requests %}
              <div class="requests-table">
                <table>
                  <thead>
                    <tr>
                      <th>Booking ID</th>
                      <th>Service</th>
                      <th>Details</th>
                      <th>Payment Status</th>
                      <th>Admin Status</th>
                      <th>Action</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for request in requests %}
                      <tr data-request-id="{{ request.id }}">
                        <td><span class="booking-id">{{ request.booking_id }}</span></td>
                        <td><span class="service-badge">{{ request.service_type }}</span></td>
                        <td class="details-cell">
                          {% if request.service_type == 'Hotel Booking' %}
                            <div class="detail-item"><i class="material-icons">hotel</i> {{ request.details.hotel_name }}</div>
                            <div class="detail-item"><i class="material-icons">event</i> {{ request.details.checkin }} ‚Üí {{ request.details.checkout }}</div>
                            <div class="detail-item"><i class="material-icons">people</i> {{ request.details.rooms }} rooms, {{ request.details.guests }} guests</div>
                          {% elif request.service_type == 'Flight Booking' %}
                            <div class="detail-item"><i class="material-icons">flight</i> {{ request.details.airline or 'Flight' }}</div>
                            <div class="detail-item"><i class="material-icons">flight_takeoff</i> {{ request.details.origin or 'N/A' }} ‚Üí {{ request.details.destination or 'N/A' }}</div>
                            <div class="detail-item"><i class="material-icons">schedule</i> {{ request.details.departure_time or 'N/A' }}</div>
                          {% elif request.service_type == 'Car Booking' %}
                            <div class="detail-item"><i class="material-icons">directions_car</i> {{ request.details.cab_class or 'Standard' }}</div>
                            <div class="detail-item"><i class="material-icons">location_on</i> {{ request.details.pickup or 'N/A' }} ‚Üí {{ request.details.dropoff or 'N/A' }}</div>
                            <div class="detail-item"><i class="material-icons">schedule</i> {{ request.details.pickup_time or 'N/A' }}</div>
                          {% elif request.service_type == 'Courier Booking' %}
                            <div class="detail-item"><i class="material-icons">local_shipping</i> {{ request.details.courier_type or 'Standard' }}</div>
                            <div class="detail-item"><i class="material-icons">location_on</i> {{ request.details.pickup or 'N/A' }} ‚Üí {{ request.details.dropoff or 'N/A' }}</div>
                            <div class="detail-item"><i class="material-icons">scale</i> {{ request.details.package_weight_kg or 'N/A' }} kg</div>
                          {% elif request.service_type == 'Technician Booking' %}
                            <div class="detail-item"><i class="material-icons">build</i> {{ request.details.service_type or 'N/A' }}</div>
                            <div class="detail-item"><i class="material-icons">location_on</i> {{ request.details.location or 'N/A' }}</div>
                            <div class="detail-item"><i class="material-icons">event</i> {{ request.details.service_date or 'N/A' }} at {{ request.details.service_time or 'N/A' }}</div>
                          {% elif request.service_type == 'User Report' %}
                             <div class="detail-item"><i class="material-icons">assessment</i> Activity Report</div>
                             <div class="detail-item"><i class="material-icons">schedule</i> Generated: {{ request.created_at }}</div>
                          {% endif %}
                        </td>
                        <td>
                          <span class="status-badge {{ 'confirmed' if request.payment_status == 'Confirmed' or request.payment_status == 'Completed' else 'pending' }}">
                            {{ request.payment_status }}
                          </span>
                        </td>
                        <td>
                          <span class="admin-status">{{ request.admin_confirmation or 'Pending' }}</span>
                        </td>
                        <td>
                          {% if request.service_type == 'User Report' %}
                              <button class="btn-action success" onclick="downloadDocument('{{ request.details.report_url }}')">
                                <i class="material-icons">download</i> Download
                              </button>
                          {% elif request.payment_status == 'Confirmed' %}
                            {% if request.details and request.details.ticket_pdf_url %}
                              <button class="btn-action success" onclick="downloadDocument('{{ request.details.ticket_pdf_url }}')">
                                <i class="material-icons">download</i> Download
                              </button>
                            {% else %}
                              <button class="btn-action warning" onclick="requestTicket('{{ request.booking_id }}', '{{ request.service_type }}')">
                                <i class="material-icons">confirmation_number</i> Request
                              </button>
                            {% endif %}
                          {% else %}
                            <span class="no-action">Awaiting payment</span>
                          {% endif %}
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <div class="empty-state">
                <i class="material-icons">event_busy</i>
                <h3>No bookings yet</h3>
                <p>Book your first service to see it here</p>
                <button class="btn-primary" onclick="navigateToSection('services-section')">
                  Browse Services
                </button>
              </div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Services Section -->
      <div id="services-section" class="main-content-section">
        <div class="services-container">
          <div class="section-header">
            <div>
              <h2>Our Services</h2>
              <p class="section-subtitle">Book your perfect experience</p>
            </div>
          </div>

          <div class="card-grid">
            <div class="service-card" onclick="openModal('hotel')">
              <div class="service-icon">
                <i class="material-icons">hotel</i>
              </div>
              <h3>Hotel Booking</h3>
              <p>Luxury, budget, and boutique hotels worldwide</p>
              <span class="service-tag">Popular</span>
            </div>

            <div class="service-card" onclick="openModal('travel')">
              <div class="service-icon">
                <i class="material-icons">flight</i>
              </div>
              <h3>Flight Booking</h3>
              <p>Domestic and international flights with visa assistance</p>
              <span class="service-tag">Featured</span>
            </div>

            <div class="service-card" onclick="openModal('car')">
              <div class="service-icon">
                <i class="material-icons">directions_car</i>
              </div>
              <h3>Luxury Cabs</h3>
              <p>Premium vehicles: BMW, Audi, Mercedes, Limousine</p>
            </div>

            <div class="service-card" onclick="openModal('event')">
              <div class="service-icon">
                <i class="material-icons">build</i>
              </div>
              <h3>Handyman Services</h3>
              <p>AC repair, plumbing, electrical, and more</p>
            </div>

            <div class="service-card" onclick="openModal('courier')">
              <div class="service-icon">
                <i class="material-icons">local_shipping</i>
              </div>
              <h3>Courier & Delivery</h3>
              <p>Fast and reliable pickup and delivery services</p>
            </div>
          </div>
        </div>

        <!-- Modals for each service -->
        <!-- Hotel Booking Modal -->
        <div id="hotel-modal" class="modal">
          <div class="modal-content">
            <span class="close" onclick="closeModal('hotel')">&times;</span>
            <div class="modal-header">
              <i class="material-icons">hotel</i>
              <h2>Book Your Stay</h2>
            </div>
            <form action="{{ url_for('submit_hotel_booking') }}" method="POST" class="booking-form" onsubmit="return validateHotelForm(this)">
              <div class="field">
                <label><i class="material-icons">location_city</i> Destination</label>
                <input type="text" name="destination" placeholder="Enter City" required>
              </div>
              <div class="field-group">
                <div class="field">
                  <label><i class="material-icons">calendar_today</i> Check-In</label>
                  <input type="text" name="checkin" class="date-input" required>
                </div>
                <div class="field">
                  <label><i class="material-icons">calendar_today</i> Check-Out</label>
                  <input type="text" name="checkout" class="date-input" required>
                </div>
              </div>
              <div class="field-group">
                <div class="field">
                  <label><i class="material-icons">meeting_room</i> Rooms</label>
                  <div class="count-control">
                    <button type="button" onclick="updateCount('room', -1)">‚àí</button>
                    <input type="number" name="rooms" id="roomCount" value="1" min="1" readonly>
                    <button type="button" onclick="updateCount('room', 1)">+</button>
                  </div>
                </div>
                <div class="field">
                  <label><i class="material-icons">group</i> Guests</label>
                  <div class="count-control">
                    <button type="button" onclick="updateCount('guests', -1)">‚àí</button>
                    <input type="number" name="guests" id="guestCount" value="1" min="1" readonly>
                    <button type="button" onclick="updateCount('guests', 1)">+</button>
                  </div>
                </div>
              </div>
              <button type="submit" class="btn-submit" onclick="showLoading(this)">
                <i class="material-icons">search</i> Search Hotels
              </button>
            </form>
          </div>
        </div>

        <!-- Flight Booking Modal -->
        <div id="travel-modal" class="modal">
          <div class="modal-content">
            <span class="close" onclick="closeModal('travel')">&times;</span>
            <div class="modal-header">
              <i class="material-icons">flight</i>
              <h2>Book Your Flight</h2>
            </div>
            <form action="{{ url_for('submit_travel_booking') }}" method="POST">
              <div class="field-group">
                <div class="field">
                  <label><i class="material-icons">flight_takeoff</i> From</label>
                  <input type="text" name="origin" placeholder="Origin City" required>
                </div>
                <div class="field">
                  <label><i class="material-icons">flight_land</i> To</label>
                  <input type="text" name="destination" placeholder="Destination City" required>
                </div>
              </div>
              <div class="field-group">
                <div class="field">
                  <label><i class="material-icons">calendar_today</i> Departure</label>
                  <input type="text" name="departure_date" class="date-input" required>
                </div>
                <div class="field">
                  <label><i class="material-icons">calendar_today</i> Return</label>
                  <input type="text" name="return_date" class="date-input">
                </div>
              </div>
              <div class="field-group">
                <div class="field">
                  <label><i class="material-icons">person</i> Adults</label>
                  <div class="count-control">
                    <button type="button" onclick="updateCount('adults', -1)">‚àí</button>
                    <input type="number" name="adults" id="adultCount" value="1" min="1" readonly>
                    <button type="button" onclick="updateCount('adults', 1)">+</button>
                  </div>
                </div>
                <div class="field">
                  <label><i class="material-icons">child_care</i> Children</label>
                  <div class="count-control">
                    <button type="button" onclick="updateCount('children', -1)">‚àí</button>
                    <input type="number" name="children" id="childCount" value="0" min="0" readonly>
                    <button type="button" onclick="updateCount('children', 1)">+</button>
                  </div>
                </div>
              </div>
              <div class="field">
                <label><i class="material-icons">airline_seat_recline_normal</i> Class</label>
                <select name="class" class="select-input">
                  <option value="economy">Economy</option>
                  <option value="premium_economy">Premium Economy</option>
                  <option value="business">Business</option>
                  <option value="first">First Class</option>
                </select>
              </div>
              <button type="submit" class="btn-submit" onclick="showLoading(this)">
                <i class="material-icons">search</i> Search Flights
              </button>
            </form>
          </div>
        </div>

        <!-- Car Booking Modal -->
        <div id="car-modal" class="modal">
          <div class="modal-content">
            <span class="close" onclick="closeModal('car')">&times;</span>
            <div class="modal-header">
              <i class="material-icons">directions_car</i>
              <h2>Book Luxury Cab</h2>
            </div>
            <form action="{{ url_for('submit_car_booking') }}" method="POST">
              <div class="field">
                <label><i class="material-icons">my_location</i> Pickup Location</label>
                <input type="text" name="pickup" placeholder="Enter Pickup Location" required>
              </div>
              <div class="field">
                <label><i class="material-icons">location_on</i> Drop-off Location</label>
                <input type="text" name="dropoff" placeholder="Enter Drop-off Location" required>
              </div>
              <div class="field-group">
                <div class="field">
                  <label><i class="material-icons">calendar_today</i> Pickup Date</label>
                  <input type="text" name="pickup_date" class="date-input" required>
                </div>
                <div class="field">
                  <label><i class="material-icons">access_time</i> Pickup Time</label>
                  <input type="time" name="pickup_time" required>
                </div>
              </div>
              <div class="field-group">
                <div class="field">
                  <label><i class="material-icons">calendar_today</i> Return Date</label>
                  <input type="text" name="return_date" class="date-input">
                </div>
                <div class="field">
                  <label><i class="material-icons">access_time</i> Return Time</label>
                  <input type="time" name="return_time">
                </div>
              </div>
              <div class="field">
                <label><i class="material-icons">group</i> Passengers</label>
                <div class="count-control">
                  <button type="button" onclick="updateCount('passengers', -1)">‚àí</button>
                  <input type="number" name="passengers" id="passengerCount" value="1" min="1" max="9" readonly>
                  <button type="button" onclick="updateCount('passengers', 1)">+</button>
                </div>
              </div>
              <div class="field">
                <label><i class="material-icons">local_taxi</i> Cab Class</label>
                <select name="cab_class" class="select-input" required>
                  <option value="standard">Standard</option>
                  <option value="luxury">Luxury (BMW, Audi)</option>
                  <option value="suv">SUV</option>
                  <option value="limousine">Limousine</option>
                </select>
              </div>
              <div class="field">
                <label><i class="material-icons">note</i> Special Requests</label>
                <textarea name="special_requests" rows="2" placeholder="e.g., Child seat, Extra luggage"></textarea>
              </div>
              <button type="submit" class="btn-submit" onclick="showLoading(this)">
                <i class="material-icons">check</i> Book Cab
              </button>
            </form>
          </div>
        </div>

        <!-- Technician Modal -->
        <div id="event-modal" class="modal">
          <div class="modal-content">
            <span class="close" onclick="closeModal('event')">&times;</span>
            <div class="modal-header">
              <i class="material-icons">build</i>
              <h2>Book Technician</h2>
            </div>
            <form action="{{ url_for('submit_technician_booking') }}" method="POST">
              <input type="hidden" name="is_initial" value="true">
              <div class="field">
                <label><i class="material-icons">construction</i> Service Type</label>
                <select name="service_type" class="select-input" required>
                  <option value="" disabled selected>Select a service</option>
                  <option value="ac_repair">AC Repair</option>
                  <option value="plumbing">Plumbing</option>
                  <option value="electrical">Electrical</option>
                  <option value="carpentry">Carpentry</option>
                  <option value="other">Other</option>
                </select>
              </div>
              <div class="field">
                <label><i class="material-icons">location_on</i> Service Location</label>
                <input type="text" name="location" placeholder="Enter service address" required>
              </div>
              <div class="field-group">
                <div class="field">
                  <label><i class="material-icons">calendar_today</i> Preferred Date</label>
                  <input type="text" name="service_date" class="date-input" required>
                </div>
                <div class="field">
                  <label><i class="material-icons">access_time</i> Preferred Time</label>
                  <input type="time" name="service_time" required>
                </div>
              </div>
              <div class="field">
                <label><i class="material-icons">priority_high</i> Urgency</label>
                <select name="urgency" class="select-input" required>
                  <option value="normal">Normal (Within 24 hours)</option>
                  <option value="urgent">Urgent (Within 4 hours)</option>
                  <option value="emergency">Emergency (ASAP)</option>
                </select>
              </div>
              <div class="field">
                <label><i class="material-icons">description</i> Issue Description</label>
                <textarea name="description" rows="3" placeholder="Describe the issue in detail" required></textarea>
              </div>
              <button type="submit" class="btn-submit" onclick="showLoading(this)">
                <i class="material-icons">search</i> Find Technician
              </button>
            </form>
          </div>
        </div>

        <!-- Courier Modal -->
        <div id="courier-modal" class="modal">
          <div class="modal-content">
            <span class="close" onclick="closeModal('courier')">&times;</span>
            <div class="modal-header">
              <i class="material-icons">local_shipping</i>
              <h2>Courier & Delivery</h2>
            </div>
            <form action="{{ url_for('submit_courier_booking') }}" method="POST">
              <input type="hidden" name="is_initial" value="true">
              <div class="field">
                <label><i class="material-icons">my_location</i> Pickup Location</label>
                <input type="text" name="pickup" placeholder="Enter Pickup Location" required>
              </div>
              <div class="field">
                <label><i class="material-icons">location_on</i> Drop-off Location</label>
                <input type="text" name="dropoff" placeholder="Enter Drop-off Location" required>
              </div>
              <div class="field-group">
                <div class="field">
                  <label><i class="material-icons">calendar_today</i> Pickup Date</label>
                  <input type="text" name="pickup_date" class="date-input" required>
                </div>
                <div class="field">
                  <label><i class="material-icons">access_time</i> Pickup Time</label>
                  <input type="time" name="pickup_time" required>
                </div>
              </div>
              <div class="field">
                <label><i class="material-icons">speed</i> Courier Type</label>
                <select name="courier_type" class="select-input" required>
                  <option value="standard">Standard (1-2 days)</option>
                  <option value="express">Express (Same day)</option>
                  <option value="overnight">Overnight</option>
                </select>
              </div>
              <div class="field">
                <label><i class="material-icons">scale</i> Package Weight (kg)</label>
                <input type="number" name="package_weight" min="0.1" max="50" step="0.1" placeholder="e.g., 2.5" required>
              </div>
              <div class="field">
                <label><i class="material-icons">note</i> Special Requests</label>
                <textarea name="special_requests" rows="2" placeholder="e.g., Fragile item, Insured delivery"></textarea>
              </div>
              <button type="submit" class="btn-submit" onclick="showLoading(this)">
                <i class="material-icons">check</i> Book Courier
              </button>
            </form>
          </div>
        </div>
      </div>

      <!-- Contact Section -->
      <div id="contact-section" class="main-content-section">
        <div class="contact-container">
          <div class="section-header">
            <div>
              <h2>My Profile</h2>
              <p class="section-subtitle">Manage your personal concierge identity</p>
            </div>
          </div>

          <!-- Premium Profile Header -->
          <div class="premium-profile-header">
            <div class="header-bg-overlay"></div>
            <div class="profile-content">
              <div class="avatar-wrapper">
                <div class="avatar-circle">
                  {% if contact.profile_picture %}
                    <img id="profile-img-preview" src="{{ url_for('static', filename='uploads/profile_pictures/' + contact.profile_picture) }}" alt="Profile" class="profile-img" onerror="this.onerror=null; this.src='https://ui-avatars.com/api/?name={{ contact.name or user }}&background=0D0D0D&color=d4af37&size=200';">
                  {% else %}
                    <img id="profile-img-preview" src="https://ui-avatars.com/api/?name={{ contact.name or user }}&background=0D0D0D&color=d4af37&size=200" alt="Profile" class="profile-img">
                  {% endif %}
                  <div class="avatar-upload-overlay" onclick="document.getElementById('profile_picture_input').click()">
                    <i class="material-icons">camera_alt</i>
                    <span>Edit</span>
                  </div>
                </div>
                <input type="file" id="profile_picture_input" name="profile_picture" accept="image/*" style="display: none;" onchange="handleProfileUpload(this)">
              </div>

              <div class="profile-text">
                <h1 class="user-name">{{ contact.name or user }}</h1>
                <div class="user-meta">
                  <span class="meta-item"><i class="material-icons">email</i> {{ contact.email }}</span>
                  <span class="meta-item"><i class="material-icons">star</i> Premium Member</span>
                  <span class="meta-item verified"><i class="material-icons">verified</i> Verified</span>
                </div>
              </div>
            </div>

            <div class="profile-stats">
              <div class="stat-item">
                <span class="stat-value">{{ request_count or 0 }}</span>
                <span class="stat-label">Bookings</span>
              </div>
              <div class="stat-divider"></div>
              <div class="stat-item">
                <span class="stat-value">{{ unread_count or 0 }}</span>
                <span class="stat-label">Alerts</span>
              </div>
            </div>
          </div>

          <form action="{{ url_for('save_contact') }}" method="POST" class="premium-form">
            <h3 class="form-section-title"><i class="material-icons">person_outline</i> Personal Details</h3>
            <div class="form-grid">
              <div class="form-group floating-label">
                <input type="text" name="name" id="name" value="{{ contact.name or '' }}" required placeholder=" ">
                <label for="name">Full Name</label>
                <i class="material-icons field-icon">person</i>
              </div>
              <div class="form-group floating-label">
                <input type="text" name="phone" id="phone" value="{{ contact.phone or '' }}" required pattern="[0-9]{10}" placeholder=" ">
                <label for="phone">Phone Number</label>
                <i class="material-icons field-icon">phone</i>
              </div>
              <div class="form-group floating-label full-width">
                <input type="email" name="email" id="email" value="{{ contact.email or '' }}" required placeholder=" ">
                <label for="email">Email Address</label>
                <i class="material-icons field-icon">email</i>
              </div>
              <div class="form-group floating-label full-width">
                <input type="text" name="address" id="address" value="{{ contact.address or '' }}" placeholder=" ">
                <label for="address">Residential Address</label>
                <i class="material-icons field-icon">home</i>
              </div>
            </div>

            <h3 class="form-section-title mt-4"><i class="material-icons">share</i> Social & Contact</h3>
            <div class="form-grid">
              <div class="form-group floating-label">
                <input type="text" name="whatsapp" id="whatsapp" value="{{ contact.whatsapp or '' }}" placeholder=" ">
                <label for="whatsapp">WhatsApp</label>
                <i class="material-icons field-icon">chat</i>
              </div>
              <div class="form-group floating-label">
                <input type="text" name="instagram" id="instagram" value="{{ contact.instagram or '' }}" placeholder=" ">
                <label for="instagram">Instagram</label>
                <i class="material-icons field-icon">photo_camera</i>
              </div>
              <div class="form-group floating-label">
                <input type="text" name="facebook" id="facebook" value="{{ contact.facebook or '' }}" placeholder=" ">
                <label for="facebook">Facebook</label>
                <i class="material-icons field-icon">facebook</i>
              </div>
            </div>

            <div class="form-actions">
              <button type="submit" class="btn-submit premium-btn" onclick="showLoading(this)">
                <i class="material-icons">save</i> Save Changes
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div id="toast-container"></div>

  <!-- Flash Messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="flash-messages">
        {% for category, message in messages %}
          <div class="toast {{ category }}">
            <i class="material-icons">
              {% if category == 'success' %}check_circle
              {% elif category == 'error' or category == 'danger' %}error
              {% elif category == 'warning' %}warning
              {% else %}info{% endif %}
            </i>
            <span>{{ message }}</span>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <!-- AI Chatbot (Automated) -->
  <div class="chatbot-container" id="chatbot-container">
    <div class="chatbot-avatar" onclick="toggleChatbot()">
      <i class="material-icons">smart_toy</i>
      <div class="chatbot-notification" id="chatbot-notification" style="display: none;">1</div>
    </div>

    <div class="chatbot-window" id="chatbot-window">
      <div class="chatbot-header">
        <h3>
          <i class="material-icons">smart_toy</i>
          AI Assistant
        </h3>
        <button class="chatbot-close" onclick="toggleChatbot()">
          <i class="material-icons">close</i>
        </button>
      </div>

      <div class="chatbot-messages" id="chatbot-messages">
        <div class="chat-welcome">
          <i class="material-icons">psychology</i>
          <h4>Hello! I'm your AI assistant üëã</h4>
          <p>I can help you with hotels, flights, cabs, technicians, and more!</p>
          <div class="chat-quick-actions">
            <button class="chat-quick-action" onclick="handleQuickReply('hotels')">üè® Hotels</button>
            <button class="chat-quick-action" onclick="handleQuickReply('flights')">‚úàÔ∏è Flights</button>
            <button class="chat-quick-action" onclick="handleQuickReply('cabs')">üöó Cabs</button>
            <button class="chat-quick-action" onclick="handleQuickReply('technician')">üîß Technician</button>
            <button class="chat-quick-action" onclick="handleQuickReply('courier')">üì¶ Courier</button>
          </div>
          <div class="mt-4 text-center">
            <p class="text-muted small">Need human help?</p>
            <button class="btn btn-sm btn-outline-primary" onclick="openSupportChat()">
              <i class="material-icons" style="font-size: 14px;">support_agent</i> Chat with Support
            </button>
          </div>
        </div>
      </div>

      <div class="chatbot-input-container">
        <div class="chatbot-input-wrapper">
          <input type="text" class="chatbot-input" id="chatbot-input" placeholder="Ask AI something..." onkeypress="if(event.key === 'Enter') sendAIChatMessage()" />
          <button class="chatbot-send-btn" id="chatbot-send-btn" onclick="sendAIChatMessage()">
            <i class="material-icons">send</i>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Support Chat Trigger Button -->
  <div class="support-chat-trigger" onclick="toggleSupportChat()">
    <i class="material-icons">support_agent</i>
    <div class="support-chat-badge" id="support-chat-badge" style="display: none;">0</div>
  </div>

  <!-- Support Chat Modal -->
  <div id="support-chat-modal" class="support-chat-modal">
    <div class="support-chat-header">
      <div class="support-agent-info">
        <div class="agent-avatar">
          <img src="/static/images/admin-avatar.png" onerror="this.src='https://ui-avatars.com/api/?name=Support&background=d4af37&color=fff&size=200'">
          <span class="online-indicator"></span>
        </div>
        <div>
          <h4>Concierge Support</h4>
          <span>Online ‚Ä¢ 24/7</span>
        </div>
      </div>
      <button class="close-support-btn" onclick="closeSupportChat()">
        <i class="material-icons">close</i>
      </button>
    </div>

    <div class="support-chat-body" id="support-chat-body">
      <div class="support-chat-date">Today</div>
    </div>

    <div class="support-chat-footer">
      <input type="text" id="support-chat-input" placeholder="Type your message..." onkeypress="handleSupportInputKeypress(event)" oninput="handleSupportTyping()">
      <button class="file-btn" onclick="openSupportFileInput()" title="Attach file">
        <i class="material-icons">attach_file</i>
      </button>
      <button onclick="sendSupportMessage()" title="Send message">
        <i class="material-icons">send</i>
      </button>
    </div>
    <input type="file" id="support-file-input" style="display: none;" accept=".png,.jpg,.jpeg,.gif,.pdf,.doc,.docx,.txt" onchange="handleSupportFileUpload(this)">
  </div>

  <!-- Main JavaScript -->
  <script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>

  <script>
    // ============================================
    // CONCIERGE LIFESTYLE - DASHBOARD JAVASCRIPT
    // ============================================

    // Global variables
    let socket;
    const currentUserId = "{{ current_user_id }}" || null;
    let unreadNotifications = 0;
    let userLocation = null;
    let map = null;
    let userMarker = null;
    let chatbotOpen = false;
    let supportChatOpen = false;
    let currentActiveSection = 'welcome-section';
    let supportTypingTimeout = null;
    let supportMessagesLoaded = false;
    let radiusTimeout = null;

    // ============================================
    // INITIALIZATION
    // ============================================

    document.addEventListener('DOMContentLoaded', function () {
        console.log('üöÄ Dashboard initializing...');
        
        // Initialize all core components
        initDatePickers();
        initSidebar();
        initSocket();
        initNavigation();
        initSupportChat();

        // Start background services
        getUserLocation();

        // Load initial data
        fetchLifestyleRecommendations();
        fetchNearbyServices();

        // Set default active section
        setTimeout(() => {
            showSection('welcome-section');
        }, 100);

        // Auto-hide flash messages
        setTimeout(() => {
            document.querySelectorAll('.flash-messages .toast').forEach(toast => {
                toast.style.animation = 'slideOut 0.3s ease forwards';
                setTimeout(() => toast.remove(), 300);
            });
        }, 5000);

        // Initialize debug on F12
        document.addEventListener('keydown', function (e) {
            if (e.key === 'F12') {
                debugDashboard();
            }
        });

        // Periodically update support badge
        setInterval(updateSupportBadge, 30000);

        console.log('‚úÖ Dashboard JavaScript loaded successfully!');
    });

    // ============================================
    // NAVIGATION SYSTEM
    // ============================================

    function initNavigation() {
        console.log('üîÑ Initializing navigation...');

        // Set up event listeners for all navigation links
        document.querySelectorAll('.sidebar-menu a, .quick-action-btn').forEach(element => {
            element.addEventListener('click', function (e) {
                e.preventDefault();
                const onclick = this.getAttribute('onclick');
                if (onclick) {
                    const sectionMatch = onclick.match(/navigateToSection\('([^']+)'\)/);
                    if (sectionMatch && sectionMatch[1]) {
                        const sectionId = sectionMatch[1];
                        navigateToSection(sectionId);
                    }
                }
            });
        });

        console.log('‚úÖ Navigation initialized');
    }

    function navigateToSection(sectionId) {
        console.log(`üìç Navigating to: ${sectionId}`);

        // Update current active section
        currentActiveSection = sectionId;

        // Update active menu item
        updateActiveMenuItem(sectionId);

        // Show the section
        showSection(sectionId);
    }

    function updateActiveMenuItem(sectionId) {
        // Remove active class from all sidebar items
        document.querySelectorAll('.sidebar-menu a').forEach(item => {
            item.classList.remove('active');
        });

        // Add active class to the clicked item
        const targetItem = document.querySelector(`.sidebar-menu a[onclick*="${sectionId}"]`);
        if (targetItem) {
            targetItem.classList.add('active');
        }
    }

    function showSection(sectionId) {
        console.log(`üéØ Showing section: ${sectionId}`);

        // Hide all sections with smooth transition
        document.querySelectorAll('.main-content-section').forEach(section => {
            section.classList.remove('active');
            section.style.opacity = '0';
            section.style.pointerEvents = 'none';
        });

        // Show target section
        const targetSection = document.getElementById(sectionId);
        if (targetSection) {
            targetSection.classList.add('active');
            setTimeout(() => {
                targetSection.style.opacity = '1';
                targetSection.style.pointerEvents = 'all';
            }, 10);

            // Load section-specific content
            loadSectionContent(sectionId);

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        } else {
            console.error(`‚ùå Section not found: ${sectionId}`);
            showToast('Section not available', 'error');
        }
    }

    function loadSectionContent(sectionId) {
        console.log(`üì¶ Loading content for: ${sectionId}`);

        switch (sectionId) {
            case 'nearby-section':
                setTimeout(() => {
                    if (!map) initMap();
                    fetchNearbyServices();
                }, 100);
                break;

            case 'recommendations-section':
                fetchLifestyleRecommendations();
                break;

            case 'requests-section':
                filterRequests();
                break;

            case 'services-section':
                setTimeout(initDatePickers, 200);
                break;
        }
    }

    // ============================================
    // SIDEBAR FUNCTIONS
    // ============================================

    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const hamburger = document.querySelector('.hamburger');

        if (sidebar) {
            sidebar.classList.toggle('active');
            if (hamburger) {
                hamburger.classList.toggle('active');
            }
        }
    }

    function initSidebar() {
        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', function (event) {
            const sidebar = document.getElementById('sidebar');
            const hamburger = document.querySelector('.hamburger');

            if (window.innerWidth <= 768 && sidebar && hamburger) {
                if (!sidebar.contains(event.target) &&
                    !hamburger.contains(event.target) &&
                    sidebar.classList.contains('active')) {
                    sidebar.classList.remove('active');
                    hamburger.classList.remove('active');
                }
            }
        });
    }

    // ============================================
    // WEBSOCKET CONNECTION
    // ============================================

    function initSocket() {
        try {
            socket = io();

            socket.on('connect', () => {
                console.log('üîå Connected to server');
                if (currentUserId) {
                    socket.emit('user_connect', { user_id: currentUserId });
                }
            });

            socket.on('booking_confirmed', data => {
                showToast(data.message || 'Booking confirmed!', 'success');
                addNotification(
                    'Booking Confirmed',
                    data.message || 'Your booking has been confirmed',
                    'check_circle',
                    'success'
                );
            });

            socket.on('ticket_ready', data => {
                showToast('Your PDF ticket is ready for download!', 'success');
                addNotification(
                    'PDF Ticket Ready',
                    'Your ticket is now available. Click to download.',
                    'picture_as_pdf',
                    'info'
                );
            });

            socket.on('payment_confirmed', data => {
                showToast('Payment confirmed successfully!', 'success');
                addNotification(
                    'Payment Confirmed',
                    data.message || 'Your payment has been processed',
                    'payment',
                    'success'
                );
            });

            socket.on('recommendation_ready', data => {
                showToast('New AI recommendation available!', 'info');
                addNotification(
                    'AI Recommendation',
                    data.message || 'We have a new suggestion for you',
                    'lightbulb',
                    'recommendation'
                );
            });

            // Incoming chat messages
            socket.on('new_chat_message', data => {
                if (data.sender_id !== currentUserId) {
                    if (!chatbotOpen) {
                        const badge = document.getElementById('chatbot-notification');
                        if (badge) {
                            badge.style.display = 'flex';
                            badge.textContent = (parseInt(badge.textContent || '0') + 1).toString();
                        }
                    }
                    addAIChatMessage(data.message, 'bot');
                }
            });

            // Support chat messages
            socket.on('support_message_received', (data) => {
                console.log('üì© New support message:', data);

                // Ignore my own messages to prevent duplication (handled by API response)
                if (data.sender_type === 'user') return;

                // If chat is open, append message
                if (supportChatOpen) {
                    appendSupportMessage(data);
                } else {
                    // Show notification
                    showToast('New message from Support', 'info');
                    updateSupportBadge();
                }
            });

            // Support typing indicators
            socket.on('support_admin_typing', (data) => {
                if (supportChatOpen) {
                    showSupportTypingIndicator();
                }
            });

            // Support read confirmations
            socket.on('support_messages_read', (data) => {
                console.log('Messages marked as read');
            });

            // NEW: Real-time service price updates
            socket.on('service_price_update', (data) => {
                console.log('üí∞ Price update received:', data);
                if (data.fluctuations) {
                    Object.keys(data.fluctuations).forEach(service => {
                        const fluctuation = data.fluctuations[service];
                        if (Math.abs(fluctuation) > 0.05) {
                            // Only show toast for significant changes
                            const type = fluctuation > 0 ? 'Surge' : 'Price Drop';
                            const icon = fluctuation > 0 ? 'trending_up' : 'trending_down';
                            // showToast(`${service}: ${type} alert!`, 'info');
                        }
                    });
                    
                    // Update prices in the UI if visible
                    updateNearbyServicePrices(data.fluctuations);
                }
            });

            socket.on('disconnect', () => {
                console.log('‚ö†Ô∏è Disconnected from server');
            });

        } catch (error) {
            console.error('Socket error:', error);
        }
    }

    // ============================================
    // NOTIFICATION MANAGEMENT
    // ============================================

    function addNotification(title, message, icon = 'notifications', type = 'info') {
        const list = document.getElementById('notification-list');
        const empty = list.querySelector('.notification-item.empty');

        if (empty) {
            empty.remove();
        }

        const id = Date.now();
        const item = document.createElement('div');
        item.className = `notification-item unread ${type}`;
        item.dataset.id = id;
        item.innerHTML = `
        <i class="material-icons">${icon}</i>
        <div class="notification-content">
            <p><strong>${title}</strong></p>
            <p>${message}</p>
            <span class="notification-time">Just now</span>
        </div>
        <button class="delete-notification-btn" onclick="deleteNotification(${id})" title="Delete">
            <i class="material-icons">close</i>
        </button>
        `;

        list.insertBefore(item, list.firstChild);
        unreadNotifications++;
        updateNotificationCount();
    }

    function deleteNotification(id) {
        if (!confirm('Delete this notification?')) return;

        const item = document.querySelector(`.notification-item[data-id="${id}"]`);
        if (item) {
            item.style.animation = 'slideOut 0.3s ease forwards';
            setTimeout(() => {
                item.remove();
                if (item.classList.contains('unread')) {
                    unreadNotifications = Math.max(0, unreadNotifications - 1);
                    updateNotificationCount();
                }
                checkEmptyNotifications();
            }, 300);
        }
    }

    function checkEmptyNotifications() {
        const list = document.getElementById('notification-list');
        if (!list.children.length) {
            list.innerHTML = `
            <div class="notification-item empty">
                <div class="notification-content">
                    <p>No notifications yet.</p>
                </div>
            </div>
            `;
        }
    }

    function markAllAsRead() {
        fetch('/mark-notifications-read', { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    document.querySelectorAll('.notification-item.unread').forEach(item => {
                        item.classList.remove('unread');
                    });
                    unreadNotifications = 0;
                    updateNotificationCount();
                    showToast('All marked as read', 'success');
                }
            })
            .catch(error => {
                console.error('Error marking as read:', error);
                showToast('Failed to mark as read', 'error');
            });
    }

    function clearAllNotifications() {
        if (!confirm('Clear all notifications? This cannot be undone.')) return;

        fetch('/clear-all-notifications', { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    const list = document.getElementById('notification-list');
                    list.innerHTML = `
                    <div class="notification-item empty">
                        <div class="notification-content">
                            <p>No notifications yet.</p>
                        </div>
                    </div>
                    `;
                    unreadNotifications = 0;
                    updateNotificationCount();
                    showToast('All notifications cleared', 'success');
                }
            })
            .catch(error => {
                console.error('Error clearing notifications:', error);
                showToast('Failed to clear notifications', 'error');
            });
    }

    function toggleNotifications() {
        const dropdown = document.getElementById('notification-dropdown');
        const currentDisplay = dropdown.style.display || 'none';
        dropdown.style.display = currentDisplay === 'none' ? 'block' : 'none';

        if (dropdown.style.display === 'block') {
            refreshNotifications();
        }
    }

    function refreshNotifications() {
        fetch('/get-unread-count')
            .then(response => response.json())
            .then(data => {
                unreadNotifications = data.unread_count || 0;
                updateNotificationCount();
            })
            .catch(error => {
                console.error('Error fetching notifications:', error);
            });
    }

    function updateNotificationCount() {
        const countElement = document.getElementById('notification-count');
        if (unreadNotifications > 0) {
            countElement.style.display = 'block';
            countElement.textContent = unreadNotifications > 99 ? '99+' : unreadNotifications.toString();
        } else {
            countElement.style.display = 'none';
        }
    }

    // Close notification dropdown when clicking outside
    document.addEventListener('click', function (event) {
        const bell = document.querySelector('.notification-bell');
        const dropdown = document.getElementById('notification-dropdown');

        if (bell && dropdown && !bell.contains(event.target) && !dropdown.contains(event.target)) {
            dropdown.style.display = 'none';
        }
    });

    // ============================================
    // GEOLOCATION & MAP
    // ============================================

    function getUserLocation() {
        if (!navigator.geolocation) {
            updateLocationDisplay('Geolocation not supported');
            showToast('Geolocation not supported by your browser', 'warning');
            return;
        }

        updateLocationDisplay('Detecting location...');

        navigator.geolocation.getCurrentPosition(
            (position) => {
                userLocation = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
                console.log('üìç Location detected:', userLocation);
                reverseGeocode(userLocation.lat, userLocation.lng);

                // Update nearby services count
                fetchNearbyServices();
            },
            (error) => {
                console.error('Geolocation error:', error);
                let message = 'Location access denied';

                switch (error.code) {
                    case error.PERMISSION_DENIED:
                        message = 'Location access denied. Using default location.';
                        userLocation = { lat: 19.0760, lng: 72.8777 }; // Mumbai
                        break;
                    case error.POSITION_UNAVAILABLE:
                        message = 'Location information unavailable';
                        break;
                    case error.TIMEOUT:
                        message = 'Location request timeout';
                        break;
                }

                updateLocationDisplay(message);
                showToast(message, 'warning');
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            }
        );
    }

    async function reverseGeocode(lat, lng) {
        try {
            const response = await fetch(
                `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=10`
            );

            if (!response.ok) throw new Error('Geocoding failed');

            const data = await response.json();
            const city = data.address.city || data.address.town || data.address.village || 'Unknown';
            const state = data.address.state || '';
            const country = data.address.country || '';

            const locationString = `${city}${state ? ', ' + state : ''}`;
            updateLocationDisplay(locationString);

            // Save to backend
            saveUserLocation(city, state, country, lat, lng);

        } catch (error) {
            console.error('Reverse geocoding error:', error);
            updateLocationDisplay(`${lat.toFixed(4)}, ${lng.toFixed(4)}`);
        }
    }

    function updateLocationDisplay(text) {
        // Update all location elements
        ['location-text', 'current-location-name'].forEach(id => {
            const element = document.getElementById(id);
            if (element) element.textContent = text;
        });

        // Update coordinates if available
        const coordsElement = document.getElementById('current-location-coords');
        if (coordsElement && userLocation) {
            coordsElement.textContent = `${userLocation.lat.toFixed(4)}, ${userLocation.lng.toFixed(4)}`;
        }
    }

    async function saveUserLocation(city, state, country, lat, lng) {
        try {
            await fetch('/api/save-location', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    city, state, country,
                    latitude: lat,
                    longitude: lng
                })
            });
            console.log('üìç Location saved');
        } catch (error) {
            console.error('Error saving location:', error);
        }
    }

    function initMap() {
        if (!userLocation) {
            getUserLocation();
            return;
        }

        const mapElement = document.getElementById('map');
        if (!mapElement) {
            console.error('Map element not found');
            return;
        }

        // Remove existing map if present
        if (map) {
            map.remove();
        }

        // Initialize new map
        map = L.map('map').setView([userLocation.lat, userLocation.lng], 13);

        // Add tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);

        // Add user marker
        const customIcon = L.divIcon({
            className: 'custom-marker',
            html: '<div style="background: #d4af37; width: 30px; height: 30px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"></div>',
            iconSize: [30, 30],
            iconAnchor: [15, 15]
        });

        userMarker = L.marker([userLocation.lat, userLocation.lng], { icon: customIcon })
            .addTo(map)
            .bindPopup('<b>You are here</b>')
            .openPopup();

        // Add nearby services to map
        addServiceMarkersToMap([]); // Will be populated by fetchNearbyServices
    }

    function findNearbyServices() {
        if (!userLocation) {
            showToast('Detecting location...', 'info');
            getUserLocation();
            setTimeout(() => {
                if (userLocation) findNearbyServices();
            }, 2000);
            return;
        }

        // Show nearby section
        navigateToSection('nearby-section');

        // Initialize map if not already
        if (!map) {
            initMap();
        }

        showToast('Searching for nearby services...', 'info');
    }

    // ============================================
    // AI RECOMMENDATIONS
    // ============================================

    async function fetchLifestyleRecommendations() {
        const grid = document.getElementById('recommendations-grid');
        if (!grid) return;

        try {
            const response = await fetch('/api/lifestyle-recommendations');

            if (!response.ok) {
                throw new Error(`Server error: ${response.status}`);
            }

            const data = await response.json();

            if (data.success) {
                // Update recommendation count
                const countElement = document.getElementById('recommendation-count');
                if (countElement) {
                    countElement.textContent = data.recommendations?.length || 0;
                }

                if (data.recommendations && data.recommendations.length > 0) {
                    displayRecommendations(data.recommendations);
                } else if (data.has_profile === false) {
                    displayEmptyRecommendations();
                } else {
                    displayEmptyRecommendations('No recommendations available yet.');
                }
            } else {
                displayErrorRecommendations(data.message || 'Unable to generate recommendations.');
            }
        } catch (error) {
            console.error('Error fetching recommendations:', error);
            displayErrorRecommendations('Failed to load recommendations. Please try again.');
        }
    }

    function displayRecommendations(recommendations) {
        const grid = document.getElementById('recommendations-grid');
        if (!grid) return;

        grid.innerHTML = recommendations.map((rec, index) => `
        <div class="recommendation-card" style="animation: fadeInUp 0.5s ease ${index * 0.1}s forwards; opacity: 0;">
            <div class="recommendation-header">
                <i class="material-icons">${getServiceIcon(rec.service_type)}</i>
                <h3>${rec.service_type}</h3>
            </div>
            <div class="recommendation-score">
                ${rec.match_score || '95'}% Match
            </div>
            <p>${rec.reason || rec.description || 'Personalized recommendation based on your preferences'}</p>
            ${rec.metadata ? `
                <div class="recommendation-meta">
                    ${rec.metadata.price ? `<span><i class="material-icons">payments</i>${rec.metadata.price}</span>` : ''}
                    ${rec.metadata.price_reason ? `<span class="price-reason-badge"><i class="material-icons">trending_up</i>${rec.metadata.price_reason}</span>` : ''}
                    ${rec.metadata.duration ? `<span><i class="material-icons">schedule</i>${rec.metadata.duration}</span>` : ''}
                </div>
            ` : ''}
            <div class="recommendation-actions">
                <button class="btn-primary" onclick="bookRecommendedService('${rec.service_type.replace(/'/g, "\\'")}')">
                    <i class="material-icons">check</i> Book Now
                </button>
                <button class="btn-secondary" onclick="dismissRecommendation(${rec.id || index})">
                    <i class="material-icons">close</i> Dismiss
                </button>
            </div>
        </div>
        `).join('');
    }

    function displayEmptyRecommendations(message = 'Complete your profile to get personalized recommendations') {
        const grid = document.getElementById('recommendations-grid');
        if (!grid) return;

        grid.innerHTML = `
        <div class="empty-state" style="grid-column: 1 / -1;">
            <i class="material-icons">psychology</i>
            <h3>${message.includes('profile') ? 'Complete Your Profile' : 'No Recommendations'}</h3>
            <p>${message}</p>
            ${message.includes('profile') ?
                `<button class="btn-primary" onclick="window.location.href='/lifestyle_form'">
                    <i class="material-icons">edit</i> Complete Profile
                </button>` :
                `<button class="btn-primary" onclick="fetchLifestyleRecommendations()">
                    <i class="material-icons">refresh</i> Refresh
                </button>`
            }
        </div>
        `;
    }

    function displayErrorRecommendations(errorMessage) {
        const grid = document.getElementById('recommendations-grid');
        if (!grid) return;

        grid.innerHTML = `
        <div class="empty-state" style="grid-column: 1 / -1;">
            <i class="material-icons">error_outline</i>
            <h3>Unable to load recommendations</h3>
            <p>${errorMessage || 'Please try again later'}</p>
            <button class="btn-primary" onclick="fetchLifestyleRecommendations()">
                <i class="material-icons">refresh</i> Retry
            </button>
        </div>
        `;
    }

    function getServiceIcon(serviceType) {
        const icons = {
            'Hotel Booking': 'hotel',
            'Flight Booking': 'flight',
            'Car Booking': 'directions_car',
            'Luxury Cabs': 'directions_car',
            'Technician Booking': 'build',
            'Handyman Services': 'build',
            'Courier Booking': 'local_shipping',
            'Courier & Delivery': 'local_shipping'
        };
        return icons[serviceType] || 'business_center';
    }

    function bookRecommendedService(serviceType) {
        const locationText = document.getElementById('location-text')?.textContent || 'Mumbai';
        const city = locationText.split(',')[0].trim();

        let url = '';
        let params = new URLSearchParams();

        switch (serviceType) {
            case 'Hotel Booking':
                url = '/submit-hotel-booking';
                params.set('destination', city);
                params.set('checkin', getTomorrowDate());
                params.set('checkout', getDayAfterTomorrowDate());
                params.set('rooms', '1');
                params.set('guests', '2');
                break;
            case 'Flight Booking':
                url = '/submit-travel-booking';
                params.set('origin', city);
                params.set('destination', 'Delhi');
                params.set('departure_date', getIn7Days());
                params.set('adults', '1');
                break;
            case 'Car Booking':
            case 'Luxury Cabs':
                url = '/submit_car_booking';
                params.set('pickup', locationText);
                params.set('dropoff', `${city} Airport`);
                params.set('pickup_date', getTomorrowDate());
                params.set('pickup_time', '10:00');
                params.set('passengers', '2');
                params.set('cab_class', 'luxury');
                break;
            case 'Technician Booking':
            case 'Handyman Services':
                url = '/submit-technician-booking';
                params.set('location', locationText);
                params.set('service_date', getTomorrowDate());
                params.set('service_time', '14:00');
                params.set('service_type', 'ac_repair');
                params.set('urgency', 'normal');
                break;
            case 'Courier Booking':
            case 'Courier & Delivery':
                url = '/submit_courier_booking';
                params.set('pickup', locationText);
                params.set('dropoff', `${city} Downtown`);
                params.set('pickup_date', getTomorrowDate());
                params.set('pickup_time', '11:00');
                params.set('package_weight', '2.0');
                params.set('courier_type', 'express');
                break;
        }

        if (url) {
            window.location.href = `${url}?${params.toString()}`;
            showToast(`Finding best ${serviceType} options in ${city}...`, 'info');
        } else {
            showToast('Service coming soon!', 'warning');
        }
    }

    function getTomorrowDate() {
        const d = new Date();
        d.setDate(d.getDate() + 1);
        return d.toISOString().split('T')[0];
    }

    function getDayAfterTomorrowDate() {
        const d = new Date();
        d.setDate(d.getDate() + 2);
        return d.toISOString().split('T')[0];
    }

    function getIn7Days() {
        const d = new Date();
        d.setDate(d.getDate() + 7);
        return d.toISOString().split('T')[0];
    }

    async function dismissRecommendation(recommendationId) {
        if (!confirm('Dismiss this recommendation?')) return;

        try {
            const response = await fetch('/api/dismiss-recommendation', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ recommendation_id: recommendationId })
            });

            const data = await response.json();

            if (data.success) {
                showToast('Recommendation dismissed', 'success');
                fetchLifestyleRecommendations();
            } else {
                showToast('Failed to dismiss recommendation', 'error');
            }
        } catch (error) {
            console.error('Error dismissing recommendation:', error);
            showToast('Failed to dismiss recommendation', 'error');
        }
    }

    function refreshRecommendations() {
        const btn = document.querySelector('.recommendations-container .refresh-btn');
        if (btn) {
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<div class="spinner"></div> Refreshing...';
            btn.disabled = true;

            fetchLifestyleRecommendations();

            setTimeout(() => {
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }, 1000);
        }
    }

    // ============================================
    // REQUESTS MANAGEMENT
    // ============================================

    async function refreshRequests() {
        const container = document.getElementById('requests-table-container');
        const refreshBtn = document.querySelector('.requests-container .refresh-btn');

        if (refreshBtn) {
            const originalHTML = refreshBtn.innerHTML;
            refreshBtn.innerHTML = '<div class="spinner"></div> Refreshing...';
            refreshBtn.disabled = true;

            try {
                const response = await fetch('/user/requests');
                const data = await response.json();

                if (data.requests && data.requests.length > 0) {
                    window.location.reload();
                } else {
                    container.innerHTML = `
                    <div class="empty-state">
                        <i class="material-icons">event_busy</i>
                        <h3>No bookings yet</h3>
                        <p>Book your first service to see it here</p>
                        <button class="btn-primary" onclick="navigateToSection('services-section')">
                            Browse Services
                        </button>
                    </div>
                    `;
                }

                showToast('Requests refreshed', 'success');

            } catch (error) {
                console.error('Error refreshing requests:', error);
                showToast('Failed to refresh requests', 'error');
            } finally {
                setTimeout(() => {
                    refreshBtn.innerHTML = originalHTML;
                    refreshBtn.disabled = false;
                }, 1000);
            }
        }
    }

    function downloadDocument(url) {
        if (!url) {
            showToast('Document not available', 'error');
            return;
        }

        const link = document.createElement('a');
        link.href = url;
        link.download = url.split('/').pop() || 'document';
        link.target = '_blank';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        showToast('Downloading document...', 'success');
    }

    function requestTicket(bookingId, serviceType) {
        showToast('Requesting PDF ticket from admin...', 'info');

        if (socket && socket.connected) {
            socket.emit('request_ticket', {
                booking_id: bookingId,
                service_type: serviceType,
                user_id: currentUserId
            });

            setTimeout(() => {
                showToast('Ticket request sent! You will be notified when ready.', 'success');
            }, 1000);
        } else {
            fetch('/admin/send-ticket', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    booking_id: bookingId,
                    user_id: currentUserId
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('PDF ticket request sent to admin!', 'success');
                    } else {
                        showToast('Error: ' + (data.error || 'Unknown error'), 'error');
                    }
                })
                .catch(error => {
                    console.error('Error requesting ticket:', error);
                    showToast('Error requesting ticket', 'error');
                });
        }
    }

    function filterRequests() {
        const search = document.getElementById('requestSearch')?.value.toLowerCase() || '';
        const service = document.getElementById('serviceFilter')?.value || 'all';
        const status = document.getElementById('statusFilter')?.value || 'all';

        const rows = document.querySelectorAll('.requests-table tbody tr');

        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            const serviceType = row.querySelector('.service-badge')?.textContent.trim() || '';
            const statusBadge = row.querySelector('.status-badge')?.textContent.trim() || '';
            const adminStatus = row.querySelector('.admin-status')?.textContent.trim() || '';

            const matchesSearch = text.includes(search);
            const matchesService = service === 'all' || serviceType === service;
            const matchesStatus = status === 'all' || statusBadge === status || adminStatus === status;

            row.style.display = matchesSearch && matchesService && matchesStatus ? '' : 'none';
        });
    }

    // ============================================
    // MODAL MANAGEMENT
    // ============================================

    function openModal(id) {
        const modal = document.getElementById(id + '-modal');
        if (modal) {
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
            modal.style.opacity = '1';
            modal.style.zIndex = '9999';

            // Reinitialize date pickers
            setTimeout(() => {
                initDatePickers();
            }, 150);
        }
    }

    function closeModal(id) {
        const modal = document.getElementById(id + '-modal');
        if (modal) {
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }
    }

    // Close modal when clicking outside
    window.addEventListener('click', function (event) {
        if (event.target.classList.contains('modal')) {
            event.target.style.display = 'none';
            document.body.style.overflow = 'auto';
        }
    });

    // ============================================
    // FORM UTILITIES
    // ============================================

    function initDatePickers() {
        document.querySelectorAll('.date-input:not([data-fp-initialized])').forEach(function (input) {
            const today = new Date();
            const tomorrow = new Date();
            tomorrow.setDate(today.getDate() + 1);

            const todayFormatted = today.toISOString().split('T')[0];
            const tomorrowFormatted = tomorrow.toISOString().split('T')[0];

            const isCheckout = input.name === 'checkout' ||
                input.id === 'checkout' ||
                input.placeholder?.toLowerCase().includes('check-out');

            let defaultDate = todayFormatted;
            let minDate = "today";

            if (isCheckout) {
                defaultDate = tomorrowFormatted;
                minDate = tomorrowFormatted;
            }

            flatpickr(input, {
                altInput: true,
                altFormat: "F j, Y",
                dateFormat: "Y-m-d",
                minDate: minDate,
                defaultDate: defaultDate
            });

            input.setAttribute('data-fp-initialized', 'true');

            if (!input.value) {
                input.value = defaultDate;
            }
        });
    }

    function updateCount(field, change) {
        const inputId = {
            "room": "roomCount",
            "guests": "guestCount",
            "adults": "adultCount",
            "children": "childCount",
            "passengers": "passengerCount"
        }[field];

        const input = document.getElementById(inputId);
        if (!input) return;

        let current = parseInt(input.value) || 1;
        const min = parseInt(input.min) || 0;
        const max = parseInt(input.max) || Infinity;

        let newValue = current + change;
        newValue = Math.max(min, Math.min(max, newValue));

        input.value = newValue;
    }

    function showLoading(btn) {
        const originalHTML = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<div class="spinner"></div> Loading...';

        const form = btn.closest('form');
        if (form) {
            setTimeout(() => form.submit(), 100);
        }

        return false;
    }

    function validateHotelForm(form) {
        const destination = form.querySelector('input[name="destination"]');
        const checkin = form.querySelector('input[name="checkin"]');
        const checkout = form.querySelector('input[name="checkout"]');

        if (!destination || !destination.value.trim()) {
            showToast('Please enter destination city', 'error');
            destination?.focus();
            return false;
        }

        if (!checkin || !checkin.value) {
            showToast('Please select check-in date', 'error');
            checkin?.focus();
            return false;
        }

        if (!checkout || !checkout.value) {
            showToast('Please select check-out date', 'error');
            checkout?.focus();
            return false;
        }

        const checkinDate = new Date(checkin.value);
        const checkoutDate = new Date(checkout.value);

        if (checkoutDate <= checkinDate) {
            showToast('Check-out date must be after check-in date', 'error');
            checkout?.focus();
            return false;
        }

        const submitBtn = form.querySelector('button[type="submit"]');
        if (submitBtn) {
            showLoading(submitBtn);
        }

        return false;
    }

    // ============================================
    // TOAST NOTIFICATIONS
    // ============================================

    function showToast(message, type = 'success') {
        const container = document.getElementById('toast-container');
        if (!container) return;

        const toast = document.createElement('div');
        toast.className = `toast ${type}`;

        const icon = {
            success: 'check_circle',
            error: 'error',
            warning: 'warning',
            info: 'info'
        }[type] || 'notifications';

        toast.innerHTML = `
        <i class="material-icons">${icon}</i>
        <span>${message}</span>
        `;

        container.appendChild(toast);

        // Auto-remove after 4 seconds
        setTimeout(() => {
            toast.style.animation = 'slideOut 0.3s ease forwards';
            setTimeout(() => toast.remove(), 300);
        }, 4000);
    }

    // ============================================
    // NEARBY SERVICES
    // ============================================

    async function fetchNearbyServices(radius = 10) {
        if (!userLocation) {
            console.warn('User location not set');
            getUserLocation();
            return;
        }

        const listElement = document.getElementById('nearby-services-list');
        if (!listElement) return;

        listElement.innerHTML = `
        <div class="loading-state">
            <div class="spinner-large"></div>
            <p>Scanning within ${radius}km...</p>
        </div>
        `;

        try {
            const payload = {
                lat: userLocation.lat,
                lng: userLocation.lng,
                radius: radius
            };

            const response = await fetch('/api/nearby-services', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();

            if (!data.success) {
                throw new Error(data.message || 'Failed to load services');
            }

            // Update count
            const countElement = document.getElementById('nearby-count');
            if (countElement && data.services) {
                countElement.textContent = data.services.length;
            }

            if (data.services && data.services.length > 0) {
                displayNearbyServices(data.services);
                addServiceMarkersToMap(data.services);
            } else {
                displayEmptyNearbyServices();
            }
        } catch (error) {
            console.error('Error fetching nearby services:', error);
            displayErrorNearbyServices(error.message);
        }
    }

    function displayNearbyServices(services) {
        const listElement = document.getElementById('nearby-services-list');
        if (!listElement) return;

        listElement.innerHTML = services.map((service, index) => `
        <div class="nearby-service-card" data-service-type="${service.type}" style="animation: fadeInUp 0.5s ease ${index * 0.1}s forwards; opacity: 0;">
            <div class="service-distance">
                <i class="material-icons">near_me</i>
                ${service.distance} km away
            </div>
            <div class="recommendation-header">
                <i class="material-icons">${getServiceIcon(service.type)}</i>
                <h3>${service.name}</h3>
            </div>
            <p>${service.description}</p>
            ${service.address ? `<p class="service-address"><i class="material-icons">location_on</i>${service.address}</p>` : ''}
            ${service.rating ? `
                <div class="recommendation-meta">
                    <span><i class="material-icons">star</i>${service.rating}/5</span>
                    ${service.price ? `<span class="service-price-tag"><i class="material-icons">payments</i>${service.price}</span>` : ''}
                </div>
            ` : ''}
            <div class="recommendation-actions">
                <button class="btn-primary" onclick="bookNearbyService('${service.type.replace(/'/g, "\\'")}', '${service.name.replace(/'/g, "\\'")}')">
                    <i class="material-icons">event</i> Book Now
                </button>
                <button class="btn-secondary" onclick="showOnMap(${service.lat}, ${service.lng}, '${service.name.replace(/'/g, "\\'")}')">
                    <i class="material-icons">location_on</i> Show on Map
                </button>
            </div>
        </div>
        `).join('');
    }

    function updateNearbyServicePrices(fluctuations) {
        document.querySelectorAll('.nearby-service-card').forEach(card => {
            const type = card.dataset.serviceType;
            const fluctuation = fluctuations[type];
            if (fluctuation) {
                const priceTag = card.querySelector('.service-price-tag');
                if (priceTag) {
                    // Visual feedback for price change
                    if (fluctuation > 0.05) {
                        priceTag.style.color = '#e74c3c'; // Red for surge
                        priceTag.classList.add('surge-pulse');
                    } else if (fluctuation < -0.05) {
                        priceTag.style.color = '#2ecc71'; // Green for drop
                        priceTag.classList.add('drop-pulse');
                    }
                    
                    // Simple animation for the update
                    priceTag.style.transition = 'all 0.5s ease';
                    priceTag.style.transform = 'scale(1.1)';
                    setTimeout(() => {
                        priceTag.style.transform = 'scale(1)';
                    }, 500);
                }
            }
        });
    }

    function displayEmptyNearbyServices() {
        const listElement = document.getElementById('nearby-services-list');
        if (!listElement) return;

        listElement.innerHTML = `
        <div class="empty-state" style="grid-column: 1 / -1;">
            <i class="material-icons">location_off</i>
            <h3>No nearby services found</h3>
            <p>We couldn't find any services in your area</p>
            <button class="btn-primary" onclick="getUserLocation(); setTimeout(fetchNearbyServices, 1000);">
                <i class="material-icons">refresh</i> Retry
            </button>
        </div>
        `;
    }

    function displayErrorNearbyServices(errorMessage) {
        const listElement = document.getElementById('nearby-services-list');
        if (!listElement) return;

        listElement.innerHTML = `
        <div class="empty-state" style="grid-column: 1 / -1;">
            <i class="material-icons">error_outline</i>
            <h3>Unable to load nearby services</h3>
            <p>${errorMessage || 'Please try again later'}</p>
            <button class="btn-primary" onclick="fetchNearbyServices()">
                <i class="material-icons">refresh</i> Retry
            </button>
        </div>
        `;
    }

    function addServiceMarkersToMap(services) {
        if (!map || !services.length) return;

        // Clear existing service markers
        map.eachLayer(layer => {
            if (layer instanceof L.Marker && layer !== userMarker) {
                map.removeLayer(layer);
            }
        });

        // Add new markers
        services.forEach(service => {
            const iconColor = {
                'Hotel Booking': '#27ae60',
                'Car Booking': '#3498db',
                'Technician Booking': '#e67e22',
                'Courier Booking': '#1abc9c'
            }[service.type] || '#9b59b6';

            const serviceIcon = L.divIcon({
                className: 'service-marker',
                html: `<div style="background: ${iconColor}; width: 32px; height: 32px; border-radius: 50% 50% 50% 0; transform: rotate(-45deg); border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center;">
                    <i class="material-icons" style="transform: rotate(45deg); color: white; font-size: 16px;">${getServiceIcon(service.type)}</i>
                </div>`,
                iconSize: [32, 32],
                iconAnchor: [16, 32],
                popupAnchor: [0, -32]
            });

            L.marker([service.lat, service.lng], { icon: serviceIcon })
                .addTo(map)
                .bindPopup(`
                <div style="text-align: center; min-width: 200px;">
                    <b>${service.name}</b><br>
                    <span style="color: #666;">${service.type}</span><br>
                    <span style="color: #3498db; font-weight: bold;">${service.distance} km away</span><br>
                    ${service.rating ? `<span style="color: #f39c12;">‚òÖ ${service.rating}/5</span><br>` : ''}
                    ${service.price ? `<span style="color: #27ae60;">${service.price}</span>` : ''}
                </div>
                `);
        });

        // Fit map to show all markers
        const bounds = L.latLngBounds(
            services.map(s => [s.lat, s.lng]).concat([[userLocation.lat, userLocation.lng]])
        );
        map.fitBounds(bounds, { padding: [50, 50] });
    }

    function showOnMap(lat, lng, serviceName) {
        if (!map) {
            showToast('Map not available', 'error');
            return;
        }

        map.setView([lat, lng], 16);
        showToast(`Showing ${serviceName} on map`, 'info');
    }

    function bookNearbyService(serviceType, serviceName) {
        const locationText = document.getElementById('location-text')?.textContent || 'Mumbai';
        const city = locationText.split(',')[0].trim();

        let url = '';
        let params = new URLSearchParams();

        switch (serviceType) {
            case 'Hotel Booking':
                url = '/submit-hotel-booking';
                params.set('destination', city);
                params.set('checkin', getTomorrowDate());
                params.set('checkout', getDayAfterTomorrowDate());
                params.set('rooms', '1');
                params.set('guests', '2');
                break;
            case 'Flight Booking':
                url = '/submit-travel-booking';
                params.set('origin', city);
                params.set('destination', 'Delhi');
                params.set('departure_date', getIn7Days());
                params.set('adults', '1');
                break;
            case 'Car Booking':
                url = '/submit_car_booking';
                params.set('pickup', locationText);
                params.set('dropoff', `${city} Airport`);
                params.set('pickup_date', getTomorrowDate());
                params.set('pickup_time', '10:00');
                params.set('passengers', '2');
                params.set('cab_class', 'standard');
                break;
            case 'Technician Booking':
                url = '/submit-technician-booking';
                params.set('location', locationText);
                params.set('service_date', getTomorrowDate());
                params.set('service_time', '14:00');
                params.set('service_type', 'ac_repair');
                params.set('urgency', 'normal');
                break;
            case 'Courier Booking':
                url = '/submit_courier_booking';
                params.set('pickup', locationText);
                params.set('dropoff', `${city} Downtown`);
                params.set('pickup_date', getTomorrowDate());
                params.set('pickup_time', '11:00');
                params.set('package_weight', '2.0');
                params.set('courier_type', 'express');
                break;
        }

        if (url) {
            window.location.href = `${url}?${params.toString()}`;
            showToast(`Finding best ${serviceType}: ${serviceName} in ${city}...`, 'info');
        } else {
            showToast('Service coming soon!', 'warning');
        }
    }

    function updateRadius(val) {
        document.getElementById('radiusValue').textContent = val + 'km';

        if (radiusTimeout) clearTimeout(radiusTimeout);
        radiusTimeout = setTimeout(() => {
            fetchNearbyServices(parseInt(val));
        }, 300);
    }

    // ============================================
    // AI CHATBOT FUNCTIONS
    // ============================================

    function toggleChatbot() {
        chatbotOpen = !chatbotOpen;
        const window = document.getElementById('chatbot-window');
        const badge = document.getElementById('chatbot-notification');

        if (chatbotOpen) {
            window.classList.add('active');
            document.getElementById('chatbot-input').focus();
            if (badge) badge.style.display = 'none';
        } else {
            window.classList.remove('active');
        }
    }

    function sendAIChatMessage() {
        const input = document.getElementById('chatbot-input');
        const message = input.value.trim();
        if (!message) return;

        addAIChatMessage(message, 'user');
        input.value = '';

        // Call AI Endpoint
        fetch('/api/chatbot', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: message })
        })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    addAIChatMessage(data.response, 'bot');
                    // Handle quick replies if any
                    if (data.quick_replies) {
                        const container = document.getElementById('chatbot-messages');
                        const actionsDiv = document.createElement('div');
                        actionsDiv.className = 'chat-quick-actions';
                        data.quick_replies.forEach(qr => {
                            actionsDiv.innerHTML += `<button class="chat-quick-action" onclick="handleQuickReply('${qr.payload}')">${qr.title}</button>`;
                        });
                        container.appendChild(actionsDiv);
                        container.scrollTop = container.scrollHeight;
                    }
                }
            })
            .catch(err => console.error('AI Error:', err));
    }

    function addAIChatMessage(text, type) {
        const container = document.getElementById('chatbot-messages');
        const div = document.createElement('div');
        div.className = `chat-message ${type === 'user' ? 'user' : 'bot'}`;

        div.innerHTML = `
        <div class="message-avatar">
            <i class="material-icons">${type === 'user' ? 'person' : 'smart_toy'}</i>
        </div>
        <div class="message-content">${text}</div>
        `;

        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
    }

    function handleQuickReply(payload) {
        let message = '';
        let modalId = '';

        switch (payload) {
            case 'hotels':
                message = 'Hotels';
                modalId = 'hotel';
                break;
            case 'flights':
                message = 'Flights';
                modalId = 'travel';
                break;
            case 'cabs':
                message = 'Cabs';
                modalId = 'car';
                break;
            case 'technician':
                message = 'Technician';
                modalId = 'event';
                break;
            case 'courier':
                message = 'Courier';
                modalId = 'courier';
                break;
            default:
                message = payload.replace(/_/g, ' ');
        }

        addAIChatMessage(message, 'user');

        if (modalId) {
            navigateToSection('services-section');
            setTimeout(() => {
                openModal(modalId);
            }, 300);
        }
    }

    // ============================================
    // SUPPORT CHAT FUNCTIONS
    // ============================================

    function initSupportChat() {
        console.log('üîß Initializing support chat...');

        // Update badge count
        updateSupportBadge();
    }

    function updateSupportBadge() {
        const badge = document.getElementById('support-chat-badge');
        fetch('/api/support/chat/history')
            .then(r => r.json())
            .then(data => {
                if (data.success && data.unread_count > 0) {
                    badge.style.display = 'flex';
                    badge.textContent = data.unread_count > 99 ? '99+' : data.unread_count;
                } else {
                    badge.style.display = 'none';
                }
            })
            .catch(err => console.error('Error updating support badge:', err));
    }

    function toggleSupportChat() {
        const modal = document.getElementById('support-chat-modal');
        const badge = document.getElementById('support-chat-badge');

        if (!supportChatOpen) {
            // Open chat
            modal.style.display = 'flex';
            supportChatOpen = true;

            // Load messages if not loaded
            if (!supportMessagesLoaded) {
                loadSupportMessages();
                supportMessagesLoaded = true;
            }

            // Mark messages as read
            markSupportMessagesRead();

            // Focus input
            setTimeout(() => {
                document.getElementById('support-chat-input').focus();
            }, 100);

            // Hide badge
            badge.style.display = 'none';
        } else {
            closeSupportChat();
        }
    }

    function openSupportChat() {
        // Close chatbot if open
        if (chatbotOpen) {
            toggleChatbot();
        }

        // Open support chat
        toggleSupportChat();
    }

    function closeSupportChat() {
        const modal = document.getElementById('support-chat-modal');
        modal.style.display = 'none';
        supportChatOpen = false;

        // Stop typing indicator
        clearSupportTypingIndicator();
    }

    function loadSupportMessages() {
        const body = document.getElementById('support-chat-body');

        // Show loading
        body.innerHTML = '<div class="loading-state"><div class="spinner"></div><p>Loading messages...</p></div>';

        fetch('/api/support/chat/history')
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    renderSupportMessages(data.messages);
                } else {
                    body.innerHTML = '<div class="empty-state">Failed to load messages</div>';
                }
            })
            .catch(err => {
                console.error('Error loading messages:', err);
                body.innerHTML = '<div class="empty-state">Connection error</div>';
            });
    }

    function renderSupportMessages(messages) {
        const body = document.getElementById('support-chat-body');
        body.innerHTML = '<div class="support-chat-date">Today</div>';

        if (!messages || messages.length === 0) {
            // Welcome message
            const welcomeMsg = {
                sender_type: 'admin',
                message: 'Hello! üëã How can we help you today? Our support team is available 24/7.',
                timestamp: new Date().toISOString(),
                is_me: false
            };
            appendSupportMessage(welcomeMsg);
            return;
        }

        // Group messages by date
        const today = new Date().toDateString();
        let currentDate = '';

        messages.forEach(msg => {
            const msgDate = new Date(msg.timestamp).toDateString();

            if (msgDate !== currentDate) {
                currentDate = msgDate;
                const dateDiv = document.createElement('div');
                dateDiv.className = 'support-chat-date';
                dateDiv.textContent = msgDate === today ? 'Today' : formatDate(msg.timestamp);
                body.appendChild(dateDiv);
            }

            appendSupportMessage(msg, false);
        });

        // Scroll to bottom
        setTimeout(() => {
            body.scrollTop = body.scrollHeight;
        }, 100);
    }

    function appendSupportMessage(msg, animate = true) {
        // Prevent duplicates
        if (msg.id && document.querySelector(`.msg-bubble[data-id="${msg.id}"]`)) {
            return;
        }

        const body = document.getElementById('support-chat-body');
        const msgDiv = document.createElement('div');

        // Determine message class
        let msgClass = msg.sender_type === 'user' ? 'user' : 'admin';
        if (msg.message_type === 'report') msgClass += ' report';
        if (msg.message_type === 'file') msgClass += ' file';

        // Format time
        const time = new Date(msg.timestamp).toLocaleTimeString([], {
            hour: '2-digit',
            minute: '2-digit'
        });

        // Build message content
        let content = msg.message;

        // Add file attachment if present
        if (msg.file_path) {
            const fileName = msg.file_path.split('/').pop();
            const fileExt = fileName.split('.').pop().toLowerCase();
            const safeUrl = `/support-files/${encodeURIComponent(fileName)}`;
            const downloadUrl = `${safeUrl}?download=1`;
            let fileIcon = 'description';

            if (['png', 'jpg', 'jpeg', 'gif'].includes(fileExt)) {
                content += `<div class="msg-image"><img src="${safeUrl}" alt="Image" onclick="window.open('${safeUrl}', '_blank')"></div>`;
                // (optional) user can still download via long-press / open image, but route supports download=1
            } else {
                if (fileExt === 'pdf') fileIcon = 'picture_as_pdf';

                content += `
                    <div class="msg-file">
                        <a href="${downloadUrl}" download="${fileName}">
                            <i class="material-icons">${fileIcon}</i>
                            <span>${fileName}</span>
                        </a>
                    </div>
                `;
            }
        }

        // Add report download link if report type
        if (msg.message_type === 'report') {
            content += `
                <div class="msg-report">
                    <i class="material-icons">description</i>
                    <a href="${msg.file_path}" target="_blank" download>
                        Download Report
                    </a>
                </div>
            `;
        }

        msgDiv.className = `msg-bubble ${msgClass}`;
        if (msg.id) msgDiv.dataset.id = msg.id;
        
        msgDiv.innerHTML = `
            ${content}
            <span class="msg-time">${time}</span>
        `;

        if (animate) {
            msgDiv.style.animation = 'fadeIn 0.3s ease';
        }

        body.appendChild(msgDiv);

        // Scroll to bottom
        setTimeout(() => {
            body.scrollTop = body.scrollHeight;
        }, 50);
    }

    function showSupportTypingIndicator() {
        const body = document.getElementById('support-chat-body');
        const existingTyping = body.querySelector('.typing-indicator');

        if (existingTyping) {
            body.removeChild(existingTyping);
        }

        const typingDiv = document.createElement('div');
        typingDiv.className = 'typing-indicator';
        typingDiv.innerHTML = `
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
        `;

        body.appendChild(typingDiv);
        body.scrollTop = body.scrollHeight;

        // Auto-remove after 3 seconds
        setTimeout(() => {
            if (typingDiv.parentNode === body) {
                body.removeChild(typingDiv);
            }
        }, 3000);
    }

    function clearSupportTypingIndicator() {
        const body = document.getElementById('support-chat-body');
        const typing = body.querySelector('.typing-indicator');
        if (typing) {
            body.removeChild(typing);
        }
    }

    function handleSupportInputKeypress(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            sendSupportMessage();
        }
    }

    function handleSupportTyping() {
        if (supportTypingTimeout) {
            clearTimeout(supportTypingTimeout);
        }

        // Emit typing start
        socket.emit('support_typing', {
            user_id: currentUserId,
            is_typing: true,
            sender_type: 'user'
        });

        // Emit typing stop after 1 second
        supportTypingTimeout = setTimeout(() => {
            socket.emit('support_typing', {
                user_id: currentUserId,
                is_typing: false,
                sender_type: 'user'
            });
            supportTypingTimeout = null;
        }, 1000);
    }

    function sendSupportMessage() {
        const input = document.getElementById('support-chat-input');
        const message = input.value.trim();

        if (!message) return;

        // Create temporary message for immediate feedback
        const tempMsg = {
            sender_type: 'user',
            message: message,
            timestamp: new Date().toISOString(),
            is_me: true
        };

        appendSupportMessage(tempMsg);
        input.value = '';

        // Send via AJAX (supports file upload)
        const formData = new FormData();
        formData.append('message', message);

        fetch('/api/support/chat/send', {
            method: 'POST',
            body: formData
        })
            .then(r => r.json())
            .then(data => {
                if (!data.success) {
                    console.error('Failed to send message:', data.error);
                    showToast('Failed to send message', 'error');
                }
            })
            .catch(err => {
                console.error('Error sending message:', err);
                showToast('Connection error', 'error');
            });

        // Clear typing indicator
        clearSupportTypingIndicator();
    }

    function openSupportFileInput() {
        document.getElementById('support-file-input').click();
    }

    function handleSupportFileUpload(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            const formData = new FormData();
            formData.append('file', file);
            formData.append('message', `File: ${file.name}`);

            // Show uploading indicator
            showToast('Uploading file...', 'info');

            fetch('/api/support/chat/send', {
                method: 'POST',
                body: formData
            })
                .then(r => r.json())
                .then(data => {
                    if (data.success && data.data) {
                        appendSupportMessage(data.data);
                        showToast('File sent successfully', 'success');
                    } else {
                        showToast('Failed to upload file', 'error');
                    }
                })
                .catch(err => {
                    console.error('File upload error:', err);
                    showToast('Upload failed', 'error');
                });
        }
    }

    function markSupportMessagesRead() {
        // Emit socket event to mark messages as read
        socket.emit('support_mark_read', {
            user_id: currentUserId
        });

        // Update badge
        updateSupportBadge();
    }

    function formatDate(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diff = now - date;
        const days = Math.floor(diff / (1000 * 60 * 60 * 24));

        if (days === 0) return 'Today';
        if (days === 1) return 'Yesterday';
        if (days < 7) return `${days} days ago`;

        return date.toLocaleDateString('en-US', {
            month: 'short',
            day: 'numeric'
        });
    }

    // ============================================
    // UTILITY FUNCTIONS
    // ============================================

    function debugDashboard() {
        console.log('=== DASHBOARD DEBUG ===');
        console.log('Current section:', currentActiveSection);
        console.log('User location:', userLocation);
        console.log('Socket connected:', socket?.connected);
        console.log('Unread notifications:', unreadNotifications);
        console.log('Chatbot open:', chatbotOpen);
        console.log('Support chat open:', supportChatOpen);
    }

    // Profile Upload Handler
    function handleProfileUpload(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];

            // Preview
            const reader = new FileReader();
            reader.onload = function (e) {
                const img = document.getElementById('profile-img-preview');
                if (img) img.src = e.target.result;
            };
            reader.readAsDataURL(file);

            // Upload via AJAX
            const formData = new FormData();
            formData.append('profile_picture', file);

            showToast('Uploading profile picture...', 'info');

            fetch('/upload_profile_picture', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast(data.message, 'success');
                        if (data.image_url) {
                            const img = document.getElementById('profile-img-preview');
                            if (img) img.src = data.image_url;
                        }
                    } else {
                        showToast(data.message || 'Upload failed', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('Upload failed', 'error');
                });
        }
    }
</script>

</body>

</html>