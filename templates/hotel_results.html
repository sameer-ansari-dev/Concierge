<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hotel Results - Concierge Lifestyle</title>
  <!-- Material Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <!-- Fonts -->
  <link
    href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Playfair+Display:wght@400;600;700&family=Inter:wght@400;500;600&display=swap"
    rel="stylesheet">
  <!-- Flatpickr CSS -->
  <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet">
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <!-- Custom CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/hotel_results.css') }}">
  <!-- Flatpickr -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <!-- Socket.IO client -->
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
</head>

<body data-user-id="{{ current_user_id|default('') }}">
  <main class="container">
    <!-- Navigation Header -->
    <nav class="flight-navbar">
      <div class="nav-brand">
        <h2><i class="fas fa-hotel"></i> DriveEase Hotels</h2>
      </div>
      <div class="nav-links">
        <a href="{{ url_for('dashboard') }}" class="nav-link">
          <i class="fas fa-tachometer-alt"></i> Dashboard
        </a>
        <a href="{{ url_for('dashboard') }}#requests-section" class="nav-link active">
          <i class="fas fa-list-alt"></i> My Requests
        </a>
      </div>
    </nav>

    <div class="page-title">
      <h1>Luxury Hotel Collection</h1>
      <p>Discover premium accommodations tailored for your comfort</p>
    </div>

    <!-- Success Alert (will be shown dynamically) -->
    <div id="successAlert" class="alert alert-success alert-dismissible fade show" style="display: none;">
      <strong>‚úì Booking submitted!</strong> <span id="successMessage"></span>
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <div class="search-summary">
      <div class="search-info">
        <div class="search-item">
          <i class="material-icons">location_on</i>
          <span id="summary-destination">{{ destination|default('Mumbai')|escape }}</span>
        </div>
        <div class="search-item">
          <i class="material-icons">calendar_today</i>
          <span id="summary-checkin">{{ checkin|default('')|escape }}</span> - <span id="summary-checkout">{{
            checkout|default('')|escape }}</span>
        </div>
        <div class="search-item">
          <i class="material-icons">hotel</i>
          <span id="summary-rooms">{{ rooms|default(1)|escape }} Room(s)</span>
        </div>
        <div class="search-item">
          <i class="material-icons">people</i>
          <span id="summary-guests">{{ guests|default(1)|escape }} Guest(s)</span>
        </div>
        <div>
          <button class="btn btn-outline-primary modify-search-btn" onclick="toggleModifyPanel()">Modify Search</button>
        </div>
      </div>
    </div>

    {% if message %}
    <div class="alert alert-danger" role="alert">
      {{ message|escape }}
    </div>
    {% endif %}

    <!-- Modify Search Panel (Right Side) -->
    <div class="overlay" id="overlay" onclick="toggleModifyPanel()"></div>
    <div class="modify-search-panel-right" id="modifyPanel">
      <div class="panel-title">
        <h2>Modify Your Search</h2>
        <span class="close-search" onclick="toggleModifyPanel()">&times;</span>
      </div>
      <div class="modify-form-wrapper">
        <form method="POST" action="/submit-hotel-booking" onsubmit="validateCity(event)" id="searchForm">
          <div class="form-group">
            <label class="form-label" for="destination">Destination</label>
            <div class="input-with-icon">
              <i class="fas fa-map-marker-alt"></i>
              <input type="text" class="form-control" name="destination" id="destination"
                value="{{ destination|default('Mumbai')|escape }}" placeholder="Enter City Name" required
                autocomplete="off" oninput="showSuggestions(this.value)">
            </div>
            <div id="suggestions" class="suggestions-box">
              <div class="suggestion" onclick="selectCity('Mumbai')">Mumbai</div>
              <div class="suggestion" onclick="selectCity('Pune')">Pune</div>
              <div class="suggestion" onclick="selectCity('Nashik')">Nashik</div>
            </div>
            <p id="city-error" class="error-message text-danger"></p>
          </div>

          <div class="form-grid">
            <div class="form-group">
              <label class="form-label" for="checkin">Check-in Date</label>
              <div class="input-with-icon">
                <i class="fas fa-calendar-plus"></i>
                <input type="text" class="form-control" name="checkin" id="checkin"
                  value="{{ checkin|default('')|escape }}" placeholder="Select Date" required autocomplete="off">
              </div>
            </div>
            <div class="form-group">
              <label class="form-label" for="checkout">Check-out Date</label>
              <div class="input-with-icon">
                <i class="fas fa-calendar-minus"></i>
                <input type="text" class="form-control" name="checkout" id="checkout"
                  value="{{ checkout|default('')|escape }}" placeholder="Select Date" required autocomplete="off">
              </div>
            </div>
          </div>

          <div class="form-grid">
            <div class="form-group">
              <label class="form-label" for="roomCount">Rooms</label>
              <div class="input-with-icon">
                <i class="fas fa-bed"></i>
                <div class="input-group">
                  <button type="button" class="btn btn-outline-primary" onclick="updateCount('room', -1)">‚àí</button>
                  <input type="number" class="form-control" id="roomCount" name="rooms"
                    value="{{ rooms|default(1)|escape }}" min="1" max="15" readonly>
                  <button type="button" class="btn btn-outline-primary" onclick="updateCount('room', 1)">+</button>
                </div>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label" for="guestCount">Guests</label>
              <div class="input-with-icon">
                <i class="fas fa-user-friends"></i>
                <div class="input-group">
                  <button type="button" class="btn btn-outline-primary" onclick="updateCount('guest', -1)">‚àí</button>
                  <input type="number" class="form-control" id="guestCount" name="guests"
                    value="{{ guests|default(1)|escape }}" min="1" max="16" readonly>
                  <button type="button" class="btn btn-outline-primary" onclick="updateCount('guest', 1)">+</button>
                </div>
              </div>
            </div>
          </div>

          <div class="apply-btn">
            <button type="submit" class="btn-primary search-flights-btn">
              <i class="fas fa-search"></i> Search Hotels
            </button>
          </div>
        </form>
      </div>
    </div>

    {% if hotels %}
    <div class="results-header"></div>
    <div class="hotel-list row g-4">
      {% for hotel in hotels %}
      <div class="col-12 col-md-6 col-lg-4">
        <div class="card hotel-card" data-rating="{{ hotel.rating|default(0) }}"
          data-price="{{ hotel.price|default(0) }}" data-wifi="{{ hotel.free_wifi|default(false) }}"
          data-couple="{{ hotel.couple_friendly|default(false) }}">
          <img src="{{ url_for('static', filename=hotel.image|default('images/default-hotel.jpg')) }}"
            alt="{{ hotel.name|default('Unknown Hotel')|escape }}" class="card-img-top hotel-image" loading="lazy">
          <div class="card-body hotel-info">
            <h2 class="card-title hotel-name">{{ hotel.name|default('Unknown Hotel')|escape }}</h2>
            <div class="hotel-rating">
              {% if hotel.rating is not none %}
              {% for i in range(hotel.rating|round(0, 'floor')|int) %}‚≠ê{% endfor %}
              {{ hotel.rating }}
              <div class="progress-bar" data-width="{{ hotel.rating * 20 }}"></div>
              {% else %}
              ‚≠ê 0
              <div class="progress-bar" data-width="0"></div>
              {% endif %}
            </div>
            <div class="hotel-location">
              <i class="material-icons">location_on</i>
              {{ hotel.address|default('Unknown Address')|escape }}
            </div>
            <div class="hotel-tags">
              {% if hotel.free_wifi %}<span class="tag">Free WiFi</span>{% endif %}
              {% if hotel.couple_friendly %}<span class="tag">Couple Friendly</span>{% endif %}
              {% if hotel.pool %}<span class="tag">Pool</span>{% endif %}
              {% if hotel.gym %}<span class="tag">Gym</span>{% endif %}
              {% if hotel.spa %}<span class="tag">Spa</span>{% endif %}
            </div>
            <div class="hotel-details" style="display: none;">
              <p><strong>Amenities:</strong> Pool, Gym, Spa, Restaurant, Bar</p>
              <p><strong>Cancellation:</strong> Free up to 48 hrs</p>
              <p><strong>Check-in:</strong> 2:00 PM | <strong>Check-out:</strong> 12:00 PM</p>
            </div>
            <button class="btn btn-outline-primary details-btn" onclick="toggleDetailsForButton(this)">More
              Details</button>
            <div class="hotel-pricing">
              <div class="price-container">
                <span class="discounted-price">‚Çπ{{ hotel.price|default(0) }}</span>
                <span class="per-night">per night</span>
                <span class="original-price">‚Çπ{{ (hotel.price * 1.2)|round|int }}</span>
              </div>
              <button class="btn btn-primary book-btn"
                data-hotel-name="{{ hotel.name|default('Unknown Hotel')|escape }}"
                data-price="{{ hotel.price|default(0) }}" data-rooms="{{ rooms|default(1) }}"
                data-guests="{{ guests|default(1) }}" data-checkin="{{ checkin|default('') }}"
                data-checkout="{{ checkout|default('') }}" onclick="showBookingModalForButton(this)">
                <i class="fas fa-calendar-check"></i> Book Now
              </button>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <div class="no-hotels">
      <p>üö´ No hotels found matching your criteria</p>
      <button class="btn btn-outline-primary modify-search-btn" onclick="toggleModifyPanel()">Modify Search
        Parameters</button>
    </div>
    {% endif %}

    <!-- Booking Modal -->
    <div class="modal fade" id="booking-modal" tabindex="-1" aria-labelledby="bookingModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="bookingModalLabel">
              <i class="fas fa-hotel"></i> Hotel Booking Details
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <!-- Hotel Summary -->
            <div class="booking-summary" id="hotelSummary">
              <h6>Hotel Summary</h6>
              <div class="summary-item">
                <span>Hotel:</span>
                <span id="booking-hotel-name">-</span>
              </div>
              <div class="summary-item">
                <span>Price per night:</span>
                <span id="booking-hotel-price">-</span>
              </div>
              <div class="summary-item">
                <span>Rooms:</span>
                <span id="booking-rooms">-</span>
              </div>
            </div>

            <!-- Guest Details -->
            <h6 class="section-title">
              <i class="fas fa-users"></i> Guest Details
              <span class="badge bg-primary" id="guestCount">0 guests</span>
            </h6>
            <div id="guest-details-section" class="guest-form-container"></div>

            <hr>

            <!-- Contact Details -->
            <h6><i class="fas fa-address-card"></i> Contact Details</h6>
            <div class="row g-3">
              <div class="col-12 col-md-6">
                <label class="form-label">Email Address *</label>
                <input type="email" class="form-control" id="email" value="{{ current_user.email|default('') }}"
                  placeholder="your.email@example.com" required>
                <div class="form-text">Booking confirmation will be sent to this email</div>
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label">Mobile Number *</label>
                <input type="tel" class="form-control" id="mobile" value="{{ current_user.mobile|default('') }}"
                  placeholder="9876543210" pattern="[0-9]{10}" title="10-digit phone number" required>
                <div class="form-text">For booking updates and notifications</div>
              </div>
            </div>

            <hr>

            <!-- Check-in/Check-out Dates -->
            <h6><i class="fas fa-calendar-alt"></i> Stay Dates</h6>
            <div class="row g-3">
              <div class="col-12 col-md-6">
                <label class="form-label">Check-in Date *</label>
                <input type="text" class="form-control date-input" id="booking-checkin"
                  value="{{ checkin|default('')|escape }}" required>
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label">Check-out Date *</label>
                <input type="text" class="form-control date-input" id="booking-checkout"
                  value="{{ checkout|default('')|escape }}" required>
              </div>
            </div>

            <!-- Price Details -->
            <div id="price-details-section" class="mt-4"></div>

            <!-- Special Requests -->
            <div class="special-requests mt-4">
              <label class="form-label">Special Requests (Optional)</label>
              <textarea class="form-control" id="special_requests" rows="2"
                placeholder="e.g., Late check-in, extra bed, dietary requirements, etc."></textarea>
            </div>
          </div>

          <!-- Terms & Conditions Section -->
          <div class="modal-terms-section">
            <div class="form-check">
              <input type="checkbox" class="form-check-input" id="terms-checkbox" required>
              <label class="form-check-label" for="terms-checkbox">
                I agree to the
                <a href="javascript:void(0)" onclick="showTermsModal()" class="terms-link">Terms & Conditions</a>
                and understand this is a simulated booking. I confirm that all information provided is accurate.
              </label>
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              <i class="fas fa-times"></i> Cancel
            </button>
            <button type="button" class="btn btn-success" id="continue-booking-btn" onclick="confirmBooking()" disabled>
              <i class="fas fa-check-circle"></i> Continue to Payment
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal fade" id="confirm-modal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="confirmModalLabel">
              <i class="fas fa-hotel"></i> Confirm Hotel Booking
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="booking-summary">
              <h6>Booking Summary</h6>
              <div class="summary-item">
                <span>Hotel:</span>
                <span id="confirm-hotel-name"></span>
              </div>
              <div class="summary-item">
                <span>Stay Duration:</span>
                <span id="confirm-stay-duration"></span>
              </div>
              <div class="summary-item">
                <span>Rooms:</span>
                <span id="confirm-rooms"></span>
              </div>
              <div class="summary-item">
                <span>Guests:</span>
                <span id="confirm-guests"></span>
              </div>
              <div class="summary-item">
                <span>Check-in:</span>
                <span id="confirm-checkin"></span>
              </div>
              <div class="summary-item">
                <span>Check-out:</span>
                <span id="confirm-checkout"></span>
              </div>
              <div class="summary-item total">
                <span>Total Amount:</span>
                <span id="confirm-hotel-price"></span>
              </div>
            </div>
            <div class="alert alert-info mt-3">
              <i class="fas fa-info-circle"></i>
              <small>This is a simulated booking. No real payment will be processed.
                You will receive a booking confirmation with a unique Booking ID.</small>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              <i class="fas fa-arrow-left"></i> Go Back
            </button>
            <button type="button" class="btn btn-success" onclick="initiatePayment()">
              <i class="fas fa-credit-card"></i> Confirm & Get Booking ID
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Terms & Conditions Modal -->
    <div class="modal fade" id="terms-modal" tabindex="-1" aria-labelledby="termsModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="termsModalLabel">
              <i class="fas fa-file-contract"></i> Hotel Booking Terms & Conditions
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="terms-content">
              <div class="alert alert-warning">
                <i class="fas fa-exclamation-circle"></i>
                <strong>Important:</strong> This is a demonstration booking system. No real payments are processed and
                no
                actual hotel reservations are made.
              </div>

              <h6>1. Simulated Booking System</h6>
              <p>This platform is for demonstration purposes only. All bookings, payments, and confirmations are
                simulated
                and do not result in actual hotel reservations.</p>

              <h6>2. Booking Process</h6>
              <p>Hotel bookings are subject to admin approval. You will receive a simulated confirmation once your
                booking is processed in the system.</p>

              <h6>3. Cancellation & Refund Policy</h6>
              <p>Free cancellation up to 48 hours before check-in. Late cancellations may be subject to charges as per
                hotel policies.</p>

              <h6>4. Check-in & Check-out Procedures</h6>
              <p>‚Ä¢ Standard check-in time: 2:00 PM<br>
                ‚Ä¢ Standard check-out time: 12:00 PM<br>
                ‚Ä¢ Early check-in and late check-out are subject to availability and additional charges<br>
                ‚Ä¢ Photo ID is mandatory for all guests</p>

              <h6>5. Guest Responsibility</h6>
              <p>Guests are responsible for providing accurate information, adhering to hotel policies, and respecting
                property rules.</p>

              <h6>6. Privacy & Data Protection</h6>
              <p>Your personal information is protected and will not be shared with third parties. All data is stored
                securely in accordance with privacy regulations.</p>

              <h6>7. Changes & Disruptions</h6>
              <p>In case of booking cancellations or changes by the hotel, guests will be notified via email/SMS and
                alternative arrangements will be made.</p>

              <div class="text-center mt-4">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
                  <i class="fas fa-check"></i> I Understand & Accept
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer class="container">
    <p>¬© 2023 DriveEase Hotels. All rights reserved.</p>
  </footer>

  <script>
    // ===== Global Variables =====
    let currentHotel = null;
    let currentPrice = null;
    let currentRooms = 1;
    let currentGuests = 1;
    let currentCheckin = null;
    let currentCheckout = null;
    let bookingId = null;

    // ===== Toast Notification =====
    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.style.cssText = `position:fixed;bottom:20px;right:20px;z-index:10000;background:${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#007bff'};color:white;padding:12px 20px;border-radius:8px;font-size:14px;box-shadow:0 4px 12px rgba(0,0,0,0.3);opacity:0;transition:opacity .3s`;
      toast.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i> ${message}`;
      document.body.appendChild(toast);
      setTimeout(() => toast.style.opacity = '1', 100);
      setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
      }, 4000);
    }

    // ===== Success Alert Function =====
    function showSuccessAlert(message) {
      const alertDiv = document.createElement('div');
      alertDiv.className = 'alert alert-success alert-dismissible fade show';
      alertDiv.style.cssText = `
        position: fixed;
        top: 100px;
        right: 20px;
        z-index: 1050;
        min-width: 350px;
        max-width: 500px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        border: none;
        border-left: 4px solid #28a745;
        animation: slideInRight 0.3s ease;
      `;

      // Extract booking ID from message
      const bookingIdMatch = message.match(/Booking ID: ([A-Z0-9\-]+)/);
      const bookingId = bookingIdMatch ? bookingIdMatch[1] : 'HOTEL-' + Math.floor(Math.random() * 1000000000);

      alertDiv.innerHTML = `
        <div class="d-flex align-items-start">
          <i class="fas fa-check-circle me-3" style="font-size: 1.2rem; margin-top: 2px;"></i>
          <div class="flex-grow-1">
            <strong>‚úì Booking submitted!</strong> Your hotel booking has been confirmed! Booking ID: ${bookingId}. You can track it in your dashboard.
            <div class="mt-2">
              <button class="btn btn-sm btn-outline-success me-2" onclick="copyToClipboard('${bookingId}')">
                <i class="fas fa-copy"></i> Copy Booking ID
              </button>
              <a href="/dashboard" class="btn btn-sm btn-success">
                <i class="fas fa-tachometer-alt"></i> Go to Dashboard
              </a>
            </div>
          </div>
          <button type="button" class="btn-close ms-3" onclick="this.parentElement.parentElement.remove()"></button>
        </div>
      `;

      document.body.appendChild(alertDiv);

      // Auto remove after 10 seconds
      setTimeout(() => {
        if (alertDiv.parentElement) {
          alertDiv.remove();
        }
      }, 10000);
    }

    // ===== Copy to Clipboard =====
    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        showToast('Booking ID copied to clipboard!', 'success');
      }).catch(err => {
        console.error('Failed to copy:', err);
        showToast('Failed to copy Booking ID', 'error');
      });
    }

    // ===== Modify Panel Functions =====
    function toggleModifyPanel() {
      const panel = document.getElementById("modifyPanel");
      const overlay = document.getElementById("overlay");

      if (panel) {
        panel.classList.toggle("active");
        document.body.classList.toggle("modify-search-open", panel.classList.contains("active"));

        if (overlay) {
          overlay.classList.toggle("active", panel.classList.contains("active"));
        }
      }
    }

    // ===== Initialize Date Pickers =====
    let checkoutPicker, checkinPicker;

    function initializeDatePickers() {
      checkoutPicker = flatpickr("#checkout, #booking-checkout", {
        altInput: true,
        altFormat: "F j, Y",
        dateFormat: "Y-m-d",
        minDate: new Date().fp_incr(1),
        onChange: updateSearchSummary
      });

      checkinPicker = flatpickr("#checkin, #booking-checkin", {
        altInput: true,
        altFormat: "F j, Y",
        dateFormat: "Y-m-d",
        minDate: "today",
        onChange: function (selectedDates) {
          if (selectedDates[0]) {
            checkoutPicker.set("minDate", new Date(selectedDates[0].getTime() + 86400000));
          }
          updateSearchSummary();
        }
      });
    }

    // ===== Search Summary Functions =====
    function updateCount(field, change) {
      const input = document.getElementById(field === 'room' ? 'roomCount' : 'guestCount');
      let current = parseInt(input.value);
      const min = parseInt(input.min);
      const max = parseInt(input.max);
      current += change;
      if (current >= min && current <= max) {
        input.value = current;
        updateSearchSummary();
      }
    }

    function updateSearchSummary() {
      const roomCount = document.getElementById('roomCount').value;
      const guestCount = document.getElementById('guestCount').value;
      const destination = document.getElementById('destination').value;
      const checkin = document.getElementById('checkin').value;
      const checkout = document.getElementById('checkout').value;

      if (document.getElementById('summary-rooms')) {
        document.getElementById('summary-rooms').textContent = `${roomCount} Room(s)`;
      }
      if (document.getElementById('summary-guests')) {
        document.getElementById('summary-guests').textContent = `${guestCount} Guest(s)`;
      }
      if (document.getElementById('summary-destination')) {
        document.getElementById('summary-destination').textContent = destination || "{{ destination|default('Mumbai') }}";
      }
      if (document.getElementById('summary-checkin')) {
        document.getElementById('summary-checkin').textContent = checkin || "{{ checkin|default('') }}";
      }
      if (document.getElementById('summary-checkout')) {
        document.getElementById('summary-checkout').textContent = checkout || "{{ checkout|default('') }}";
      }
    }

    // ===== City Validation =====
    const allowedCities = ["mumbai", "pune", "nashik"];

    function showSuggestions(value) {
      const suggestionsBox = document.getElementById("suggestions");
      const cityError = document.getElementById("city-error");
      const input = value.toLowerCase().trim();
      if (input === "") {
        if (suggestionsBox) suggestionsBox.style.display = "none";
        if (cityError) cityError.textContent = "";
        return;
      }
      if (allowedCities.some(city => city.startsWith(input))) {
        if (suggestionsBox) suggestionsBox.style.display = "block";
        if (cityError) cityError.textContent = "";
      } else {
        if (suggestionsBox) suggestionsBox.style.display = "none";
      }
    }

    function selectCity(city) {
      document.getElementById("destination").value = city;
      document.getElementById("suggestions").style.display = "none";
      document.getElementById("city-error").textContent = "";
      updateSearchSummary();
    }

    function validateCity(event) {
      const destination = document.getElementById("destination").value.toLowerCase().trim();
      const error = document.getElementById("city-error");
      if (!allowedCities.includes(destination)) {
        event.preventDefault();
        if (["delhi", "agra", "bangalore", "hyderabad", "singapore", "dubai", "jaipur"].includes(destination)) {
          error.textContent = "üîß Coming soon in this city!";
        } else {
          error.textContent = "‚ùó Please enter correct city name: Mumbai, Pune or Nashik.";
        }
      } else {
        error.textContent = "";
      }
    }

    // ===== Details Toggle =====
    function toggleDetails(btn) {
      const details = btn.parentElement.querySelector('.hotel-details');
      if (details.style.display === "none") {
        details.style.display = "block";
        btn.textContent = "Hide Details";
        btn.classList.add('active');
      } else {
        details.style.display = "none";
        btn.textContent = "More Details";
        btn.classList.remove('active');
      }
    }

    function toggleDetailsForButton(btn) {
      toggleDetails(btn);
    }

    // ===== Booking Modal Functions =====
    function showBookingModal(hotelName, price, rooms, guests, checkin, checkout) {
      try {
        currentHotel = hotelName || 'Unknown Hotel';
        currentPrice = parseFloat(price) || 0;
        currentRooms = parseInt(rooms) || 1;
        currentGuests = parseInt(guests) || 1;
        currentCheckin = checkin || document.getElementById('checkin')?.value || '';
        currentCheckout = checkout || document.getElementById('checkout')?.value || '';

        if (!currentHotel.trim() || isNaN(currentPrice) || currentPrice <= 0) {
          throw new Error(`Invalid hotel name (${currentHotel}) or price (${currentPrice})`);
        }

        // Update modal title
        const modalTitle = document.getElementById('bookingModalLabel');
        if (modalTitle) {
          modalTitle.innerHTML = `<i class="fas fa-hotel"></i> ${currentHotel} - Booking Details`;
        }

        // Update hotel summary
        document.getElementById('booking-hotel-name').textContent = currentHotel;
        document.getElementById('booking-hotel-price').textContent = `‚Çπ${currentPrice.toFixed(2)} per night`;
        document.getElementById('booking-rooms').textContent = `${currentRooms} room(s)`;

        // Set dates
        const bookingCheckin = document.getElementById('booking-checkin');
        const bookingCheckout = document.getElementById('booking-checkout');
        if (bookingCheckin) bookingCheckin.value = currentCheckin;
        if (bookingCheckout) bookingCheckout.value = currentCheckout;

        // Update guest count badge
        document.getElementById('guestCount').textContent = `${currentGuests} guest(s)`;

        // Generate forms and pricing
        generateGuestFields();
        generatePriceDetails();
        updateContinueButton();

        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('booking-modal'));
        modal.show();

      } catch (error) {
        console.error('Error opening booking modal:', error);
        showToast('Unable to open booking modal. Please try again.', 'error');
      }
    }

    function showBookingModalForButton(btn) {
      try {
        const name = btn.dataset.hotelName || 'Unknown Hotel';
        let price = btn.dataset.price;
        price = parseFloat(price);
        if (isNaN(price)) price = 5000;

        const rooms = parseInt(btn.dataset.rooms) || parseInt(document.getElementById('roomCount')?.value) || 1;
        const guests = parseInt(btn.dataset.guests) || parseInt(document.getElementById('guestCount')?.value) || 1;
        const checkin = btn.dataset.checkin || document.getElementById('checkin')?.value || '';
        const checkout = btn.dataset.checkout || document.getElementById('checkout')?.value || '';

        showBookingModal(name, price, rooms, guests, checkin, checkout);
      } catch (error) {
        console.error('Error in showBookingModalForButton:', error);
        showToast('Error: Unable to open booking modal.', 'error');
      }
    }

    // ===== Guest Fields Generation =====
    function generateGuestFields() {
      try {
        const guestSection = document.getElementById('guest-details-section');
        if (!guestSection) return;

        guestSection.innerHTML = '';

        const roomCount = currentRooms || parseInt(document.getElementById('roomCount')?.value) || 1;
        const guestCount = currentGuests || parseInt(document.getElementById('guestCount')?.value) || 1;

        const guestsPerRoom = Math.ceil(guestCount / roomCount);
        let guestIndex = 1;

        for (let room = 1; room <= roomCount; room++) {
          const roomDiv = document.createElement('div');
          roomDiv.className = 'guest-form-section';
          roomDiv.innerHTML = `<h6 class="text-primary">Room ${room} - Guest Details</h6>`;

          const roomGuests = Math.min(guestsPerRoom, guestCount - guestIndex + 1);
          for (let g = 1; g <= roomGuests; g++) {
            roomDiv.innerHTML += `
              <div class="row g-3 mb-3">
                <div class="col-12">
                  <h6>Guest ${g}</h6>
                </div>
                <div class="col-12 col-md-3">
                  <label class="form-label">Type</label>
                  <select class="form-control" id="type-${room}-${g}" onchange="updateTitleOptions(${room}, ${g})">
                    <option value="Adult">Adult</option>
                    <option value="Child">Child</option>
                  </select>
                </div>
                <div class="col-12 col-md-3">
                  <label class="form-label">Title</label>
                  <select class="form-control" id="title-${room}-${g}">
                    <option value="Mr.">Mr.</option>
                    <option value="Mrs.">Mrs.</option>
                    <option value="Miss">Miss</option>
                  </select>
                </div>
                <div class="col-12 col-md-6">
                  <label class="form-label">Full Name *</label>
                  <input type="text" class="form-control" id="full-name-${room}-${g}" placeholder="Full Name" required>
                </div>
              </div>
            `;
            guestIndex++;
          }
          guestSection.appendChild(roomDiv);
        }
      } catch (error) {
        console.error('Error generating guest fields:', error);
        showToast('Error: Unable to generate guest fields.', 'error');
      }
    }

    function updateTitleOptions(room, guest) {
      try {
        const typeSelect = document.getElementById(`type-${room}-${guest}`);
        const titleSelect = document.getElementById(`title-${room}-${guest}`);
        if (!typeSelect || !titleSelect) return;

        const isChild = typeSelect.value === 'Child';
        titleSelect.innerHTML = isChild
          ? '<option value="Master">Master</option><option value="Miss">Miss</option>'
          : '<option value="Mr.">Mr.</option><option value="Mrs.">Mrs.</option><option value="Miss">Miss</option>';
      } catch (error) {
        console.error('Error updating title options:', error);
      }
    }

    // ===== Price Calculation =====
    function generatePriceDetails() {
      try {
        const priceSection = document.getElementById('price-details-section');
        if (!priceSection) return;

        const price = currentPrice || 5000;
        const roomCount = currentRooms || parseInt(document.getElementById('roomCount')?.value) || 1;
        const checkin = document.getElementById('booking-checkin')?.value || currentCheckin || '';
        const checkout = document.getElementById('booking-checkout')?.value || currentCheckout || '';
        const nights = calculateNights(checkin, checkout);

        const basePrice = price * roomCount * nights;
        const discount = basePrice * 0.1;
        const priceAfterDiscount = basePrice - discount;
        const taxes = priceAfterDiscount * 0.18;
        const grandTotal = priceAfterDiscount + taxes;

        priceSection.innerHTML = `
          <div class="price-breakdown">
            <h6>Price Breakdown</h6>
            <div class="price-row">
              <span>${roomCount} Room${roomCount > 1 ? 's' : ''} √ó ${nights} Night${nights > 1 ? 's' : ''} @ ‚Çπ${price}/night</span>
              <span>‚Çπ${basePrice.toFixed(2)}</span>
            </div>
            <div class="price-row discount">
              <span>Special Discount (10%)</span>
              <span>-‚Çπ${discount.toFixed(2)}</span>
            </div>
            <div class="price-row">
              <span>Price After Discount</span>
              <span>‚Çπ${priceAfterDiscount.toFixed(2)}</span>
            </div>
            <div class="price-row">
              <span>Taxes & Service Fees (18%)</span>
              <span>‚Çπ${taxes.toFixed(2)}</span>
            </div>
            <div class="price-row grand-total">
              <span><strong>Grand Total</strong></span>
              <span><strong>‚Çπ${grandTotal.toFixed(2)}</strong></span>
            </div>
          </div>`;
      } catch (error) {
        console.error('Error generating price details:', error);
        const priceSection = document.getElementById('price-details-section');
        if (priceSection) priceSection.innerHTML = '<p class="text-danger">Error: Unable to calculate price.</p>';
      }
    }

    function calculateNights(checkin, checkout) {
      try {
        if (!checkin || !checkout) return 1;
        const checkinDate = new Date(checkin);
        const checkoutDate = new Date(checkout);
        if (isNaN(checkinDate) || isNaN(checkoutDate)) return 1;
        const diff = (checkoutDate - checkinDate) / (1000 * 60 * 60 * 24);
        return Math.max(1, Math.round(diff));
      } catch {
        return 1;
      }
    }

    // ===== Continue Button Update =====
    function updateContinueButton() {
      const termsCheckbox = document.getElementById('terms-checkbox');
      const continueBtn = document.getElementById('continue-booking-btn');

      if (continueBtn) {
        continueBtn.disabled = !termsCheckbox?.checked;
      }
    }

    // ===== Validation Functions =====
    function validateGuestDetails() {
      let isValid = true;

      // Validate all guest fields
      for (let room = 1; room <= currentRooms; room++) {
        for (let guest = 1; guest <= Math.ceil(currentGuests / currentRooms); guest++) {
          const fullName = document.getElementById(`full-name-${room}-${guest}`);
          if (fullName && !fullName.value.trim()) {
            fullName.classList.add('is-invalid');
            isValid = false;
          } else if (fullName) {
            fullName.classList.remove('is-invalid');
          }
        }
      }

      // Validate contact details
      const emailInput = document.getElementById('email');
      const mobileInput = document.getElementById('mobile');
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      const mobileRegex = /^[0-9]{10}$/;

      if (!emailRegex.test(emailInput.value.trim())) {
        emailInput.classList.add('is-invalid');
        isValid = false;
      } else {
        emailInput.classList.remove('is-invalid');
      }

      if (!mobileRegex.test(mobileInput.value.trim())) {
        mobileInput.classList.add('is-invalid');
        isValid = false;
      } else {
        mobileInput.classList.remove('is-invalid');
      }

      return isValid;
    }

    // ===== Confirm Booking =====
    function confirmBooking() {
      try {
        // Validate terms acceptance
        if (!document.getElementById('terms-checkbox').checked) {
          showToast('Please accept Terms & Conditions', 'error');
          return;
        }

        // Validate all fields
        if (!validateGuestDetails()) {
          showToast('Please fill all required fields correctly', 'error');
          return;
        }

        // Calculate final price
        const totalAmount = calculateTotalPrice();
        const checkin = document.getElementById('booking-checkin').value || '';
        const checkout = document.getElementById('booking-checkout').value || '';
        const nights = calculateNights(checkin, checkout);

        // Update confirmation modal
        document.getElementById('confirm-hotel-name').textContent = currentHotel;
        document.getElementById('confirm-stay-duration').textContent = `${nights} night(s)`;
        document.getElementById('confirm-rooms').textContent = `${currentRooms} room(s)`;
        document.getElementById('confirm-guests').textContent = `${currentGuests} guest(s)`;
        document.getElementById('confirm-checkin').textContent = checkin;
        document.getElementById('confirm-checkout').textContent = checkout;
        document.getElementById('confirm-hotel-price').textContent = `‚Çπ${totalAmount.toFixed(2)}`;

        // Close booking modal and show confirmation
        const bookingModal = bootstrap.Modal.getInstance(document.getElementById('booking-modal'));
        bookingModal.hide();

        const confirmModal = new bootstrap.Modal(document.getElementById('confirm-modal'));
        confirmModal.show();

      } catch (error) {
        console.error('Error confirming booking:', error);
        showToast('Error processing booking confirmation.', 'error');
      }
    }

    function calculateTotalPrice() {
      try {
        const roomCount = currentRooms || parseInt(document.getElementById('roomCount')?.value) || 1;
        const checkin = document.getElementById('booking-checkin')?.value || currentCheckin || '';
        const checkout = document.getElementById('booking-checkout')?.value || currentCheckout || '';
        const nights = calculateNights(checkin, checkout);
        const price = currentPrice || 5000;
        const basePrice = price * roomCount * nights;
        const discount = basePrice * 0.1;
        const priceAfterDiscount = basePrice - discount;
        const taxes = priceAfterDiscount * 0.18;
        return priceAfterDiscount + taxes;
      } catch {
        return 0;
      }
    }

    // ===== Generate Booking ID =====
    function generateBookingId() {
      const prefix = 'HOTEL';
      const timestamp = Date.now().toString().slice(-6);
      const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
      return `${prefix}-${timestamp}-${random}`;
    }

    // ===== Payment & Booking Submission =====
    async function initiatePayment() {
      try {
        // Generate booking ID
        bookingId = generateBookingId();

        // Show loading
        showToast('Processing your booking...', 'info');

        // Close confirmation modal
        const confirmModal = bootstrap.Modal.getInstance(document.getElementById('confirm-modal'));
        confirmModal.hide();

        // Prepare booking data
        const bookingData = {
          hotel: currentHotel,
          amount: calculateTotalPrice(),
          rooms: currentRooms,
          guests: currentGuests,
          checkin: currentCheckin,
          checkout: currentCheckout,
          email: document.getElementById('email').value,
          mobile: document.getElementById('mobile').value,
          special_requests: document.getElementById('special_requests').value,
          booking_id: bookingId
        };


        const response = await fetch('/confirm-booking', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(bookingData),
        });

        const data = await response.json();

        if (data.success) {
          // Show success alert
          showSuccessAlert(`Your hotel booking has been confirmed! Booking ID: ${data.booking_id}. You can track it in your dashboard.`);

          // Close all modals
          const modals = document.querySelectorAll('.modal');
          modals.forEach(modal => {
            const bsModal = bootstrap.Modal.getInstance(modal);
            if (bsModal) bsModal.hide();
          });

          // Reset form state
          document.getElementById('terms-checkbox').checked = false;
          updateContinueButton();
        } else {
          showToast(data.error || 'Booking failed on server.', 'error');
        }

      } catch (error) {
        console.error('Error processing payment:', error);
        showToast('Error processing booking. Please try again.', 'error');
      }
    }

    // ===== Terms Modal =====
    function showTermsModal() {
      const termsModal = new bootstrap.Modal(document.getElementById('terms-modal'));
      termsModal.show();
    }

    // ===== DOMContentLoaded =====
    document.addEventListener('DOMContentLoaded', function () {
      try {
        // Initialize date pickers
        initializeDatePickers();

        // Update search summary
        updateSearchSummary();

        // Initialize progress bars
        document.querySelectorAll('.progress-bar').forEach(bar => {
          const width = bar.dataset.width;
          if (width) {
            bar.style.width = width + '%';
          }
        });

        // Add event listeners
        const termsCheckbox = document.getElementById('terms-checkbox');
        if (termsCheckbox) {
          termsCheckbox.addEventListener('change', updateContinueButton);
        }

        console.log('Hotel results page initialized successfully');
      } catch (error) {
        console.error('Error initializing page:', error);
        showToast('Error: Page initialization failed.', 'error');
      }
    });

    // ===== Socket.IO Integration =====
    const USER_ID = document.body.getAttribute('data-user-id');
    if (USER_ID && typeof io !== 'undefined') {
      const socket = io();

      socket.on('connect', () => {
        socket.emit('join', { user_id: USER_ID });
      });

      socket.on('hotel_booking_approved', (payload) => {
        if (payload?.booking_id === bookingId) {
          showToast('Hotel booking approved by admin!', 'success');
        }
      });

      socket.on('error', (error) => {
        console.error('Socket error:', error);
        showToast('Connection error occurred.', 'error');
      });
    }
  </script>
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"></script>
</body>

</html>